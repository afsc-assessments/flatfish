---
title: "Model evaluation for Plan Team consideration for the Yellowfin Sole Stock in the Bering Sea and Aleutian Islands"
author: "Ingrid Spies and James Ianelli"
date: "9/9/2020"
output:
  beamer_presentation: 
    colortheme: dove
    fonttheme: serif
  pdf_document: 
    keep_tex: yes
theme: default
---

---
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \useinnertheme{circles}
- \useinnertheme{circles}
- \titlegraphic{\includegraphics[width=6cm]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/YFS_image.png}}
---

---

```{r global_options, include=FALSE,message=FALSE}
library(here)
library(here)
library(adnuts)
library(ggplot2)
library(RColorBrewer)
library(doBy)
library(tidyr)
library(dplyr)
library(gridExtra)
library(tidyverse)
library(purrr)
library(stringr)
library(ggplot2)
library(knitr)
library(kableExtra)
options(knitr.kable.NA = '')
knitr::opts_knit$set(root.dir = '../../' )
library(captioner)
library(bibtex)
library(knitcitations)
library(cowplot)
library(magick)
library(bookdown)
library(ggthemes)
library(scales)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
require(knitr)
library(scales)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(ggmap)
library(widyr)
library(scales)
#install.packages("formattable")
#install.packages("formattable")
library(flextable)
library(officer)
library(ggthemes)

require(kfigr) # devtools::install_github("github mkoohafkan/kfigr")
opts_chunk$set(message=FALSE, warning=FALSE)

table_nums <- captioner::captioner(prefix = "Table 4.",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure 4.",levels = 1, auto_space = FALSE)

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")
#clean_cache(clean = TRUE)

thisyr    = 2019

source("/Users/ingridspies/admbmodels/Katch/assessments/R/read-rep.R")
#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/plot_m.R")
YFS0=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/fm.rep")
YFS1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/fm.rep")
YFS2=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.rep")
extra_sd2=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/extra_sd.rep",header=TRUE)
extra_sd1=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/extra_sd.rep",header=TRUE)
extra_sd0=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/extra_sd.rep",header=TRUE)
B0_2=formatC(1000*YFS2$Bzero,format="d",big.mark=",")
B0_1=formatC(1000*YFS1$Bzero,format="d",big.mark=",")
B0_0=formatC(1000*YFS0$Bzero,format="d",big.mark=",")

ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_next=1000*extra_sd2$ABC_HM[1]
TotBio_this=extra_sd2$GM_Biom[1]*1000
TotBio_next=extra_sd2$GM_Biom[2]*1000

femcat=YFS2$catage_f/rowSums(YFS2$catage_f)
malcat=YFS2$catage_m/rowSums(YFS2$catage_m)

#Base version M0.34,with fishlenlikelihood, stark mat
bigfile=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/bigfile.out",header=TRUE)

percentiles=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentiles.out",nrows =1,header=TRUE)

percentdb=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentdb.out")

PABC_this=1000*mean(bigfile$ABC[which(bigfile$Yr==2020&bigfile$Alternative==1)])#average catch 
PABC_thisF=formatC(PABC_this,format="d",big.mark=",")  #pmeans from proejction

PABC_next=1000*mean(bigfile$ABC[which(bigfile$Yr==2021&bigfile$Alternative==1)])       
PABC_nextF=formatC(PABC_next,format="d",big.mark=",")

ABC_last=267500
ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_thisF=formatC(ABC_this,format="d",big.mark=",")

ABC_next=1000*extra_sd2$ABC_HM[2]
ABC_nextF=formatC(ABC_next,format="d",big.mark=",")

OFL_this=1000*extra_sd2$OFL_AM[1]
OFL_thisF=formatC(OFL_this,format="d",big.mark=",")

OFL_next=1000*extra_sd2$OFL_AM[2]
OFL_nextF=formatC(OFL_next,format="d",big.mark=",")

TotBio_this=1000*extra_sd2$GM_Biom[1]
TotBio_thisF=formatC(TotBio_this,format="d",big.mark=",")

TotBio_next=1000*extra_sd2$GM_Biom[2]
TotBio_nextF=formatC(TotBio_next,format="d",big.mark=",")

TotBio_last=2331500
TotBio_lastF=formatC(TotBio_last,format="d",big.mark=",")

FSB_this=1000*extra_sd2$SSB[1]
FSB_thisF=formatC(FSB_this,format="d",big.mark=",")

FSB_next=1000*extra_sd2$SSB[2]
FSB_nextF=formatC(FSB_next,format="d",big.mark=",")

FSB_last=796600
FSB_lastF=formatC(FSB_last,format="d",big.mark=",")

FABC_this=round(extra_sd2$HM_Fmsyr[1],3)

FABC_next=round(extra_sd2$HM_Fmsyr[2],3)

FOFL_this=round(extra_sd2$AM_Fmsyr[1],3)
FOFL_next=round(extra_sd2$AM_Fmsyr[2],3)

Bmsy_this=1000*extra_sd2$Bmsy[1]
Bmsy_thisF=formatC(Bmsy_this,format="d",big.mark=",")

Bmsy_next=1000*extra_sd2$Bmsy[2]
Bmsy_nextF=formatC(Bmsy_next,format="d",big.mark=",")

catmo=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/YFScatch_OBSINT.csv",header=TRUE)

#proportion caught before November 2014-2018
prop=sum(catmo$TOTAL_WEIGHT[which(catmo$Month<11&catmo$Year<2019&catmo$Year>2013)])/sum(catmo$TOTAL_WEIGHT[which(catmo$Year<2019&catmo$Year>2013)])

catchZ=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/catch_YFS.csv",header=TRUE,skip=1)

c10=catchZ$Total[(nrow(catchZ)-10):(nrow(catchZ)-1)]
cn=str_replace(c10, ",", "")
cn10=mean(as.numeric(cn))#average catch last 10 years
```


## Justification of new model - Responses to SSC and Plan Team Comments. 

In their December 2019 minutes the SSC concurred with the Plan Team’s recommendation to use Model 18.1a for management in 2020, as Model 18.2 had not received thorough review. 

_In response we have prepared this update._

## Two models were considered in this assessment.

* Model 18.1a: Same model as in the 2018 assessment, updated with 2019 data. Model 18.1a used the same natural mortality for males and females, $M$=0.12. 
   
* Model 18.2: Uses a fixed value for female natural mortality ($M$=0.12) and allowed male natural mortality to be estimated within the model. Model 18.2 is the preferred model.



## The SSC requested the authors clarify and justify why natural mortality $M$ is estimated in the model for males, rather than for females or both sexes, and whether the value previously used for both sexes combined ($M$=0.12) is appropriate for a single sex.  

\small
\setlength{\leftmargini}{0pt}
* _First step towards examining sex-specific $M$ for Yellowfin sole._
* _Skewed sex ratio in Yellowfin Sole, other flatfish -> evidence for higher male $M$._
* _Sex-specific $M$ -> common feature for flatfish (e.g. Arrowtooth Flounder)._
* _High proportion of females -> better understanding of female $M$._
* _Female $M$: 0.10 to 0.33, Male $M$: 0.16 to 0.51 (Wilderbuer and Turnock 2009)._
* _Assumptions in Model 18.2 based on best available information._ 
\normalsize

## Data included in the models

\small
Data source                                         Year
--------------------------------------------------- ----------------------------   
Fishery catch                                       1954 - `r thisyr`            
Fishery age composition	                            1964 - `r thisyr-1`          
Fishery weight-at-age	                              1964 - `r thisyr-1`  
Survey biomass and standard error                   1982 - `r thisyr` 
Bottom temperature	                                 1982 - `r thisyr` 
Survey age composition	                             1979 - `r thisyr-1` 
Annual length, weight-at-age surveys	               1979 - `r thisyr-1` 
Age at maturity	                                    Combined 1992 and 2012 samples
----------------------- 
\normalsize


## Likelihood table for Model 18.1a and 18.2
```{r liketab, echo=FALSE}
totallike2=sum(YFS2$wt_like,YFS2$age_likeihood_for_survey,YFS2$age_likelihood_for_fishery,YFS2$catch_likelihood,YFS2$selectivity_likelihood,YFS2$survey_likelihood,YFS2$recruitment_likelilhood) #recommended
totallike1=sum(YFS1$wt_like,YFS1$age_likeihood_for_survey,YFS1$age_likelihood_for_fishery,YFS1$catch_likelihood,YFS1$selectivity_likelihood,YFS1$survey_likelihood,YFS1$recruitment_likelilhood)  
```

\begin{table}[h]
\centering
\begin{tabular}{ lrr }
\hline
 Likelihood component & Model $18.1a$ & Model $18.2$ \\
\hline
Survey age	        &       `r round(YFS1$age_likeihood_for_survey,2)`  &  `r round(YFS2$age_likeihood_for_survey,2)`   \\
Fishery age  	  &       `r round(YFS1$age_likelihood_for_fishery,2)` &  `r round(YFS2$age_likelihood_for_fishery,2)`  \\
Selectivity     &       `r round(sum(YFS1$selectivity_likelihood),2)`& `r round(sum(YFS2$selectivity_likelihood),2)`\\
Survey biomass     &       `r round(YFS1$survey_likelihood,2)`& `r round(YFS2$survey_likelihood,2)`\\
Recruitment     &       `r round(sum(YFS1$recruitment_likelilhood),2)`& `r round(sum(YFS2$recruitment_likelilhood),2)`  \\
Catchability & `r round(YFS1$catch_likelihood,4)` & `r round(YFS2$catch_likelihood,4)` \\
\hline
Total              &       `r round(totallike1,2)`      &`r round(totallike2,2)`      \\ 
\hline
\end{tabular}
\end{table}

## Comparison of results for Model 18.1a and Model 18.2

\tiny
\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 18.2}  & \multicolumn{2}{c}{Model 18.1a}              \\
        Quantity & `r thisyr+1`      &`r thisyr+2`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
$M$ (natural mortality rate)         &  0.12, 0.135   & 0.12, 0.135  &  0.12   &  0.12   \\
Tier                                  &  1a   &  1a   &  1a   & 1a    \\
Projected total (age 6+) biomass (t)  &  `r formatC(extra_sd2$GM_Biom[1]*1000,format="d",big.mark=",")`   &  `r formatC(extra_sd2$GM_Biom[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$GM_Biom[2]*1000,format="d",big.mark=",")`  \\
Projected female spawning biomass (t) &  `r formatC(extra_sd2$SSB[1]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd2$SSB[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$SSB[2]*1000,format="d",big.mark=",")`  \\
$\:\:\:\:\:\:B_{100\%}$                           &  `r B0_2`  &  `r B0_2`  &  `r B0_1`  & `r B0_1`   \\
$\:\:\:\:\:\:B_{MSY\%}$                            &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")` t & `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")` t \\
$F_{OFL}$                             &  `r round(extra_sd2$AM_Fmsyr[1],3)`   &  `r round(extra_sd2$AM_Fmsyr[2],3)`   &  `r round(extra_sd1$AM_Fmsyr[1],3)`  & `r round(extra_sd1$AM_Fmsyr[2],3)`  \\
$maxF_{ABC}$                          &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &   `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`    & `r round(extra_sd1$HM_Fmsyr[2],3)`     \\
$F_{ABC}$                             &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &  `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`   & `r round(extra_sd1$HM_Fmsyr[2],3)`   \\
$OFL$                                 &  `r formatC(1000*extra_sd2$OFL_AM[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$OFL_AM[2],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$OFL_AM[2],format="d",big.mark=",")` 
\\
$maxABC$                              &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") `  \\
$ABC$                                 &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") ` & `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") `  \\
\hline
Status                               & `r thisyr-1`       & `r thisyr`      &  `r thisyr-1`             & `r thisyr`            \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections for Model 18.1a and 18.2 were based on estimated catches of 118,642 t in `r thisyr` and `r formatC(cn10,format="d",big.mark=",")` used in place of maximum ABC for `r thisyr+1`.
  \end{tablenotes}
\end{table}
\normalsize


## Estimates of total (solid line) and spawning (dotted line) biomass, Model 18.1a and 18.2, 1982-2019.

```{r srvbio_fit2, message=FALSE, echo=FALSE}  
#fit to survey biomass
LCI=YFS1$ob_bts-1.96*YFS1$sd_ob_bts
HCI=YFS1$ob_bts+1.96*YFS1$sd_ob_bts
srv_bio1=data.frame(cbind(YFS1$yrs_srv,YFS1$ob_bts,YFS1$sd_ob_bts,LCI,HCI,YFS1$pred_srv[29:66],YFS1$TotBiom[29:66,2],YFS1$SSB[29:66,2]))
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio2=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI,YFS2$pred_srv[29:66],YFS2$TotBiom[29:66,2],YFS2$SSB[29:66,2]))
srv_bio3=rbind(srv_bio1,srv_bio2)
Model=c(rep("Model 18.1a",nrow(srv_bio1)),rep("Model 18.2",nrow(srv_bio1)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","TotalBiomass","SSB","Model")

ggplot(data=srv_bio4,aes(x=Year,y=TotalBiomass))+geom_line(aes(x=Year,y=TotalBiomass,col=Model))+geom_line(aes(x=Year,y=SSB,col=Model),linetype=2)+theme(legend.title=element_text(size=20),legend.text=element_text(size=20),axis.text=element_text(size=20),axis.title.x = element_text(size=15),axis.title.y = element_text(size=15))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

```

## Estimate of survey selectivity for males and females, Model 18.1a upper panel, Model 18.2 lower panel.
```{r srvsel, echo=FALSE, message=FALSE}
srvsel2=data.frame(cbind(seq(1,20,1),YFS2$sel_srv_f,YFS2$sel_srv_m))
colnames(srvsel2)=c("Age","Female","Male")
p2=ggplot(data=srvsel2)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.2")

srvsel1=data.frame(cbind(seq(1,20,1),YFS1$sel_srv_f,YFS1$sel_srv_m))
colnames(srvsel1)=c("Age","Female","Male")
p1=ggplot(data=srvsel1)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.1a")

grid.arrange(p1, p2, ncol = 1)


```


## Survey catchability for Model 18.1a and 18.2, 1982-2019.

```{r plotq, message=FALSE,echo=FALSE}
    df <- data.frame( Year    = YFS2$yrs_srv )
    df$Model <- "Model 18.2"
    df$q_srv   <- YFS2$q_srv 
    
    df1 <- data.frame( Year    = YFS1$yrs_srv )
    df1$Model <- "Model 18.1a"
    df1$q_srv   <- YFS1$q_srv 
    
    df2=data.frame(rbind(df1,df))
    
    ggplot(df2) +geom_line(aes(x = Year, y = q_srv, col = Model),size=1.2)+ 
        labs(x = "Year", y = "Survey catchability")+theme_bw()

```

## NMFS EBS survey biomass estimates, Model 18.1a and 18.2 fit to survey biomass estimates, 1982-2019.

```{r srvbio_fit, message=FALSE, echo=FALSE}  
#fit to survey biomass
LCI=YFS1$ob_bts-1.96*YFS1$sd_ob_bts
HCI=YFS1$ob_bts+1.96*YFS1$sd_ob_bts
srv_bio1=data.frame(cbind(YFS1$yrs_srv,YFS1$ob_bts,YFS1$sd_ob_bts,LCI,HCI,YFS1$pred_srv[29:66],YFS1$TotBiom[29:66,2],YFS1$SSB[29:66,2]))
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio2=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI,YFS2$pred_srv[29:66],YFS2$TotBiom[29:66,2],YFS2$SSB[29:66,2]))
srv_bio3=rbind(srv_bio1,srv_bio2)
Model=c(rep("Model 18.1a",nrow(srv_bio1)),rep("Model 18.2",nrow(srv_bio1)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","TotalBiomass","SSB","Model")

ggplot(data=srv_bio4,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

```


## Model estimates of the proportion of female Yellowfin Sole in the population, 1982-2018.

```{r sexratio,message=FALSE,echo=FALSE}
        df <- data.frame(rowSums(YFS2$natage_f)/rowSums(YFS2$natage_f+YFS2$natage_m))
        df$Model <- "Model 18.2"
        df$Year=YFS2$Yr
        colnames(df)=c("Sex_Ratio","Model","Year")
        
        df1 <- data.frame(rowSums(YFS1$natage_f)/rowSums(YFS1$natage_f+YFS1$natage_m))
        df1$Model <- "Model 18.1a"
        df1$Year=YFS2$Yr

        colnames(df1)=c("Sex_Ratio","Model","Year")
        df2=rbind(df1,df)
        
        ggplot(df2) + geom_point(data=df2, aes(x = Year, y = Sex_Ratio,color=Model),size=3)+labs(xlab = "Year", ylab = "Proportion female")+
          ylab("Proportion Female")+theme_bw()

```


## Ricker stock recruitment curve, 95% CIs fit to FSB (years in black) and recruitment 1978-2013.
```{r ricker1,echo=FALSE,message=FALSE}

 df <- data.frame(YFS1$SRR_SSB)
 df$Year <- YFS1$Year
 df$rhat <- YFS1$rechat
 df$rhat.sd <- YFS1$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS1$Yr[60:66],YFS1$SSB[60:66,2],(YFS1$natage_f[60:66,1]+YFS1$natage_m[60:66,1]))
  df3=data.frame(YFS1$Yr[25:60],YFS1$SSB[25:60,2],(YFS1$natage_f[25:60,1]+YFS1$natage_m[25:60,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
rec_18_1a=ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, billions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.1a")+theme_bw()+theme(plot.title = element_text(size = 30),axis.text=element_text(size=14,hjust=0.8))


 df <- data.frame(YFS2$SRR_SSB)
 df$Year <- YFS2$Year
 df$rhat <- YFS2$rechat
 df$rhat.sd <- YFS2$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS2$Yr[60:66],YFS2$SSB[60:66,2],(YFS2$natage_f[60:66,1]+YFS2$natage_m[60:66,1]))
  df3=data.frame(YFS2$Yr[25:60],YFS2$SSB[25:60,2],(YFS2$natage_f[25:60,1]+YFS2$natage_m[25:60,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 rec_18_2=ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, millions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.2")+theme_bw()+theme(plot.title = element_text(size = 30),axis.text=element_text(size=14))
 


grid.arrange(rec_18_1a, rec_18_2,ncol=2,nrow=1)
```


## Fit to the time-series of survey age composition, by sex, 1979-2018, Models 18.2 and 18.1a.

```{r srv_agecomp_both,message=FALSE,echo=FALSE,fig.height=7.5}

tdf=read.csv("/Users/ingridspies/Downloads/tdf_both.csv")
nages=20
ix <- pretty(1:nages)
p <- ggplot(tdf,aes(Age,value/2,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(Age),pred,col=Sex,linetype=Model),alpha=0.85)
#p <- p + geom_line(aes(as.numeric(Age),pred,col=Model),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")+ggtitle("Fit to Survey Age Compositions, Model 18.1a")
```





## MCMC posterior distributions for Models 18.1a and 18.2.
```{r mcmcplots, message=FALSE, echo=FALSE}
hdr <- read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/data/hdr.dat",as.is=T,header=F)
mctmp2.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/evalout_YFIN.rep",col_names=FALSE)
mctmp1.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/evalout_YFIN.rep",col_names=FALSE)
names(mctmp1.df) <- hdr
names(mctmp2.df) <- hdr
mcdat=rbind(mctmp1.df,mctmp2.df)
mcdat$Model=c(rep("Model 18.1a",nrow(mctmp1.df)),rep("Model 18.2",nrow(mctmp1.df)))

p1=ggplot(data=mcdat, aes(x=Fmsyr,fill=Model)) + geom_density(aes(x=Fmsyr),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Fmsy") + xlim(c(0,.3))+theme_bw()+ylab("Density")

p2=ggplot(data=mcdat, aes(x=1000*Bmsy,fill=Model)) + geom_density(aes(x=Bmsy),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Bmsy (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(100,1300))

p3=ggplot(data=mcdat, aes(x=ln_mean_R,fill=Model)) + geom_density(aes(x=ln_mean_R),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("log(mean(Recruitment))x10^9") +theme_bw()+ylab("Density")

p4=ggplot(data=mcdat, aes(x=ABC_biom6,fill=Model)) + geom_density(aes(x=ABC_biom6),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Age 6 Biomass (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(1000,7000))

p5=ggplot(data=mcdat, aes(x=SSB_2019,fill=Model)) + geom_density(aes(x=SSB_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("FSB (x1,000 t)") +theme_bw()+ylab("Density")+geom_vline(xintercept=(Bmsy_this/1000))+xlim(c(300,1400))

p6=ggplot(data=mcdat, aes(x=TotBiom_2019,fill=Model)) + geom_density(aes(x=TotBiom_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Total Biomass (x10^9 t)") +theme_bw()+ylab("Density")

grid.arrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```


## Retrospective plots of female spawning biomass
```{r together, echo=FALSE,message=FALSE}


YFS2019=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.rep")
YFS2018retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.rep")
YFS2017retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.rep")
YFS2016retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.rep")
YFS2015retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.rep")
YFS2014retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.rep")
YFS2013retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.rep")
YFS2012retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.rep")
YFS2011retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.rep")
YFS2010retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.rep")
YFS2009retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.rep")


a=-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2]
b=-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2]
c=-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2]
d=-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2]
e=-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2]
f=-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2]
g=-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2]
h=-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2]
i=-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2]
j=-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2]

Rho=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#repeat with accepted model

YFS2019a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_0.rep")
YFS2018retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_1.rep")
YFS2017retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_2.rep")
YFS2016retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_3.rep")
YFS2015retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_4.rep")
YFS2014retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_5.rep")
YFS2013retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_6.rep")
YFS2012retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_7.rep")
YFS2011retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_8.rep")
YFS2010retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_9.rep")
YFS2009retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_10.rep")


a=-1*(YFS2019a$SSB[1:65,2]-YFS2018retro_a$SSB[1:65,2])/YFS2019a$SSB[1:65,2]
b=-1*(YFS2019a$SSB[1:64,2]-YFS2017retro_a$SSB[1:64,2])/YFS2019a$SSB[1:64,2]
c=-1*(YFS2019a$SSB[1:63,2]-YFS2016retro_a$SSB[1:63,2])/YFS2019a$SSB[1:63,2]
d=-1*(YFS2019a$SSB[1:62,2]-YFS2015retro_a$SSB[1:62,2])/YFS2019a$SSB[1:62,2]
e=-1*(YFS2019a$SSB[1:61,2]-YFS2014retro_a$SSB[1:61,2])/YFS2019a$SSB[1:61,2]
f=-1*(YFS2019a$SSB[1:60,2]-YFS2013retro_a$SSB[1:60,2])/YFS2019a$SSB[1:60,2]
g=-1*(YFS2019a$SSB[1:59,2]-YFS2012retro_a$SSB[1:59,2])/YFS2019a$SSB[1:59,2]
h=-1*(YFS2019a$SSB[1:58,2]-YFS2011retro_a$SSB[1:58,2])/YFS2019a$SSB[1:58,2]
i=-1*(YFS2019a$SSB[1:57,2]-YFS2010retro_a$SSB[1:57,2])/YFS2019a$SSB[1:57,2]
j=-1*(YFS2019a$SSB[1:56,2]-YFS2009retro_a$SSB[1:56,2])/YFS2019a$SSB[1:56,2]

#accepted model rho
Rho_a=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

#retrospective

std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.std")
std2009=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.std")


ret18=data.frame(cbind(c(1954:2018),YFS2018retro$SSB[,2],YFS2018retro$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018retro$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017retro$SSB[,2],YFS2017retro$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017retro$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016retro$SSB[,2],YFS2016retro$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016retro$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015retro$SSB[,2],YFS2015retro$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015retro$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014retro$SSB[,2],YFS2014retro$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014retro$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013retro$SSB[,2],YFS2013retro$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013retro$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012retro$SSB[,2],YFS2012retro$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012retro$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011retro$SSB[,2],YFS2011retro$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011retro$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010retro$SSB[,2],YFS2010retro$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010retro$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))

ret09=data.frame(cbind(c(1954:2009),YFS2009retro$SSB[,2],YFS2009retro$SSB[,2]+1.96*as.numeric(as.vector(std2009[['V4']][531:586])),YFS2009retro$SSB[,2]-1.96*as.numeric(as.vector(std2009[['V4']][531:586]))))


retro=as.data.frame(rbind(ret09,ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

theme_set(theme_gray(base_size = 18))
p18_2=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=14),axis.title.x = element_text(size=24),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 20))+theme(axis.text.x=element_text(angle=0,hjust=0.5))+theme(legend.justification=c(1,0), legend.position=c(.98,0.02))+theme(legend.key.size = unit(0.3, "cm"))+ggtitle("Model 18.2")+theme(plot.title = element_text(size = 34))


#Model 18.1a
#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#retrospective

std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_0.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_1.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_2.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_3.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_4.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_5.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_6.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_7.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_8.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_9.std")
std2009=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_10.std")


ret18=data.frame(cbind(c(1954:2018),YFS2018retro$SSB[,2],YFS2018retro$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018retro$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017retro$SSB[,2],YFS2017retro$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017retro$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016retro$SSB[,2],YFS2016retro$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016retro$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015retro$SSB[,2],YFS2015retro$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015retro$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014retro$SSB[,2],YFS2014retro$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014retro$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013retro$SSB[,2],YFS2013retro$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013retro$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012retro$SSB[,2],YFS2012retro$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012retro$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011retro$SSB[,2],YFS2011retro$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011retro$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010retro$SSB[,2],YFS2010retro$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010retro$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))

ret09=data.frame(cbind(c(1954:2009),YFS2009retro$SSB[,2],YFS2009retro$SSB[,2]+1.96*as.numeric(as.vector(std2009[['V4']][531:586])),YFS2009retro$SSB[,2]-1.96*as.numeric(as.vector(std2009[['V4']][531:586]))))


retro=as.data.frame(rbind(ret09,ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

p18_1a=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=14),axis.title.x = element_text(size=24),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 20))+theme(axis.text.x=element_text(angle=0,hjust=0.5))+theme(legend.justification=c(1,0), legend.position=c(.98,0.02))+theme(legend.key.size = unit(0.3, "cm"))+ggtitle("Model 18.1a")+ theme(plot.title = element_text(size = 34))



grid.arrange(p18_1a,p18_2,ncol=2,nrow=1)
```

## Relative difference in estimates of FSB between the most recent model and retrospective runs

```{r retro2, echo=FALSE,message=FALSE}
#plot differences
Years=c(c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010),c(1954:2009))


Difference=c(-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2],
-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2],
-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2],
-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2],
-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2],
-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2],
-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2],
-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2],
-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2],
-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2])



Year=(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)

p=ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))+theme(legend.key.size = unit(1, "cm"))

p18_2_diff=ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 20))+theme(axis.text.x=element_text(angle=0,hjust=0.5))+theme(legend.justification=c(1,0), legend.position=c(.7,0.02))+theme(legend.key.size = unit(0.3, "cm"))+ggtitle("Model 18.2")+ theme(plot.title = element_text(size = 34))


#Model18.1a
Years=c(c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010),c(1954:2009))


Difference=c(-1*(YFS2019a$SSB[1:65,2]-YFS2018retro_a$SSB[,2])/YFS2019a$SSB[1:65,2],
-1*(YFS2019a$SSB[1:64,2]-YFS2017retro_a$SSB[,2])/YFS2019a$SSB[1:64,2],
-1*(YFS2019a$SSB[1:63,2]-YFS2016retro_a$SSB[,2])/YFS2019a$SSB[1:63,2],
-1*(YFS2019a$SSB[1:62,2]-YFS2015retro_a$SSB[,2])/YFS2019a$SSB[1:62,2],
-1*(YFS2019a$SSB[1:61,2]-YFS2014retro_a$SSB[,2])/YFS2019a$SSB[1:61,2],
-1*(YFS2019a$SSB[1:60,2]-YFS2013retro_a$SSB[,2])/YFS2019a$SSB[1:60,2],
-1*(YFS2019a$SSB[1:59,2]-YFS2012retro_a$SSB[,2])/YFS2019a$SSB[1:59,2],
-1*(YFS2019a$SSB[1:58,2]-YFS2011retro_a$SSB[,2])/YFS2019a$SSB[1:58,2],
-1*(YFS2019a$SSB[1:57,2]-YFS2010retro_a$SSB[,2])/YFS2019a$SSB[1:57,2],
-1*(YFS2019a$SSB[1:56,2]-YFS2009retro_a$SSB[,2])/YFS2019a$SSB[1:56,2])



Year=(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)

p=ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))+theme(legend.key.size = unit(1, "cm"))

p18_1a_diff=ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 20))+theme(axis.text.x=element_text(angle=0,hjust=0.5))+theme(legend.justification=c(1,0), legend.position=c(.7,0.02))+theme(legend.key.size = unit(0.3, "cm"))+ggtitle("Model 18.1a")+ theme(plot.title = element_text(size = 34))


grid.arrange(p18_1a_diff,p18_2_diff,ncol=2,nrow=1)
```

## Retrospective results

* Mohn’s rho was -0.219 using Model 18.2 and -0.254 under Model 18.1a.

* Retrospective differences were almost always negative under Model 18.1a but more balanced under 18.2.

## Conclusions 

* Model 18.2 has several characteristics that indicate it is a better model than 18.1a.

* Higher male natural mortality is accepted for the population dynamics of other flatfish species.

* Model 18.2 has higher total likelihood.

* Model 18.2 has an improved difference in female spawning biomass retrospective patterns and less negative Mohn's rho.


## Questions?

\begin{center}
\includegraphics[height=6in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/sole-yellowfin.pdf}
\end{center}


## photo

\begin{center}
\includegraphics[height=3in,angle=0,origin=r,trim=200 200 200 200, clip]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2020/spies_cod.pdf}
\renewcommand{\floatpagefraction}{.2}
\end{center}



