---
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
---

---
header-includes:
 \usepackage{booktabs}
 \usepackage{float}
 \usepackage{graphicx}
 \usepackage{floatrow}
 \usepackage{caption}
 \usepackage{subcaption}
 \usepackage{subfigure}
geometry:
  left=1in,right=1in,top=1in,bottom=1in
---

```{r global options, include=FALSE, message=FALSE}
library(here)
library(here)
library(adnuts)
library(ggplot2)
library(RColorBrewer)
library(doBy)
library(tidyr)
library(dplyr)
library(gridExtra)
library(tidyverse)
library(purrr)
library(stringr)
library(ggplot2)
library(knitr)
library(kableExtra)
options(knitr.kable.NA = '')
knitr::opts_knit$set(root.dir = '../../' )
library(captioner)
library(bibtex)
library(knitcitations)
library(cowplot)
library(magick)
library(bookdown)
library(ggthemes)
library(scales)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
require(knitr)
library(scales)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(ggmap)
library(widyr)
library(scales)
#install.packages("formattable")
#install.packages("formattable")
library(flextable)
library(officer)
library(ggthemes)

require(kfigr) # devtools::install_github("github mkoohafkan/kfigr")
opts_chunk$set(message=FALSE, warning=FALSE)

table_nums <- captioner::captioner(prefix = "Table ",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure ",levels = 1, auto_space = FALSE)

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")
#clean_cache(clean = TRUE)

thisyr    = 2019


#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/prelims.R")
source("/Users/ingridspies/admbmodels/Katch/assessments/R/read-rep.R")
#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/plot_m.R")
YFS0=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/fm.rep")
YFS1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/fm.rep")#this is the accepted model. single natural mortality.
YFS2=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.rep")
extra_sd2=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/extra_sd.rep",header=TRUE)
extra_sd1=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/extra_sd.rep",header=TRUE)
extra_sd0=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/extra_sd.rep",header=TRUE)
B0_2=formatC(1000*YFS2$Bzero,format="d",big.mark=",")
B0_1=formatC(1000*YFS1$Bzero,format="d",big.mark=",")
B0_0=formatC(1000*YFS0$Bzero,format="d",big.mark=",")

ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_next=1000*extra_sd2$ABC_HM[1]
TotBio_this=extra_sd2$GM_Biom[1]*1000
TotBio_next=extra_sd2$GM_Biom[2]*1000

femcat=YFS2$catage_f/rowSums(YFS2$catage_f)
malcat=YFS2$catage_m/rowSums(YFS2$catage_m)

#Base version M0.34,with fishlenlikelihood, stark mat
bigfile=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/bigfile.out",header=TRUE)

percentiles=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentiles.out",nrows =1,header=TRUE)

percentdb=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentdb.out")

PABC_this=1000*mean(bigfile$ABC[which(bigfile$Yr==2020&bigfile$Alternative==1)])#average catch 
PABC_thisF=formatC(PABC_this,format="d",big.mark=",")  #pmeans from proejction

PABC_next=1000*mean(bigfile$ABC[which(bigfile$Yr==2021&bigfile$Alternative==1)])       
PABC_nextF=formatC(PABC_next,format="d",big.mark=",")

ABC_last=267500
ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_thisF=formatC(ABC_this,format="d",big.mark=",")

ABC_next=1000*extra_sd2$ABC_HM[2]
ABC_nextF=formatC(ABC_next,format="d",big.mark=",")

OFL_this=1000*extra_sd2$OFL_AM[1]
OFL_thisF=formatC(OFL_this,format="d",big.mark=",")

OFL_next=1000*extra_sd2$OFL_AM[2]
OFL_nextF=formatC(OFL_next,format="d",big.mark=",")

TotBio_this=1000*extra_sd2$GM_Biom[1]
TotBio_thisF=formatC(TotBio_this,format="d",big.mark=",")

TotBio_next=1000*extra_sd2$GM_Biom[2]
TotBio_nextF=formatC(TotBio_next,format="d",big.mark=",")

TotBio_last=2331500
TotBio_lastF=formatC(TotBio_last,format="d",big.mark=",")

FSB_this=1000*extra_sd2$SSB[1]
FSB_thisF=formatC(FSB_this,format="d",big.mark=",")

FSB_next=1000*extra_sd2$SSB[2]
FSB_nextF=formatC(FSB_next,format="d",big.mark=",")

FSB_last=796600
FSB_lastF=formatC(FSB_last,format="d",big.mark=",")

FABC_this=round(extra_sd2$HM_Fmsyr[1],3)

FABC_next=round(extra_sd2$HM_Fmsyr[2],3)

FOFL_this=round(extra_sd2$AM_Fmsyr[1],3)
FOFL_next=round(extra_sd2$AM_Fmsyr[2],3)

Bmsy_this=1000*extra_sd2$Bmsy[1]
Bmsy_thisF=formatC(Bmsy_this,format="d",big.mark=",")

Bmsy_next=1000*extra_sd2$Bmsy[2]
Bmsy_nextF=formatC(Bmsy_next,format="d",big.mark=",")

catmo=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/YFScatch_OBSINT.csv",header=TRUE)

#proportion caught before November 2014-2018
prop=sum(catmo$TOTAL_WEIGHT[which(catmo$Month<11&catmo$Year<2019&catmo$Year>2013)])/sum(catmo$TOTAL_WEIGHT[which(catmo$Year<2019&catmo$Year>2013)])

catchZ=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/catch_YFS.csv",header=TRUE,skip=1)

c10=catchZ$Total[(nrow(catchZ)-10):(nrow(catchZ)-1)]
cn=str_replace(c10, ",", "")
cn10=mean(as.numeric(cn))#average catch last 10 years

retdis=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/RetDis_full.csv",header=TRUE)#Sept 25 2019
```

---
title: 'Yellowfin Sole model for Plan Team consideration for the Yellowfin Sole Stock\ in the Bering Sea and Aleutian Islands'

#author: <h4 style="font-style:normal">"Ingrid Spies"</h4> 
output:
  pdf_document: 
  highlight: zenburn
  html_document: default
---


\begin{centering}
\fontfamily{cmr}
\fontsize{10}{12}
  Ingrid Spies and James Ianelli\\
\selectfont
  Alaska Fisheries Science Center, National Marine Fisheries Service \\
  National Oceanic and Atmospheric Administration \\ 
  7600 Sand Point Way NE., Seattle, WA 98115-6349 \\
  {`r format(Sys.time(), '%d %B, %Y')`}\\
\end{centering}

#  Executive summary

This document presents a new model for consideration for the 2020 BSAI Yellowfin Sole stock assessment. The data used to explore models are the same as those used in the 2019 assessment.

#### Relative to the 2018 assessment, the models include the following data updates.

   1.	The `r thisyr` NMFS eastern Bering Sea shelf bottom-trawl survey biomass estimates and standard error were included.
   2. The `r thisyr-1` fishery age composition was added.
   3. The `r thisyr-1` survey age composition was included.
   4. Estimates of the retained and discarded portions of the `r thisyr-1` catch were added.
   5. The estimate of the total catch made through the end of `r thisyr+1` was used. 

### Two models are presented here:

   1. Model 18.1a: The accepted model used in the `r thisyr-1` assessment is referred to as Model 18.1a. Model 18.1a used the same natural mortality for males and females, $M$=0.12. 
   
   2. Model 18.2: This second model uses a fixed value for female natural mortality ($M$=0.12) and allows male natural mortality to be estimated within the model. Model 18.2 is the preferred model.

## Data  

The data used in these models include estimates of total catch, bottom trawl survey biomass estimates and their attendant 95% confidence intervals, catch-at-age from the fishery, and population age composition estimates from the bottom trawl survey.  Weight-at-age and proportion mature-at-age are also available from studies conducted during the bottom trawl surveys. Further information on the data used here can be found in the 2019 Yellowfin Sole stock assessment (Spies et al. 2019a).

\pagebreak

Data source                                         Year
--------------------------------------------------- ----------------------------   
Fishery catch                                       1954 - `r thisyr`            
Fishery age composition	                            1964 - `r thisyr-1`          
Fishery weight-at-age	                              Avg. weight at age from 2008-2018 used for 2008-`r thisyr` 
Survey biomass and standard error                   1982 - `r thisyr` 
bottom temperature	                                 1982 - `r thisyr` 
Survey age composition	                             1979 - `r thisyr-1` 
Annual length-at-age and weight-at-age from surveys	1979 - `r thisyr-1` 
Age at maturity	                                    Combined 1992 and 2012 samples
----------------------- 

## Responses to SSC and Plan Team Comments Specific to this Assessment

In their December 2019 minutes the SSC concurred with the Plan Team’s recommendation to use Model 18.1a for management in 2020, as Model 18.2 had not received thorough review. 

_In response we have prepared this update._

The SSC requested the authors clarify and justify why natural mortality is estimated in the model for males, rather than for females or both sexes, and whether the value previously used for both sexes combined ($M$=0.12) is appropriate for a single sex.  

_Examining the sex-specific differences in natural mortality, $M$, was a first step towards revisiting assumptions about natural mortality in Yellowfin Sole. Sex-specific natural mortality is a common feature for flatfish that is currently used in NPFMC arrowtooth flounder stock assessment models (Wilderbuer and Turnock 2009; Spies et al. 2018; Spies et al. 2019a). Skewed sex ratio in Yellowfin Sole and research on other flatfish species provides evidence for higher natural mortality for males than females (Nichol et al. 1998; Wilderbuer and Turnock 2009). In Model 18.2, natural mortality is fixed for females, rather than males, because the high proportion of females allows for a better understanding of female natural mortality than male. Natural mortality was estimated at $M$ = 0.12 by minimizing residual variance (Bakkala and Wespestad 1984) and by profiling over a range of values in the stock assessment model using data up to 1992 (Wilderbuer 1992). Female $M$ was estimated from 0.10 to 0.33 and from 0.16 to 0.51 for males (Wilderbuer and Turnock 2009), and a single estimate of female $M$ was 0.10 (Gunderson et al. 2003). We acknowledge that other parameterizations may provide a better fit to the data, but the assumptions in Model 18.2 were made based on the best available information. Future model configurations will to continue to explore split sex natural mortality for Yellowfin Sole._

The SSC appreciates the authors’ initial response concerning the variability in the proportion of the yellowfin sole stock that occurs in the Northern Bering Sea. As described in the 2018 SSC minutes, the SSC suggests the application of the VAST model to estimate the proportion of yellowfin sole in the NBS over time, as well as an examination of other available data sources, in particular the ADF&G survey in Norton Sound that has been conducted triennially since 1978 and annually since 2017. The SSC continues to encourage the authors to consider approaches for including the substantial biomass of NBS yellowfin sole in the model, with the expectation that NBS surveys will be conducted regularly in the future. 

_Authors plan to consider addition of Northern Bering Sea survey data for the December document as an exploratory analysis._ 

The SSC suggest the authors consider estimating a single selectivity curve for both sexes since the sex-specific selectivities are so similar. 

_This will be considered for the December document._

The SSC requests the authors include an explanation of why the model fit to the survey and the model estimated biomass trends diverge, including what model-estimated process explains the change, whether the process is biologically plausible, and whether this model estimated process could potentially explain the retrospective pattern.  

_This will be investigated in future analyses._

The SSC acknowledges the past work that has been done to resolve the retrospective pattern and recognizes that the models with the best fit are different than those that with the best retrospective pattern. However, the SSC remains concerned about the large retrospective pattern and requests the authors continue to investigate this as they are able. 

_This will continue to be investigated._

The SSC recommends the authors revisit the fixed values of natural mortality, as the document states the data from which these values are based are from the 1990s. 

_Examining the sex-specific differences in M was a first step towards revisiting assumptions about natural mortality. Further explorations are planned._

The SSC also noted a number of editorial matters which we were grateful to receive and note that they were corrected for the posted final version.

## Description of Models

The general model structure is as described in the 2019 Yellowfin Sole stock assessment (Spies et al. 2019b). The accepted model used in the `r thisyr` assessment is referred to as Model 18.1a. Model 18.1a used the same natural mortality for males and females, $M$=0.12. A second model is also considered in this assessment (Model 18.2) that uses a fixed value for female natural mortality ($M$=0.12) and allows male natural mortality to be estimated within the model. This was included in some cases for comparison, but is not explicitly compared here, as comparison of Model 18.2 with Model 18.1a was sufficient to understand differences among the two models.

## Parameters Estimated Outside the Assessment Model

Natural mortality ($M$) was initially estimated by a least squares analysis where catch at age data were fitted to Japanese pair trawl effort data while varying the catchability coefficient ($q$) and $M$ simultaneously.  The best fit to the data (the point where the residual variance was minimized) occurred at a value of $M$=0.12 (Bakkala and Wespestad 1984). This was also the value which provided the best fit to the observable population characteristics when $M$ was profiled over a range of values in the stock assessment model using data up to 1992 (Wilderbuer 1992). 

## Parameters Estimated Inside the Assessment Model

There were 452 parameters estimated by Model 18.2, and 453 parameters estimated by Model 18.1a. The number of key parameters are presented below:

\begin{table}[H]
\centering
\begin{tabular}{ rrrrrrr }
\hline
Fishing mortality  &   Selectivity	 & Survey catchability	  &  Year-class strength    &     Spawner-recruit	&   $M$  \\
\hline
67 & 272 & 4 & 106 & 2 & 1 or 2 \\
\hline
\end{tabular}
\end{table}

In each year, seven additional parameters are generally added to the model; another year of fishery data and the entry of another year class into the observed population, four more sex-specific fishery selectivity parameters, and an additional catchability parameter. Either 1 or two parameters were incorporated for male natural mortality, depending on the model.

# Results (Model Evaluation)

Two models are presented in this document. Model 18.1a was the accepted model used in the 2019 assessment. The second model, Model 18.2, fixed female natural mortality at $M$=0.12 as in previous years, but allowed the model to freely estimate male natural mortality. The model estimated male natural mortality to be higher than female natural mortality (0.135), which is in common with known life history parameters of other Alaska flatfish. In Arrowtooth Flounder, higher natural mortality is assumed for males and is consistent with their skewed sex ratio (Wilderbuer and Turnock 2009). Higher natural mortality for male flatfish has been assumed to flatfish from other regions as well (Maunder and Wong 2011).

The two models differed slightly in several parameter estimates. The trend in survey catchability was similar for Model 18.1a and Model 18.2, but catchability was lower with Model 18.2 (`r figure_nums("plotq",display="cite")`). The sex ratio estimate changed slightly in Model 18.2. The proportion female was estimated to be slightly lower in Model 18.1a than Model 18.2, as higher male natural mortality increased the estimated number of males in the population (`r figure_nums("sexratio",display="cite")`). Female spawning biomass did not change significantly among Model 18.1a and 18.2, but was slightly higher for Model 18.2 (`r table_nums("FSBCI",display="cite")`). A similar pattern was noted for total (age 2+) biomass (`r table_nums("biomCI",display="cite")`). Recruitment estimates were also higher in Model 18.2, likely due to the higher natural mortality applied to males (`r table_nums("rec",display="cite")`). Overall, the total negative log likelihod was lower for Model 18.2, and provided a better fit to the survey and fishery ages, as well as an improvement to the fit to survey catchability, with the total negative log likelihood reduced from 1,424 in Model 18.1a to 1,356 in Model 18.2 (`r table_nums("liketab",display="cite")`, `r figure_nums("srv_agecomp1",display="cite")`, `r figure_nums("srv_agecomp2",display="cite")`,  `r figure_nums("fsh_agecomp1",display="cite")`,  `r figure_nums("fsh_agecomp2",display="cite")`). 

`r table_nums("Mcomparison",display="cite")` indicates that the ABC values from Model 18.2 for `r thisyr+1` would be `r formatC(1000*(extra_sd2$ABC_HM[1]-extra_sd1$ABC_HM[1]),format="d",big.mark=",")` t (13%) higher than the 2020 value projected by Model 18.1a. This is due to the higher biomass estimate resulting from an increased value of male natural mortality in Model 18.2. Model 18.2 also provided a slightly better fit to survey biomass, but this effect was primarily noticeable during the years 1988-1995. Overall Model 18.2 provided very little change in the fit to survey biomass (`r figure_nums("srvbio_fit",display="cite")`). 

Given the uncertainty of the productivity of Yellowfin Sole at low spawning stock sizes, and because the AFSC policy for reference point time-series selection is to use the post 1977 regime shift values unless there is a compelling reason to do otherwise, the productivity of Yellowfin Sole in these models were estimated by fitting the 1977-`r thisyr-6` spawner-recruit data (Ricker 1958). The resulting stock recruitment curves are very similar for Models 18.1a and 18.2 (`r figure_nums("ricker1",display="cite")` and `r figure_nums("ricker2",display="cite")`).  

Posterior distributions of several key parameters in the model capture variability in posterior distributions of parameter estimates and differences between Model 18.2 and Model 18.1a (`r figure_nums("mcmcplots",display="cite")`). Model 18.2 resulted in higher estimates for $B_{MSY}$, total and age 6 biomass and female spawning biomass and recruitment, but similar values to Model 18.1a for $F_{MSY}$. The posterior distribution for female spawning biomass is above the Model 18.2 estimate for $B_{MSY}$ (`r figure_nums("mcmcplots",display="cite")`).

The full-selection fishing mortality, $F$, has averaged `r round(mean(YFS2$F_m[61:65,18]),4)` over the period 2014-2018 (`r table_nums("fmort",display="cite")`). Model estimated survey selectivities (`r figure_nums("srvsel",display="cite")`) show very little difference between Model 18.2 and 18.1a. Both models indicate that both sexes of Yellowfin Sole are 50% selected by the fishery at about age 9 and nearly fully selected by age 13, with annual variability. 

```{r, echo=FALSE, message=FALSE}


YFS2019=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.rep")
YFS2018retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.rep")
YFS2017retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.rep")
YFS2016retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.rep")
YFS2015retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.rep")
YFS2014retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.rep")
YFS2013retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.rep")
YFS2012retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.rep")
YFS2011retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.rep")
YFS2010retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.rep")
YFS2009retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.rep")


a=-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2]
b=-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2]
c=-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2]
d=-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2]
e=-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2]
f=-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2]
g=-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2]
h=-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2]
i=-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2]
j=-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2]

Rho=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

thisyr=2019

#repeat with accepted model

YFS2019a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_0.rep")
YFS2018retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_1.rep")
YFS2017retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_2.rep")
YFS2016retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_3.rep")
YFS2015retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_4.rep")
YFS2014retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_5.rep")
YFS2013retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_6.rep")
YFS2012retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_7.rep")
YFS2011retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_8.rep")
YFS2010retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_9.rep")
YFS2009retro_a=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_10.rep")


a=-1*(YFS2019a$SSB[1:65,2]-YFS2018retro_a$SSB[1:65,2])/YFS2019a$SSB[1:65,2]
b=-1*(YFS2019a$SSB[1:64,2]-YFS2017retro_a$SSB[1:64,2])/YFS2019a$SSB[1:64,2]
c=-1*(YFS2019a$SSB[1:63,2]-YFS2016retro_a$SSB[1:63,2])/YFS2019a$SSB[1:63,2]
d=-1*(YFS2019a$SSB[1:62,2]-YFS2015retro_a$SSB[1:62,2])/YFS2019a$SSB[1:62,2]
e=-1*(YFS2019a$SSB[1:61,2]-YFS2014retro_a$SSB[1:61,2])/YFS2019a$SSB[1:61,2]
f=-1*(YFS2019a$SSB[1:60,2]-YFS2013retro_a$SSB[1:60,2])/YFS2019a$SSB[1:60,2]
g=-1*(YFS2019a$SSB[1:59,2]-YFS2012retro_a$SSB[1:59,2])/YFS2019a$SSB[1:59,2]
h=-1*(YFS2019a$SSB[1:58,2]-YFS2011retro_a$SSB[1:58,2])/YFS2019a$SSB[1:58,2]
i=-1*(YFS2019a$SSB[1:57,2]-YFS2010retro_a$SSB[1:57,2])/YFS2019a$SSB[1:57,2]
j=-1*(YFS2019a$SSB[1:56,2]-YFS2009retro_a$SSB[1:56,2])/YFS2019a$SSB[1:56,2]

#accepted model rho
Rho_a=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

```

A within-model retrospective analysis was included for Model 18.1a and Model 18.2. In this analysis, retrospective female spawning biomass was calculated by sequentially dropping data one year at a time and then comparing the peeled estimate to the reference stock assessment model used in the assessment (`r figure_nums("retro1",display="cite")`, `r figure_nums("retro1_Model18_1a",display="cite")`). Mohn's rho was `r round(Rho,3)` using Model 18.2 and `r round(Rho_a,3)` under Model 18.1a; thus the preferred model resulted in a less negative value. Visually, Model 18.2 shows a similar retrospective pattern to Model 18.1a, although both patterns showed a lower level of spawning biomass than the current year's data in earlier retrospective years (`r figure_nums("retro1",display="cite")`, `r figure_nums("retro1_Model18_1a",display="cite")`). The difference in female spawning biomass was negative for all years, except for the most recent. Model 18.2 improved the retrospective pattern for differences in female spawning biomass (`r figure_nums("retro2",display="cite")`,`r figure_nums("retro2_Model18_1a",display="cite")`).

There is a large amount of variability in the annual survey biomass of Yellowfin Sole due to the temperature-influenced availability to the survey.  This large variability can contribute to undesirable retrospective patterns since earlier years do not fit the same highly variable information as the current year.  In particular, retrospective model runs are outside the confidence intervals of the assessment model spawning biomass trajectory for approximately 17 years from 1986-`r thisyr`.   

In 2017 the Plan Team recommended that the assessment continue to explore the retrospective patterns in relation to $M$ and $q$ by profiling over a range of combinations of $M$ and $q$ and recording the resulting values of Mohn’s rho and also total likelihood.  Profiling over $M$ and $q$ was performed in the 2018 assessment. The best retrospective patterns did not occur at corresponding best model fit values. The retrospective technique may not always be the best tool for model selection, at least for BSAI Yellowfin Sole as there is tension between model fit and good retrospective pattern over the range of parameterization examined.

Given the higher total log likelihood, improved Mohn's rho, and other results discussed above, Model 18.2 is the preferred model for estimating the Yellowfin Sole stock size and management quantities for the `r thisyr+2` fishing season.  

\pagebreak
# Literature Cited

Bakkala, R. G. and V. Wespestad.  1984.  Yellowfin sole.  In R. G. Bakkala and L. resources of the eastern Bering Sea and Aleutian Islands region in 1983, p. 37-60. U.S. Dep. Commer., NOAA Tech. Memo.  NMFS F/NWC-53.

Gunderson, D. R., M. Zimmerman, D. G. Nichol, and K. Pearson. 2003. Indirect estimates of natural mortality rate for arrowtooth flounder (_Atheresthes stomias_) and darkblotched rockfish (_Sebastes crameri_). U.S. National Marine Fisheries Service Fishery Bulletin 101:175–182.

Maunder, M.N. and Wong, R.A., 2011. Approaches for estimating natural mortality: application to summer flounder (_Paralichthys dentatus_) in the US mid-Atlantic. Fisheries Research, 111(1-2), pp.92-99.

Nichol, D.G., 1998. Annual and between-sex variability of yellowfin sole, Pleuronectes aspe. Fishery Bulletin, 96, pp.547-561.

Ricker, W. E.  1958.  Handbook of computations for biological statistics of fish populations.  Bull. Fish. Res. Bd. Can.,  (119) 300 p.

Spies, I. Thomas K. Wilderbuer, Daniel G. Nichol, Jerry Hoff, and Wayne Palsson 2018. Assessment of the arrowtooth flounder stock in the Eastern Bering Sea and Aleutian Islands.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2019.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, AK 99510.

Spies, I., Ianelli, J,. and Palsson, W. 2019a. Assessment of the arrowtooth flounder stock in the Eastern Bering Sea and Aleutian Islands. In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2020.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, AK 99510.

Spies, I., Wilderbuer, T., Nichol, D., and J. Ianelli.  2019b.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2020.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, AK 99510.

Wilderbuer, T. K.  1992.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 1993.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, Ak 99510.

Wilderbuer, T.K. and Turnock, B.J., 2009. Sex-specific natural mortality of arrowtooth flounder in Alaska: Implications of a skewed sex ratio on exploitation and management. North American Journal of Fisheries Management, 29(2), pp.306-322.

Wilderbuer, T., Nichol, D., and J. Ianelli.  2018.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2019, chapter 4.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, AK  99510.

\pagebreak

# Tables


`r table_nums(name = "FSBCI", caption = paste("Model estimates of Yellowfin Sole female spawning biomass (FSB) in metric tons (t) and upper (HCI) and lower (LCI) 95% confidence intervals from the 2019 stock assessment, including Models 18.1a and 18.2."))`
```{r FSBCI, message=FALSE,echo=FALSE}
biom=data.frame(1000*YFS2$SSB[,c(2,4,5)],1000*YFS1$SSB[,c(2,4,5)])
colnames(biom)=c("FSB (t)","LCI","HCI","FSB (t)","LCI","HCI")
rownames(biom)=seq(1954,2019,1)
kable(biom,"latex",booktabs=T,linesep="",format.args=list(format="d",big.mark=","),digits=0,align="r",longtable=TRUE)%>%add_header_above(c(" "=1,"Model 18.2"=3,"Model 18.1a"=3))
```

\pagebreak
`r table_nums(name = "biomCI", caption = paste("Model estimates of Yellowfin Sole age 2+ total biomass (t) from the 2019 stock assessment, Model 18.1a and 18.2, and upper (HCI) and lower (LCI) 95% confidence intervals."))`
```{r biomCI, message=FALSE,echo=FALSE}
biom=data.frame(round(1000*YFS2$TotBiom[,c(2,4,5)]),round(1000*YFS1$TotBiom[,c(2,4,5)]))
colnames(biom)=c("Biomass (t)","LCI","HCI","Biomass (t)","LCI","HCI")
rownames(biom)=seq(1954,2019,1)
kable(biom,"latex",booktabs=T,linesep="",format.args=list(format="d",big.mark=","),longtable=TRUE,align="r")%>%add_header_above(c(" "=1,"Model 18.2"=3,"Model 18.1a"=3))
```

\pagebreak

`r table_nums(name="rec",caption="Model estimates of age 1 recruitment (in billions of fish), 1954-2019, with 95% lower and upper confidence intervals (LCI, HCI) for Model 18.1a and 18.2.")`
```{r rec, message=FALSE,echo=FALSE}
pars1=as.data.frame(read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/fm.std",header=TRUE))
pars2=as.data.frame(read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.std",header=TRUE))

age1recpred1=pars1[533:598,3]
age1recstd1=pars1[533:598,4]

age1recpred2=pars2[534:599,3]
age1recstd2=pars2[534:599,4]

rec=data.frame(age1recpred1,age1recpred1-1.96*age1recstd1,age1recpred1+1.96*age1recstd1,age1recpred2,age1recpred2-1.96*age1recstd2,age1recpred2+1.96*age1recstd2)

rownames(rec)=seq(1954,2019,1)
colnames(rec)=c("Recruitment","LCI","HCI","Recruitment","LCI","HCI")
kable(rec,"latex",booktabs=TRUE,linesep="",align="r",digits=3,longtable=TRUE)%>%add_header_above(c("Year"=1,"Model 18.1a"=3,"Model 18.2"=3))

```


\pagebreak 

`r table_nums(name="liketab",caption="Comparison of likelihood values for survey and fishery age, selectivity, survey biomass, recruitment, catchability, and total likelihood for Models 18.1a and 18.2.")`
```{r liketab, echo=FALSE}
totallike2=sum(YFS2$wt_like,YFS2$age_likeihood_for_survey,YFS2$age_likelihood_for_fishery,YFS2$catch_likelihood,YFS2$selectivity_likelihood,YFS2$survey_likelihood,YFS2$recruitment_likelilhood) #recommended
totallike1=sum(YFS1$wt_like,YFS1$age_likeihood_for_survey,YFS1$age_likelihood_for_fishery,YFS1$catch_likelihood,YFS1$selectivity_likelihood,YFS1$survey_likelihood,YFS1$recruitment_likelilhood)  
```

\begin{table}[h]
\centering
\begin{tabular}{ lrr }
\hline
 Likelihood component & Model $18.1a$ & Model $18.2$ \\
\hline
Survey age	        &       `r round(YFS1$age_likeihood_for_survey,2)`  &  `r round(YFS2$age_likeihood_for_survey,2)`   \\
Fishery age  	  &       `r round(YFS1$age_likelihood_for_fishery,2)` &  `r round(YFS2$age_likelihood_for_fishery,2)`  \\
Selectivity     &       `r round(sum(YFS1$selectivity_likelihood),2)`& `r round(sum(YFS2$selectivity_likelihood),2)`\\
Survey biomass     &       `r round(YFS1$survey_likelihood,2)`& `r round(YFS2$survey_likelihood,2)`\\
Recruitment     &       `r round(sum(YFS1$recruitment_likelilhood),2)`& `r round(sum(YFS2$recruitment_likelilhood),2)`  \\
Catchability & `r round(YFS1$catch_likelihood,4)` & `r round(YFS2$catch_likelihood,4)` \\
\hline
Total              &       `r round(totallike1,2)`      &`r round(totallike2,2)`      \\ 
\hline
\end{tabular}
\end{table}


\pagebreak

`r table_nums(name="Mcomparison",caption="Comparison of reference points for Model 18.2 and 18.1a. Values are in metric tons (t).")`

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 18.2}  & \multicolumn{2}{c}{Model 18.1a}              \\
        Quantity & `r thisyr+1`      &`r thisyr+2`   & `r thisyr+1`      &`r thisyr+2`\\ 
  \hline
$M$ (natural mortality rate)         &  0.12, 0.135   & 0.12, 0.135  &  0.12   &  0.12   \\
Tier                                  &  1a   &  1a   &  1a   & 1a  \\
Projected total (age 6+) biomass (t)  &  `r formatC(extra_sd2$GM_Biom[1]*1000,format="d",big.mark=",")`   &  `r formatC(extra_sd2$GM_Biom[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$GM_Biom[2]*1000,format="d",big.mark=",")` \\
Projected female spawning biomass (t) &  `r formatC(extra_sd2$SSB[1]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd2$SSB[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$SSB[2]*1000,format="d",big.mark=",")` \\
$\:\:\:\:\:\:B_{100\%}$                           &  `r B0_2`  &  `r B0_2`  &  `r B0_1`  & `r B0_1` \\
$\:\:\:\:\:\:B_{MSY\%}$                            &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")` \\
$F_{OFL}$                             &  `r round(extra_sd2$AM_Fmsyr[1],3)`   &  `r round(extra_sd2$AM_Fmsyr[2],3)`   &  `r round(extra_sd1$AM_Fmsyr[1],3)`  & `r round(extra_sd1$AM_Fmsyr[2],3)`  \\
$maxF_{ABC}$                          &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &   `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`    & `r round(extra_sd1$HM_Fmsyr[2],3)`   \\
$F_{ABC}$                             &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &  `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`   & `r round(extra_sd1$HM_Fmsyr[2],3)`   \\
$OFL$                                 &  `r formatC(1000*extra_sd2$OFL_AM[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$OFL_AM[2],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$OFL_AM[2],format="d",big.mark=",")` 
\\
$maxABC$                              &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") `  \\
$ABC$                                 &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") ` & `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") ` \\
\hline
Status                               & `r thisyr-1`       & `r thisyr`      &  `r thisyr-1`             & `r thisyr`    \\
\hline
Overfishing                           & No         & n/a       & No                        & n/a    \\
Overfished                           & n/a         & No       & n/a                        & No        \\
Approaching overfished               & n/a         & No       & n/a                        & No       \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections for Model 18.1a and 18.2 were based on estimated catches of 118,642 t in `r thisyr` and `r formatC(cn10,format="d",big.mark=",")` used in place of maximum ABC for `r thisyr+1`.
  \end{tablenotes}
\end{table}

\pagebreak

`r table_nums(name="fmort",caption="Model estimates of Yellowfin Sole full selection fishing mortality (F) and exploitation rate (catch/total biomass).")`
```{r, echo = FALSE, results = 'asis', warning = F}
fm=data.frame(cbind(YFS2$F_f[,18],YFS2$Obs_catch/YFS2$TotBiom[,2],cbind(YFS1$F_f[,18],YFS1$Obs_catch/YFS1$TotBiom[,2])))

colnames(fm)=c("Full selection F","Catch/Total Biomass","Full selection F","Catch/Total Biomass")
rownames(fm)=seq(1954,2019,1)
kable(fm,"latex",booktabs=TRUE,linesep="",align="r",digits=3,longtable=TRUE)%>%add_header_above(c(" "=1,"Model 18.2"=2,"Model 18.1a"=2))
```



\newpage

# Figures

```{r plotq, message=FALSE,echo=FALSE}
    df <- data.frame( Year    = YFS2$yrs_srv )
    df$Model <- "Model 18.2"
    df$q_srv   <- YFS2$q_srv 
    
    df1 <- data.frame( Year    = YFS1$yrs_srv )
    df1$Model <- "Model 18.1a"
    df1$q_srv   <- YFS1$q_srv 
    
    df2=data.frame(rbind(df1,df))
    
    ggplot(df2) +geom_line(aes(x = Year, y = q_srv, col = Model),size=1.2)+ 
        labs(x = "Year", y = "Survey catchability")+theme_bw()

```
`r figure_nums(name="plotq",caption = paste("Survey catchability for Model 18.1a and 18.2, 1982-",thisyr,".",sep=""))`

\pagebreak
```{r sexratio,message=FALSE,echo=FALSE}
        df <- data.frame(rowSums(YFS2$natage_f)/rowSums(YFS2$natage_f+YFS2$natage_m))
        df$Model <- "Model 18.2"
        df$Year=YFS2$Yr
        colnames(df)=c("Sex_Ratio","Model","Year")
        
        df1 <- data.frame(rowSums(YFS1$natage_f)/rowSums(YFS1$natage_f+YFS1$natage_m))
        df1$Model <- "Model 18.1a"
        df1$Year=YFS2$Yr

        colnames(df1)=c("Sex_Ratio","Model","Year")
        df2=rbind(df1,df)
        
        ggplot(df2) + geom_point(data=df2, aes(x = Year, y = Sex_Ratio,color=Model),size=3)+labs(xlab = "Year", ylab = "Proportion female")+
          ylab("Proportion Female")+theme_bw()

```
`r figure_nums(name="sexratio",caption = paste("Model estimates of the proportion of female Yellowfin Sole in the population, 1982-",thisyr,".",sep=""))`

\pagebreak

```{r srv_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
#Survey
nages=20
dff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")+ggtitle("Fit to Survey Age Compositions, Model 18.1a")
```

`r figure_nums(name="srv_agecomp1",caption=paste("Model 18.1a fit to the time-series of survey age composition, by sex, 1979-",thisyr-1,".",sep=""))`

\pagebreak
```{r srv_agecomp2, message=FALSE,echo=FALSE,fig.height=7.5}
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")+ggtitle("Fit to Survey Age Compositions, Model 18.2")

```

`r figure_nums(name="srv_agecomp2",caption=paste("Model 18.2 fit to the time-series of survey age composition, by sex, 1979-",thisyr-1,".",sep=""))`



\pagebreak

```{r fsh_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +ggtitle("Fit to Fishery Age Compositions, Model 18.1a")

```

`r figure_nums(name="fsh_agecomp1",caption=paste("Model 18.1a fit to the time-series of fishery age composition, by sex, 1975-",thisyr-1,".",sep=""))`

\pagebreak

```{r fsh_agecomp2,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +ggtitle("Fit to Fishery Age Compositions, Model 18.2")

```

`r figure_nums(name="fsh_agecomp2",caption=paste("Model 18.2 fit to the time-series of fishery age composition, by sex, 1975-",thisyr-1,".",sep=""))`

\pagebreak

```{r srvbio_fit, message=FALSE, echo=FALSE}  
#fit to survey biomass
LCI=YFS1$ob_bts-1.96*YFS1$sd_ob_bts
HCI=YFS1$ob_bts+1.96*YFS1$sd_ob_bts
srv_bio1=data.frame(cbind(YFS1$yrs_srv,YFS1$ob_bts,YFS1$sd_ob_bts,LCI,HCI,YFS1$pred_srv[29:66]))
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio2=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI,YFS2$pred_srv[29:66]))
srv_bio3=rbind(srv_bio1,srv_bio2)
Model=c(rep("Model 18.1a",nrow(srv_bio1)),rep("Model 18.2",nrow(srv_bio1)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","Model")

ggplot(data=srv_bio4,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

```
`r figure_nums(name="srvbio_fit",caption = paste("NMFS eastern Bering Sea survey biomass estimates (black line), with 95% confidence intervals and Model 18.1a and Model 18.2 fit to survey biomass estimates,  from 1982-",thisyr,".",sep=""))`



\pagebreak

```{r ricker1,echo=FALSE,message=FALSE}

 df <- data.frame(YFS1$SRR_SSB)
 df$Year <- YFS1$Year
 df$rhat <- YFS1$rechat
 df$rhat.sd <- YFS1$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS1$Yr[60:66],YFS1$SSB[60:66,2],(YFS1$natage_f[60:66,1]+YFS1$natage_m[60:66,1]))
  df3=data.frame(YFS1$Yr[25:60],YFS1$SSB[25:60,2],(YFS1$natage_f[25:60,1]+YFS1$natage_m[25:60,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, billions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.1a")+theme_bw()
 
```
`r figure_nums(name="ricker1",caption = paste("Ricker stock recruitment curve for Model 18.1a with 95% confidence intervals (shaded region) fit to female spawning biomass and recruitment data from 1978-2013. Years in black indicate data used to fit the model.",sep=""))`


\pagebreak
```{r ricker2,echo=FALSE,message=FALSE}

 df <- data.frame(YFS2$SRR_SSB)
 df$Year <- YFS2$Year
 df$rhat <- YFS2$rechat
 df$rhat.sd <- YFS2$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS2$Yr[60:66],YFS2$SSB[60:66,2],(YFS2$natage_f[60:66,1]+YFS2$natage_m[60:66,1]))
  df3=data.frame(YFS2$Yr[25:60],YFS2$SSB[25:60,2],(YFS2$natage_f[25:60,1]+YFS2$natage_m[25:60,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, billions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.2")+theme_bw()
 
```
`r figure_nums(name="ricker2",caption = paste("Ricker stock recruitment curve for Model 18.2 with 95% confidence intervals (shaded region) fit to female spawning biomass and recruitment data from 1978-2013. Years in black indicate data used to fit the model.",sep=""))`

\pagebreak

```{r mcmcplots, message=FALSE, echo=FALSE}
hdr <- read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/data/hdr.dat",as.is=T,header=F)
mctmp2.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/evalout_YFIN.rep",col_names=FALSE)
mctmp1.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/evalout_YFIN.rep",col_names=FALSE)
names(mctmp1.df) <- hdr
names(mctmp2.df) <- hdr
mcdat=rbind(mctmp1.df,mctmp2.df)
mcdat$Model=c(rep("Model 18.1a",nrow(mctmp1.df)),rep("Model 18.2",nrow(mctmp1.df)))

p1=ggplot(data=mcdat, aes(x=Fmsyr,fill=Model)) + geom_density(aes(x=Fmsyr),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Fmsy") + xlim(c(0,.3))+theme_bw()+ylab("Density")

p2=ggplot(data=mcdat, aes(x=1000*Bmsy,fill=Model)) + geom_density(aes(x=Bmsy),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Bmsy (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(100,1300))

p3=ggplot(data=mcdat, aes(x=ln_mean_R,fill=Model)) + geom_density(aes(x=ln_mean_R),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("log(mean(Recruitment))x10^9") +theme_bw()+ylab("Density")

p4=ggplot(data=mcdat, aes(x=ABC_biom6,fill=Model)) + geom_density(aes(x=ABC_biom6),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Age 6 Biomass (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(1000,7000))

p5=ggplot(data=mcdat, aes(x=SSB_2019,fill=Model)) + geom_density(aes(x=SSB_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("FSB (x1,000 t)") +theme_bw()+ylab("Density")+geom_vline(xintercept=(Bmsy_this/1000))+xlim(c(300,1400))

p6=ggplot(data=mcdat, aes(x=TotBiom_2019,fill=Model)) + geom_density(aes(x=TotBiom_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Total Biomass (x10^9 t)") +theme_bw()+ylab("Density")

grid.arrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```
`r figure_nums(name="mcmcplots",caption="MCMC posterior distributions for Fmsy, Bmsy, log(mean(Recruitment)), Age 6 biomass, female spawning biomass (FSB) for 2019, and total biomass for 2019.")`


\pagebreak
```{r srvsel, echo=FALSE, message=FALSE}
srvsel2=data.frame(cbind(seq(1,20,1),YFS2$sel_srv_f,YFS2$sel_srv_m))
colnames(srvsel2)=c("Age","Female","Male")
p2=ggplot(data=srvsel2)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.2")

srvsel1=data.frame(cbind(seq(1,20,1),YFS1$sel_srv_f,YFS1$sel_srv_m))
colnames(srvsel1)=c("Age","Female","Male")
p1=ggplot(data=srvsel1)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.1a")

grid.arrange(p1, p2, ncol = 1)


```

`r figure_nums(name="srvsel",caption = "Estimate of survey selectivity for males and females, Model 18.1a upper panel, Model 18.2 lower panel.")`

\pagebreak
```{r retro1, echo=FALSE, message=FALSE}
#this one is for Model 18.2
#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#retrospective

std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.std")
std2009=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.std")


ret18=data.frame(cbind(c(1954:2018),YFS2018retro$SSB[,2],YFS2018retro$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018retro$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017retro$SSB[,2],YFS2017retro$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017retro$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016retro$SSB[,2],YFS2016retro$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016retro$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015retro$SSB[,2],YFS2015retro$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015retro$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014retro$SSB[,2],YFS2014retro$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014retro$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013retro$SSB[,2],YFS2013retro$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013retro$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012retro$SSB[,2],YFS2012retro$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012retro$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011retro$SSB[,2],YFS2011retro$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011retro$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010retro$SSB[,2],YFS2010retro$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010retro$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))

ret09=data.frame(cbind(c(1954:2009),YFS2009retro$SSB[,2],YFS2009retro$SSB[,2]+1.96*as.numeric(as.vector(std2009[['V4']][531:586])),YFS2009retro$SSB[,2]-1.96*as.numeric(as.vector(std2009[['V4']][531:586]))))


retro=as.data.frame(rbind(ret09,ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))


print(p)

```
`r figure_nums(name="retro1",caption = paste("Retrospective plot of female spawning biomass. The preferred model with data through ",thisyr," is shown, and data was sequentially removed through ",thisyr-10,", based on Model 18.2.",sep=""))`

\pagebreak


```{r retro1_Model18_1a, echo=FALSE, message=FALSE}

#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#retrospective

std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_0.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_1.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_2.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_3.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_4.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_5.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_6.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_7.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_8.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_9.std")
std2009=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/retro/r_10.std")


ret18=data.frame(cbind(c(1954:2018),YFS2018retro$SSB[,2],YFS2018retro$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018retro$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017retro$SSB[,2],YFS2017retro$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017retro$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016retro$SSB[,2],YFS2016retro$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016retro$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015retro$SSB[,2],YFS2015retro$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015retro$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014retro$SSB[,2],YFS2014retro$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014retro$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013retro$SSB[,2],YFS2013retro$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013retro$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012retro$SSB[,2],YFS2012retro$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012retro$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011retro$SSB[,2],YFS2011retro$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011retro$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010retro$SSB[,2],YFS2010retro$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010retro$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))

ret09=data.frame(cbind(c(1954:2009),YFS2009retro$SSB[,2],YFS2009retro$SSB[,2]+1.96*as.numeric(as.vector(std2009[['V4']][531:586])),YFS2009retro$SSB[,2]-1.96*as.numeric(as.vector(std2009[['V4']][531:586]))))


retro=as.data.frame(rbind(ret09,ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))


print(p)

```
`r figure_nums(name="retro1_Model18_1a",caption = paste("Retrospective plot of female spawning biomass. The preferred model with data through ",thisyr," is shown, and data was sequentially removed through ",thisyr-10,", based on Model 18.1a.",sep=""))`

\pagebreak
```{r retro2, echo=FALSE,message=FALSE}
#plot differences
Years=c(c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010),c(1954:2009))


Difference=c(-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2],
-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2],
-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2],
-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2],
-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2],
-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2],
-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2],
-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2],
-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2],
-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2])



Year=(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)

ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))
```
`r figure_nums(name="retro2",caption = paste("Relative differences in estimates of spawning biomass between the ",thisyr," model and the retrospective model run for years ",thisyr-1," through ",thisyr-10,", based on 18.2.",sep=""))`

\pagebreak
```{r retro2_Model18_1a, echo=FALSE,message=FALSE}
#plot differences
Years=c(c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010),c(1954:2009))


Difference=c(-1*(YFS2019a$SSB[1:65,2]-YFS2018retro_a$SSB[,2])/YFS2019a$SSB[1:65,2],
-1*(YFS2019a$SSB[1:64,2]-YFS2017retro_a$SSB[,2])/YFS2019a$SSB[1:64,2],
-1*(YFS2019a$SSB[1:63,2]-YFS2016retro_a$SSB[,2])/YFS2019a$SSB[1:63,2],
-1*(YFS2019a$SSB[1:62,2]-YFS2015retro_a$SSB[,2])/YFS2019a$SSB[1:62,2],
-1*(YFS2019a$SSB[1:61,2]-YFS2014retro_a$SSB[,2])/YFS2019a$SSB[1:61,2],
-1*(YFS2019a$SSB[1:60,2]-YFS2013retro_a$SSB[,2])/YFS2019a$SSB[1:60,2],
-1*(YFS2019a$SSB[1:59,2]-YFS2012retro_a$SSB[,2])/YFS2019a$SSB[1:59,2],
-1*(YFS2019a$SSB[1:58,2]-YFS2011retro_a$SSB[,2])/YFS2019a$SSB[1:58,2],
-1*(YFS2019a$SSB[1:57,2]-YFS2010retro_a$SSB[,2])/YFS2019a$SSB[1:57,2],
-1*(YFS2019a$SSB[1:56,2]-YFS2009retro_a$SSB[,2])/YFS2019a$SSB[1:56,2])



Year=(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)

ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))
```
`r figure_nums(name="retro2_Model18_1a",caption = paste("Relative differences in estimates of spawning biomass between the ",thisyr," model and the retrospective model run for years ",thisyr-1," through ",thisyr-10,", based on 18.1a.",sep=""))`


 