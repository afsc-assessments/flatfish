---
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
---

---
header-includes:
 \usepackage{booktabs}
 \usepackage{float}
 \usepackage{graphicx}
 \usepackage{floatrow}
 \usepackage{caption}
 \usepackage{subcaption}
 \usepackage{subfigure}
geometry:
  left=1in,right=1in,top=1in,bottom=1in
---

```{r global options, include=FALSE, message=FALSE}
library(adnuts)
library(ggplot2)
library(RColorBrewer)
library(doBy)
library(tidyr)
library(dplyr)
library(gridExtra)
library(tidyverse)
library(purrr)
library(stringr)
library(ggplot2)
library(knitr)
library(kableExtra)
options(knitr.kable.NA = '')
knitr::opts_knit$set(root.dir = '../../' )
library(captioner)
library(bibtex)
library(knitcitations)
library(cowplot)
library(magick)
library(bookdown)
library(ggthemes)
library(scales)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
require(knitr)
library(tidyverse)
library(lubridate)
library(ggmap)
library(widyr)
#install.packages("formattable")
#install.packages("formattable")
library(flextable)
library(officer)

require(kfigr) # devtools::install_github("github mkoohafkan/kfigr")
opts_chunk$set(message=FALSE, warning=FALSE)

table_nums <- captioner::captioner(prefix = "Table 4.",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure 4.",levels = 1, auto_space = FALSE)

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")
#clean_cache(clean = TRUE)

thisyr    = 2021


#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/prelims.R")
source("/Users/ingridspies/admbmodels/Katch/assessments/R/read-rep.R")
#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/plot_m.R")
YFS0=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/fm.rep")
YFS1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m1/fm.rep")#this is single natural mortality.
YFS2=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.rep")#this is the preferred model. Male M is estimated.
YFS3=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m3/fm.rep")#this is with EBS vast
YFS4=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m4/fm.rep")#this is with EBS+NBSvast

extra_sd2=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/ABC_OFL.rep",header=TRUE)
extra_sd1=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m1/ABC_OFL.rep",header=TRUE)
extra_sd3=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m3/ABC_OFL.rep",header=TRUE)
extra_sd4=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m4/ABC_OFL.rep",header=TRUE)
extra_sd0=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/extra_sd.rep",header=TRUE)
B0_2=formatC(1000*YFS2$Bzero,format="d",big.mark=",")
B0_1=formatC(1000*YFS1$Bzero,format="d",big.mark=",")
B0_0=formatC(1000*YFS0$Bzero,format="d",big.mark=",")
B0_3=formatC(1000*YFS3$Bzero,format="d",big.mark=",")
B0_4=formatC(1000*YFS4$Bzero,format="d",big.mark=",")

ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_next=1000*extra_sd2$ABC_HM[1]
TotBio_this=extra_sd2$GM_Biom[1]*1000
TotBio_next=extra_sd2$GM_Biom[2]*1000

femcat=YFS2$catage_f/rowSums(YFS2$catage_f)
malcat=YFS2$catage_m/rowSums(YFS2$catage_m)

#Base version M0.34,with fishlenlikelihood, stark mat
bigfile=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/bigfile.out",header=TRUE)

percentiles=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/percentiles.out",nrows =1,header=TRUE)

percentdb=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/percentdb.out")

PABC_this=1000*mean(bigfile$ABC[which(bigfile$Yr==2021&bigfile$Alternative==1)])#average catch 
PABC_thisF=formatC(PABC_this,format="d",big.mark=",")  #pmeans from proejction

PABC_next=1000*mean(bigfile$ABC[which(bigfile$Yr==2021&bigfile$Alternative==1)])       
PABC_nextF=formatC(PABC_next,format="d",big.mark=",")

ABC_last=1000*extra_sd1$ABC_HM[1]
ABC_lastF=formatC(ABC_last,format="d",big.mark=",")
ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_thisF=formatC(ABC_this,format="d",big.mark=",")

ABC_next=1000*extra_sd2$ABC_HM[2]
ABC_nextF=formatC(ABC_next,format="d",big.mark=",")

OFL_this=1000*extra_sd2$OFL_AM[1]
OFL_thisF=formatC(OFL_this,format="d",big.mark=",")

OFL_next=1000*extra_sd2$OFL_AM[2]
OFL_nextF=formatC(OFL_next,format="d",big.mark=",")

TotBio_this=1000*extra_sd2$GM_Biom[1]
TotBio_thisF=formatC(TotBio_this,format="d",big.mark=",")

TotBio_next=1000*extra_sd2$GM_Biom[2]
TotBio_nextF=formatC(TotBio_next,format="d",big.mark=",")

TotBio_last=1000*extra_sd1$GM_Biom[1]
TotBio_lastF=formatC(TotBio_last,format="d",big.mark=",")

FSB_this=1000*extra_sd2$SSB[1]
FSB_thisF=formatC(FSB_this,format="d",big.mark=",")

FSB_next=1000*extra_sd2$SSB[2]
FSB_nextF=formatC(FSB_next,format="d",big.mark=",")

FSB_last=1000*extra_sd1$SSB[1]

FSB_lastF=formatC(FSB_last,format="d",big.mark=",")

FABC_this=round(extra_sd2$HM_Fmsyr[1],3)

FABC_next=round(extra_sd2$HM_Fmsyr[2],3)

FOFL_this=round(extra_sd2$AM_Fmsyr[1],3)
FOFL_next=round(extra_sd2$AM_Fmsyr[2],3)

Bmsy_this=1000*extra_sd2$Bmsy[1]
Bmsy_thisF=formatC(Bmsy_this,format="d",big.mark=",")

Bmsy_next=1000*extra_sd2$Bmsy[2]
Bmsy_nextF=formatC(Bmsy_next,format="d",big.mark=",")

#this came from AKFIN and I checked that it was same as downloaded from obsint.
catmo=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/norpac_age_report_YFS_10_1_20.csv",header=TRUE)

#AKFIN groundfish total catch only YFS selected and Bering Sea
YFS_catch1=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2021/GroundfishTotalCatch_YFS_10_1_21_1991_2021.csv",header=TRUE)

#AKFIN total catch by fishery all fisheries selected and YFS
YFS_catch=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2021/GroundfishTotalCatchbyFishery_YFS_10_1_21_1991_2021.csv",header=TRUE)

prop=sum(YFS_catch$Catch..mt.[which(YFS_catch$Month<11&YFS_catch$Year<2021&YFS_catch$Year>2015)],na.rm=TRUE)/sum(YFS_catch$Catch..mt.[which(YFS_catch$Year<2021&YFS_catch$Year>2015)],na.rm=TRUE)

#How about survey biomass?
srv_bio=read.csv("/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2021/survey/flatfish_biomass_ebs_plusnw.csv",header=TRUE)
srv_bio1=data.frame(cbind(c(seq(1987,2019,1),2021),srv_bio$BIOMASS[which(srv_bio$STRATUM==999&srv_bio$SPECIES_CODE==10210)]))
srv_bio1[34,]=c(2020,0)
colnames(srv_bio1)=c("Year","Biomass")
srv_bio1=rbind(srv_bio1,c(2021,1622913))
#estimate catch
yrz=seq(1987,2021,1)
Catch=vector()
for(i in 1:length(yrz)){
  Catch[i]=sum(YFS_catch$Catch..mt.[which(YFS_catch$Year==yrz[i])])
}
Catch[35]=95195

srv_bio2=data.frame(cbind(srv_bio1,Catch*15))[5:35,]
library(reshape2)
srv_bio3=melt(srv_bio2,id="Year")
ggplot(srv_bio3)+geom_line(aes(x=Year,y=value,color=variable))+theme_bw()

#88851.15t caught by Oct1, 2021
#93.33603% caught by Oct1 for yrs 2016-2020.
#extrapolate to 95194.91 t.

#proportion caught before November 2015-2019 (was 93.1 for 2015-2019) first way has more data.
#prop=sum(catmo$Weight..kg.[which(catmo$Month<11&catmo$Year2<2020&catmo$Year2>2014)],na.rm=TRUE)/sum(catmo$Weight..kg.[which(catmo$Year2<2020&catmo$Year2>2014)],na.rm=TRUE)

catchZ=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/catch_YFS.csv",header=TRUE,skip=1)

c10=catchZ$Total[(nrow(catchZ)-10):(nrow(catchZ)-1)]
cn=str_replace(c10, ",", "")
cn10=mean(as.numeric(cn))#average catch last 10 years
```



---
title: 'Assessment of the Yellowfin Sole Stock\ in the Bering Sea and Aleutian Islands'

output:
  pdf_document: 
  highlight: zenburn
  html_document: default
---


\begin{centering}
\fontfamily{cmr}
\fontsize{10}{12}
  Ingrid Spies, Rebecca Haehn, Elizabeth Siddon, Jason Conner, Lyle Britt and James Ianelli\\
\selectfont
  Alaska Fisheries Science Center, National Marine Fisheries Service \\
  National Oceanic and Atmospheric Administration \\ 
  7600 Sand Point Way NE., Seattle, WA 98115-6349 \\
  {`r format(Sys.time(), '%d %B, %Y')`}\\
\end{centering}

#  Executive summary

_Summary of changes in assessment inputs_

Relative to last year’s Bering Sea and Aleutian Islands (BSAI) SAFE report, the following substantive changes have been made to the BSAI Yellowfin Sole assessment. Despite no new survey data, several models are presented in this document that incorporate new data since the last full assessment in 2019.

_Changes in the data_

   1. The `r thisyr-1` fishery age composition was added.
   2. The `r thisyr-1` survey age composition was added.
   3. The estimate of the total catch made through the end of 2019 was updated as reported by the NMFS Alaska Regional office. The catch through the end of 2020 was estimated based on available data. Catch of 139,283 t was assumed for the `r thisyr+1` and `r thisyr+2` projections.
   4. Due to COVID-19, the 2020 NMFS Eastern Bering Sea (EBS) shelf bottom-trawl survey was not conducted. Therefore, there is no survey biomass estimate from 2020.
   5. Fishery weight-at-age was calculated based on methodology in the document.

_Changes in the assessment methods_

Four models are presented in this assessment. Models 18.1 and 18.2 are presented in full, and Model 18.2 is the preferred model. Models 18.3 and 18.4 are presented to promote discussion on the use of VAST biomass estimates and incorporation of the Northern Bering Sea (NBS) survey.

   1. Last year's accepted model is referred to as Model 18.1. This model has not changed and uses the same natural mortality for males and females, $M$=0.12. 
   2. A second model is presented (Model 18.2) that uses a fixed value for female natural mortality ($M$=0.12) and allows male natural mortality to be estimated within the model. This model was reviewed by the BSAI Plan Team in September, 2020. Model 18.2 is the authors' preferred model. 
   3. Model 18.3 is the same as Model 18.2 except it incorporates VAST biomass estimates and standard errors for the Eastern Bering Sea survey region, 1982-2019.
   4. Model 18.4 is the same as Model 18.2 except it incorporates VAST biomass estimates and standard errors for the EBS and NBS, 1982-2019.

## Summary of Results

   
The accepted 2019 Model 18.1 included the survey mean bottom temperature across stations < 100m as a covariate on survey catchability, as in previous years, but added survey start date as an additional covariate within the model, based on a recent study by Nichol et al. (2019). Model 18.2 retains these features. Model 18.2 retains female natural mortality fixed at 0.12 while allowing the model to estimate male natural mortality. 

In the most recent Eastern Bering Sea (EBS) bottom trawl survey performed in 2019, the Yellowfin Sole biomass in the Eastern Bering Sea was estimated to be `r 100*round((YFS2$ob_bts[38]/YFS2$ob_bts[37])-1,2)`% higher than in 2018 at `r formatC(YFS2$ob_bts[38]*1000, format="d",big.mark=",")` t. Spawning biomass estimated by Model 18.2 remained high at `r round(FSB_this/Bmsy_this,2)` * $B_{MSY}$. Therefore, Yellowfin Sole continues to qualify for management under Tier 1a. The 1978-2014 age-1 recruitments and the corresponding spawning biomass estimates were used to fit the stock recruitment curve and determine the Tier 1 harvest recommendations. 

This assessment updates last year’s assessment with results and management quantities that are higher than the `r thisyr-1` assessment. Model 18.2 estimated male natural mortality to be higher than female natural mortality, `r round(YFS2$natmort_m,3)`, which increased biomass estimates.

Catch as of October 13, `r thisyr` was `r catchZ$Total[nrow(catchZ)]` t. Over the past 5 years (`r thisyr-5` - `r thisyr-1`), `r 100*round(prop,3)`% of the catch has taken place by this date. Therefore, the full year's estimate of catch in `r thisyr` was `r formatC(as.numeric(str_replace(catchZ$Total[nrow(catchZ)],",",""))/round(prop,4),format="d",big.mark=",")` t. This is lower than the average catch over the past ten years `r formatC(cn10,format="d",big.mark=",")` t.  Future catch for the next 10 years, `r thisyr+1` - `r thisyr+10` was estimated as the mean of the past 10 years catch.

Yellowfin Sole continue to be above $B_{MSY}$ and the annual harvest remains below the ABC level. Management quantities are given in the following table for the `r thisyr-1` accepted model (Model 18.1) and the `r thisyr` preferred model (Model 18.2). The projected estimate of total biomass for `r thisyr+1` was higher by `r (100*(round(TotBio_this/TotBio_last,2)))-100`% from the `r thisyr-1` assessment of `r TotBio_lastF` t, to `r TotBio_thisF` t. The model projection of spawning biomass for `r thisyr+1`, assuming catch for `r thisyr` as described above, was `r FSB_thisF` t, `r 100*round(FSB_this/FSB_last,2)-100`% higher than the projected `r thisyr` spawning biomass from the `r thisyr-1` assessment of `r FSB_lastF` t. The `r thisyr+1` and `r thisyr+2` ABCs using $F_{ABC}$ from this assessment model were higher than the `r thisyr-1` ABC of `r ABC_lastF` t; `r ABC_thisF` t and `r ABC_nextF` t. The `r thisyr+1` and `r thisyr+2` OFLs estimated by model 18.2 were `r OFL_thisF` t and `r OFL_nextF` t. 

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{As estimated or $\mathit{specified}$ } & \multicolumn{2}{c}{As estimated or $\mathit{recommended}$ }  \\
       & \multicolumn{2}{c|}{$\mathit{last}$ year for:}  & \multicolumn{2}{c}{$\mathit{this}$ year for: }               \\
        Quantity & `r thisyr`      &`r thisyr+1`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
	$M$ (natural mortality rate)	&	0.12	&	0.12	&	0.12, 0.135	&	0.12, 0.135 \\
Tier	&	1a	&	1a	&	1a	&	1a \\
Projected total (age 6+) biomass (t)	& `r formatC(extra_sd1$GM_Biom[1]*1000,format="d",big.mark=",")` t & `r formatC(extra_sd1$GM_Biom[2]*1000,format="d",big.mark=",")` t &	`r TotBio_thisF` t	   &	`r TotBio_nextF` t  \\
Projected female spawning biomass (t) &	`r formatC(extra_sd1$SSB[1]*1000,format="d",big.mark=",")` t	&	`r formatC(extra_sd1$SSB[2]*1000,format="d",big.mark=",")` t	&		`r FSB_thisF` t	         &	`r FSB_nextF` t	 \\
$\:\:\:\:\:\:B_{100\%}$                                 &	1,275,940 t	&	1,275,940 t	&		`r B0_2` t	       &	`r B0_2` t    \\
$\:\:\:\:\:\:B_{MSY\%}$                             &	`r formatC(extra_sd1$Bmsy[1]*1000,format="d",big.mark=",")` t	&	 `r formatC(extra_sd1$Bmsy[2]*1000,format="d",big.mark=",")` t	&		`r Bmsy_thisF` t	     &	`r Bmsy_nextF   ` t		  \\
$F_{OFL}$                             &	`r round(extra_sd1$AM_Fmsyr[1],3)`	      &	`r round(extra_sd1$AM_Fmsyr[2],3)`		      &		`r FOFL_this`	   &	`r FOFL_next`	\\
$maxF_{ABC}$                          & `r round(extra_sd1$HM_Fmsyr[1],3)`		      &	`r round(extra_sd1$HM_Fmsyr[2],3)`		      &	  `r FABC_this`	     &	`r FABC_next`  	\\
$F_{ABC}$                             &	`r round(extra_sd1$HM_Fmsyr[1],3)`      &	`r round(extra_sd1$HM_Fmsyr[2],3)`      &		`r FABC_next`           &	`r FABC_next`        \\
$OFL$    	                            &	`r formatC(extra_sd1$OFL_AM[1]*1000,format="d",big.mark=",")` t	&	`r formatC(extra_sd1$OFL_AM[2]*1000,format="d",big.mark=",")` t	&	  `r OFL_thisF` t          &	`r OFL_nextF` t       \\
$maxABC$    	                        &	`r formatC(extra_sd1$ABC_HM[1]*1000,format="d",big.mark=",")` t	&	`r formatC(extra_sd1$ABC_HM[2]*1000,format="d",big.mark=",")` t	&		`r ABC_thisF ` t      &	`r ABC_nextF ` t   \\
$ABC$ 	                             &	`r formatC(extra_sd1$ABC_HM[1]*1000,format="d",big.mark=",")` t	&	`r formatC(extra_sd1$ABC_HM[2]*1000,format="d",big.mark=",")` t	&		`r ABC_thisF ` t         &	`r ABC_nextF` t       \\
\hline
Status	                              &	`r thisyr-2`	      &	 `r thisyr-1`	      &		`r thisyr-1`             &	`r thisyr`          \\
\hline
Overfishing	                          &	No	        &	n/a	      &	No	                       &	n/a                 \\
Overfished	                          &	n/a	        &	No	      &	n/a	                       &	No                  \\
Approaching overfished	              &	n/a	        &	No	      &	n/a	                       &	No                  \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections were based on estimated catches of `r formatC(as.numeric(str_replace(catchZ$Total[nrow(catchZ)],",",""))/round(prop,4),format="d",big.mark=",")` t in `r thisyr` and `r formatC(cn10,format="d",big.mark=",")` t used in place of maximum ABC for `r thisyr+1`.
\end{tablenotes}
\end{table}

 
## Responses to SSC and Plan Team Comments on Assessments in General

_SSC December 2018_

The SSC requests that all authors fill out the risk table in 2019.

_SSC December 2019_
…risk tables only need to be produced for groundfish assessments that are in ‘full’ year in the cycle. The SSC requests the the GPTs, as time allows, update the risk tables for the 2020 full assessments.

_Plan Team November 2019_
The Teams recommended that authors continue to fill out the risk tables for full assessments. The Teams recommended that adjustment of ABC in response to levels of concern should be left to the discretion of the author, the Team(s), and/or the SSC, but should not be mandated by the inclusion of a >1 level in any particular category. The Teams request clarification and guidance from the SSC regarding the previously noted issues associated with completing the risk table, along with any issues noted by the assessment authors. 

_Authors' response: We have included a risk table in this assessment. We did not recommend adjustment of ABC in response to the risk table._

## Responses to SSC and Plan Team Comments Specific to this Assessment

_Plan Team September 2020_

A Team member noted that the SSC had commented that if _M_ is estimated in the model at a value higher than 0.12, and if the best estimate of the value averaged across both sexes is 0.12, then female _M_ has to be less than 0.12, by about the same amount as the male M exceeds 0.12 (depending on the sex ratio).

The Team requested that both models [18.1 and 18.2] be included for consideration in November.

The Team recommends that, if the authors have time this year or else in the future, they should consider estimating male _M_ freely but with female _M_ adjusted so that the average across sexes is equal to 0.12 

(e.g., $M_{female} = (0.12-(1-P_{female})xM_{male})/P_{female}$, where $P_{female}$ is the proportion of the population that is female).

_Authors' response: We have included Model 18.1 and 18.2 in this assessment. Further changes to female vs. male natural mortality will be explored in future models._

_SSC October 2020_

The SSC agrees that sex-linked mortality is biologically plausible and concurs with the BSAI-GPT’s and authors’ recommendation to bring forward Model 18.2 (in addition to the 18.1 base model) for consideration in the next assessment. 

_Authors' response: We have included Model 18.1 and 18.2 in this assessment._

The SSC notes a couple of long-term development issues with this assessment. A question remains about the timing of the trawl survey relative to the availability of male and female fish, and whether the sex-ratio observed at the time of the survey is influenced by the timing of annual spawning migrations to adjacent inshore areas. Thus, it is questionable that a freely estimated male _M_ is really reflecting the population sex ratio better. For future assessments, the SSC requests the authors consider developing a prior on male _M_ using the literature values and/or fixing the male _M_ based on the literature value. Additionally, the SSC requests the authors investigate whether recent work by Somerton et al. (2018) on wave height, as it relates to gear efficiency, is informative to the parameterization of catchability. 

_Authors' response: This will be investigated in future assessments._

The SSC recommends consideration of including the Northern Bering Sea (NBS) in the modeled area even for species that have low density there now but could increase under shifting environmental conditions. This would avoid another change in the survey analysis paradigm required to extend the modeled area, as has been the case with recent extensions to include the NBS for pollock, Pacific cod and yellowfin sole.

_Authors' response: Two models, 18.3 and 18.4 in the current assessment incorporate VAST estimates, one for the Eastern Bering Sea (EBS) (18.3) and one for the EBS+NBS (18.4)._

_SSC December 2019_

The SSC appreciates the authors’ work on Model 18.2 and looks forward to reviewing a model with sex-specific natural mortality in next year’s cycle. The SSC requested the authors clarify and justify why natural mortality _M_ is estimated in the model for males, rather than for females or both sexes, and whether the value previously used for both sexes combined, _M_=0.12, is appropriate for a single sex.  

_Authors' response:_

* _Allowing the model to freely estimate M was a first step towards examining sex-specific M for Yellowfin Sole._
* _Sex-specific natural mortality is a common feature for flatfish, e.g. Arrowtooth Flounder (Nichol et al. 1998, Wilderbuer and Turnock 2009)._
* _There has consistently been a high proportion of females reported in this species, therefore the data provides more information on female M._
* _Literature values suggest that Female M ranges from 0.10 to 0.33, while Male M ranges from 0.16 to 0.51 (Wilderbuer and Turnock 2009)._
* _We acknowledge that other parameterizations may provide a better fit to the data, but the assumptions in Model 18.2 were made based on the best available information. Future model configurations will to continue to explore split sex natural mortality for Yellowfin Sole._

The SSC appreciates the authors’ initial response concerning the variability in the proportion of the Yellowfin Sole stock that occurs in the Northern Bering Sea. As described in the 2018 SSC minutes, the SSC suggests the application of the VAST model to estimate the proportion of Yellowfin Sole in the NBS over time, as well as an examination of other available data sources, in particular the ADF&G survey in Norton Sound that has been conducted triennially since 1978 and annually since 2017. The SSC continues to encourage the authors to consider approaches for including the substantial biomass of NBS Yellowfin Sole in the model, with the expectation that NBS surveys will be conducted regularly in the future. 

_Authors' response: Two models in the current assessment incorporate VAST estimates, one for the EBS (18.3) and one for the EBS+NBS (18.4). Data from the ADF&G survey is presented in this assessment. _

The SSC suggests the authors consider estimating a single selectivity curve for both sexes since the sex-specific selectivities are so similar. 

_Authors' response: This will be considered in a future assessment. For this assessment, we are attempting to keep the number of models to a minimum to reduce the time required for review under full teleworking._

The SSC requests the authors include an explanation of why the model fit to the survey and the model estimated biomass trends diverge, including what model-estimated process explains the change, whether the process is biologically plausible, and whether this model estimated process could potentially explain the retrospective pattern.  

_Authors' response: This will be investigated in future analyses._

The SSC acknowledges the past work that has been done to resolve the retrospective pattern and recognizes that the models with the best fit are different than those that with the best retrospective pattern. However, the SSC remains concerned about the large retrospective pattern and requests the authors continue to investigate this as they are able. 

_Authors' response: This will continue to be investigated._

The SSC requests that the authors use the model numbering convention in future assessments.

_Authors' response: We will follow naming conventions and will retain the names initiated in 2019 for clarity._

The SSC recommends the authors revisit the fixed values of natural mortality, as the document states the data from which these values are based are from the 1990s.

_Authors' response: This will be investigated in future analyses._

The SSC also noted a number of editorial matters which we were grateful to receive and note that they were corrected for the posted final version.

_Authors' response: Noted._


# Introduction

Yellowfin Sole (_Limanda aspera_) is one of the most abundant flatfish species in the eastern Bering Sea (EBS) and currently is the target of the largest flatfish fishery in the world.  Yellowfin Sole inhabit the EBS shelf and abundance in the Aleutian Islands region is negligible.  

Yellowfin Sole are distributed in North American waters from off British Columbia, Canada, (approx. lat. 49$^{\circ}$N) to the Chukchi Sea (approx. lat. 70$^{\circ}$N) and south along the Asian coast off the South Korean coast in the Sea of Japan (approximately lat. 35$^{\circ}$N).  Adults exhibit a benthic lifestyle and occupy separate spawning areas in winter and feeding distributions in summer on the eastern Bering Sea shelf (`r figure_nums("spawnplot",display="cite")`).  From over-wintering grounds near the shelf margins, adults begin a migration onto the inner shelf in April or early May each year for spawning and feeding. There appears to be several distinct stocks, although the genetic basis remains to be determined. The stocks are referred to as the Unimak group, the Pribilof-west group, and the Pribilof-east group (`r figure_nums("spawnplot",display="cite")`).  Yellowfin Sole are managed as a single stock in the BSAI management area as there is presently no direct evidence of stock structure.

## Fishery     

Yellowfin Sole have been targeted with bottom trawls on the Bering Sea shelf since the fishery began in 1954. They were overexploited by foreign fisheries in 1959-62 when catches averaged 404,000 t annually (`r figure_nums("catchfig",display="cite")`, top panel).  Catches declined to an annual average of 117,800 t from 1963-1971 and further declined to an annual average of 50,700 t from 1972-1977.  The lower yield in this latter period was partially due to the discontinuation of the Union of Soviet Socialist Republics (U.S.S.R.) fishery. In the early 1980s, after the stock condition had improved, catches again increased reaching a peak of over 227,000 t in 1985. Catch of Yellowfin Sole takes place primarily in the eastern Bering Sea, with low levels in the eastern Aleutian Islands.

During the 1980s, there was also a major transition in the characteristics of the fishery. Yellowfin Sole were traditionally taken exclusively by foreign fisheries and these fisheries continued to dominate through 1984.  However, U.S. fisheries developed rapidly during the 1980s in the form of joint ventures, and during the last half of the decade began to dominate and then take all of the catch as the foreign fisheries were phased out of the Eastern Bering Sea.  Since 1990, only domestic harvesting and processing has occurred.  

The management of the Yellowfin Sole fishery changed significantly in 2008 with the implementation of Amendment 80 to the BSAI Fisheries Management Plan.  The Amendment directly allocated fishery resources among BSAI trawl harvesters in consideration of their historic harvest patterns and future harvest needs to improve retention and utilization of fishery resources by the non-AFA (American Fisheries Act) trawl catcher/processor fleet.  This was accomplished by extending the groundfish retention standards to all H&G (headed and gutted, fish are processed with heads and viscera removed) vessels and also by providing the ability to form cooperatives within the newly formed Amendment 80 sector. In addition, Amendment 80 also mandated additional monitoring requirements which included observer coverage on all hauls, motion-compensating scales for weighing samples, flow scales to obtain accurate catch weight estimates for the entire catch, no mixing of hauls and no on-deck sorting.  The partitioning of TAC (total allowable catch) and PSC (prohibited species catch) among cooperatives has significantly changed the way the annual catch has accumulated (`r figure_nums("catchfig",display="cite")`, lower panel) and the rate of target catch per bycatch ton. There is now a more even and slow attainment of the annual catch relative to the pre-Amendment 80 fishing behavior.  

In 2010, following a comprehensive assessment process, the Yellowfin Sole fishery was certified under the Marine Stewardship Council environmental standard for sustainable and well-managed fisheries.  The certification also applies to all the major flatfish fisheries in the BSAI and GOA. 

In 2011, federally permitted vessels using non-pelagic trawl gear whose harvest resulted in flatfish retained catch that was greater than any other retained fishery category were required to use modified trawl gear. The modifications required the use of elevating devices to raise the section of the trawl warps between the doors and the trawl wing tips by 2.5 inches off the seafloor. The purpose of the management action was to reduce damage of non-target animals, particularly those that form habitat structure or support other fisheries while not substantially reducing flatfish catch rates or causing gear handling problems (Rose et al. 2010).

Yellowfin Sole are typically headed and gutted, frozen at sea, and then shipped primarily to China and South Korea. Reprocessed Yellowfin Sole from China may also be sold to Japan, US, and Europe as fillets, among other countries (AFSC 2016). The 1997 catch of 181,389 t (retained and discarded) was the largest since the fishery became completely domestic, but decreased from 1998–2010, averaging 94,004 t (`r table_nums("catch",display="cite")`, `r table_nums("retdis",display="cite")`).  From 2011-2014 the catch increased, averaging 155,000 t. The 2013 catch totaled approximately 165,000 t (73% of the ABC), and was the highest annual catch since prior to 1990. Catches have declined since 2013 and the average catch over the past ten years was `r formatC(cn10,format="d",big.mark=",")` t. The full year's estimate of catch in `r thisyr` was `r formatC(as.numeric(str_replace(catchZ$Total[nrow(catchZ)],",",""))/round(prop,4),format="d",big.mark=",")` t.  

Yellowfin sole accounted for 64% of the retained flatfish catch in 2019 caught in the Eastern Bering Sea by catcher/processors in the Amendment 80 Fleet. The first-wholesale value of Yellowfin Sole showed a 4% decrease to $0.78/pound. Export quantities of Yellowfin Sole increased in 2019 from 2018 and the share of exports to China decreased despite rising export prices (Appendix B, Fissel 2020).  

As of late October `r thisyr`, the fishing season is ongoing.  To estimate the total `r thisyr` catch for the stock assessment model, the average proportion of the `r thisyr-5`-`r thisyr-1` cumulative catch attained by the end of October was applied to the `r thisyr` catch amount at the same time period and resulted in a `r thisyr` catch estimate of `r formatC(as.numeric(str_replace(catchZ$Total[nrow(catchZ)],",",""))/round(prop,4),format="d",big.mark=",")` t, `r round(100*as.numeric(str_replace(catchZ$Total[nrow(catchZ)],",",""))/round(prop,4)/ABC_last,2)`% of the ABC.  

Length distributions of Yellowfin Sole throughout NMFS areas 509, 513, 514, 516, 517, and 524 ranged from 20-50 cm, with a higher proportion of large fish in areas 509 and 517 in the southeastern Bering Sea (`r figure_nums("obs_sizecomp",display="cite")`). Catch proportions of Yellowfin Sole by month and area are shown in `r figure_nums("pie_bymonth",display="cite")`. The primary fishing areas for Yellowfin Sole in `r thisyr` through the end of September were NMFS Areas 513 and 514, and the highest proportion of the catch was taken in February, March, and April. Although catches in July are typically low relative to other months, the catch in July 2020 was almost negligible. Maps of the locations where Yellowfin Sole were caught in `r thisyr`, by month (through mid-September), are shown in `r figure_nums("fishmo",display="cite")`.  The average age of Yellowfin Sole in the `r thisyr-1` catch is estimated at `r round(sum(femcat[(nrow(femcat)-1),]*seq(1,20,1)),2)` and `r round(sum(malcat[(nrow(malcat)-1),]*seq(1,20,1)),2)` years for females and males, respectively.

The time-series of catch in `r table_nums("catch",display="cite")` also includes Yellowfin Sole that were discarded in domestic fisheries from 1987 to the present.  Annual discard estimates were calculated from at-sea sampling (`r table_nums("retdis",display="cite")`).  The rate of discard has ranged from a low of 2% of the total catch in 2019 to a high of 29% in 1992.  The trend has been toward fuller retention of the catch in recent years, and with the advent of the Amendment 80 harvest practices, discarding is at its lowest level since these estimates have become available.  Historically, discarding primarily occurred in the Yellowfin Sole directed fishery, with lesser amounts in the Pacific cod, Pollock, rock sole, flathead sole, and “other flatfish” fisheries (`r table_nums("retdiscat",display="cite")`).

# Data  

The data used in this assessment include estimates of total catch, bottom trawl survey biomass estimates and their attendant 95% confidence intervals, catch-at-age from the fishery, and population age composition estimates from the bottom trawl survey.  Weight-at-age and proportion mature-at-age are also available from studies conducted during the bottom trawl surveys. Estimates of fishery weight-at-age was based on catch-at-age methodology used in the Walleye Pollock assessment (Ianelli et al. 2019), following Kimura (1989) and modified by Dorn (1992).

Data source                                         Year
--------------------------------------------------- ----------------------------   
Fishery catch                                       1954 - `r thisyr`            
Fishery age composition	                            1964 - `r thisyr-1`          
Fishery weight-at-age	                              Catch-at-age methodology
Survey biomass and standard error                   1982 - `r thisyr-1` 
Bottom temperature	                                 1982 - `r thisyr-1` 
Survey age composition	                             1979 - `r thisyr-1` 
Annual length-at-age and weight-at-age from surveys	1979 - `r thisyr-1` 
Age at maturity	                                    Combined 1992 and 2012 samples
----------------------- 



## Fishery 

_Age Determination_

Yellowfin Sole ages have been determined at the AFSC by using the break and burn method on otoliths collected in surveys and from fisheries since 1979.  In 2016 the age determination methods for Yellowfin Sole were validated using the bomb-produced uptake measurement of 14C method (Kastelle et al. 2016). The number of otoliths read from the fishery has averaged 740 per year (`r table_nums("occurrence",display="cite")`).

_Catch_

This assessment uses fishery catch data from 1954-`r thisyr` (`r table_nums("catch",display="cite")`), and fishery catch-at-age (proportions) from 1964-`r thisyr-1` (`r table_nums("catageprop",display="cite")`, 1975-`r thisyr-1`). Removals from sources other than those that are included in the Alaska Region’s official estimate of catch (e.g., removals due to scientific surveys, subsistence fishing, recreational fishing, fisheries managed under other FMPs) are presented in Appendix A, Table A1.

_Numbers at age_

The proportion of length at age from the fishery was applied to the length frequencies from the aged sample from the fishery, providing proportions at age from the fishery. The fishery age composition has always been primarily composed of fish older than 9 years with a large amount of 20+ fish, although the proportion has declined from 90% over age 7 to 70% over age 7 since the 1970's (`r table_nums("catageprop",display="cite")`.

_Weight-at-age_

The fishery weight-at-age composition was based on the catch-at-age methodology of Kimura (1989) and modified by Dorn (1992), as implemented in the 2019 Walleye Pollock stock assessment (Ianelli et al. 2019). Length-stratified age data were used to construct age-length keys for each stratum and sex. These keys are then applied to randomly sampled catch length frequency data. The stratum-specific age composition estimates were then weighted by the catch within each stratum to arrive at an overall age composition for each year. The three strata were the EBS trimesters of the year (January-April, May-August, and September-December). This method was used to derive the age compositions from 1991–2019 (the period for which all the necessary information was readily available). The catch-at-age estimation method uses a two-stage bootstrap resampling of the data. Observed tows were first selected with replacement, followed by resampling actual lengths and age specimens given that set of tows. This method allows an objective way to specify the effective sample size for fitting fishery age composition data within the assessment model. Estimates of stratum-specific fishery mean weights-at-age are a product of this analysis and these were used as input data to the model. 

_Maturity-at-age_

Maturity information collected from Yellowfin Sole females during the 1992 and 1993 eastern Bering Sea trawl surveys have been used in this assessment for the past 20 years (`r table_nums("mature",display="cite")`).  Nichol (1995) estimated the age of 50% maturity at 10.5 years based on the histological examination of 639 ovaries.  Maturity has recently been re-evaluated from a histological analysis of ovaries collected in 2012 (`r table_nums("mature",display="cite")`). Results were very similar to the earlier study with only a 2% difference in estimates of Yellowfin Sole female spawning biomass (TenBrink and Wilderbuer 2015).  In addition, the SSC requested that the assessment use a maturity schedule that uses estimates derived from both the 1992 and the 2012 collections (`r table_nums("mature",display="cite")`). For Yellowfin Sole sexual maturity occurs well after the age of entry into the fishery.  Yellowfin Sole females are 82% selected to the fishery by age 10 whereas they have been found to be only 40% mature at this age. 

## Survey     

_Length and Weight-at-Age_ 

Sex-specific, time-invariant growth used in the model is based on the average length-at-age and weight-at-length relationships from the time-series of survey observations over all years since 1982.  Length-at-age estimates were estimated from the von Bertalanffy growth curve and converted to weight using a power function.

Parameters of the von Bertalanffy growth curve estimated for Yellowfin Sole, by sex, from the trawl survey database as follows: 

Sex     $L_{inf}$  $K$     $t_0$     $n$
------- ---------- ------- --------- ----
Males   34.03       0.161   0.515     656
Females 38.03       0.137   0.297     709
-----------------------------------------

A sex-specific length-weight relationship was also calculated from the survey database using the power function, 
$Weight(g) =  a*Length(cm)^b$, where $a$ and $b$ are parameters estimated to provide the best fit to the data (`r figure_nums("wtage",display="cite")`).  

Sex     $a$       $b$     $n$  
------- --------- ------- -------
Males   0.00854   3.081   2,701
Females 0.0054    3.227   3,662
---------------------------------

This relationship between weight and length were applied to the annual trawl survey estimates of population length at age, by sex, to calculate the weight at each age (`r figure_nums("wtage",display="cite")`). Since the resulting estimates of annual weight-at-age were highly variable for fish older than 11 years, ages 11-20 were smoothed using a five-year average smoothing method for 1982-`r thisyr`. The weight-at-age for the final year (`r thisyr`) was assumed to be the same as for `r thisyr-1`, as no survey was conducted in 2020 (`r table_nums("wtagetab",display="cite")`).

Applications of dendrochronology (tree-ring techniques) have been used to develop biochronologies from the otolith growth increments of northern rock sole (_Lepidopsetta polyxystra_), Yellowfin Sole and Alaska plaice (_Pleuronectes quadrituberculatus_) in the eastern Bering Sea. These techniques ensure that all growth increments are assigned the correct calendar year, allowing for estimation of somatic growth by age and year for chronologies that span approximately 25 years (Matta et al. 2010).  The analysis indicated that Yellowfin Sole somatic growth exhibits annual variability and has a strong positive correlation with May bottom water temperature in the Bering Sea (`r figure_nums("black",display="cite")`).

The relationship between temperature and growth was further explored by reanalyzing Yellowfin Sole growth by age and year.  Length-weight data collected when obtaining otolith (age) samples in RACE surveys (n=7,000 from 1987, 1994 and 1999-2009) also indicate that weight-at-age exhibits annual variability and is highly correlated with summer bottom water temperature observations with a lag of 2-3 years for the temperature effect to be seen (shown for age 5 fish in `r figure_nums("tempanom",display="cite")`).  These observations were then extended back to 1979 using survey population length-at-age estimates (since weight-at-age is a power function of the length-at-age, Clark et al. 1999, Walters and Wilderbuer 2000). 

We used the annual observed population mean weight-at-age (time-varying) from the trawl survey to incorporate time-varying (year effect on growth) and temperature-dependent growth functions into the age-structured stock assessment model. These empirical data indicate good somatic growth correspondence with annual bottom temperature anomalies (`r figure_nums("tempanom",display="cite")`).  
_Survey Biomass Estimates and Population Age Composition Estimates_

Indices of relative abundance available from AFSC surveys showed high NMFS surveys biomass estimates in the 1980s (`r table_nums("Srvbio_CI",display="cite")`.  High levels of biomass in the late 1970s have been documented through Japanese commercial pair trawl data and catch-at-age modeling in past assessments (Bakkala and Wilderbuer 1990).

Average survey CPUE for Yellowfin Sole has fluctuated from approximately 30-60 $kg/hectare$ over the eastern Bering Sea time survey from 1982-2019 (`r figure_nums("cpueline",display="cite")`).  Catch is typically taken throughout the Bering Sea shelf, as far north as 65$^{\circ}$N and small amounts are taken in the Aleutian Islands (`r figure_nums("cpuefig",display="cite")`). Biomass estimates for Yellowfin Sole from the annual bottom trawl survey on the eastern Bering Sea shelf showed a doubling of survey biomass between 1975 and 1979 with a further increase to over 3.3 million t in 1981 (`r table_nums("biomCI",display="cite")` and `r figure_nums("srvCI",display="cite")`).  Total survey abundance estimates fluctuated from 1983 to 1990 with biomass ranging from as high as 3.5 million t in 1983 to as low as 1.9 million t in 1986. Biomass estimates since 1990 indicate an even trend at high levels of abundance for Yellowfin Sole, with the exception of the results from the 1999 and 2000 summer surveys, which were at lower levels.  Surveys from 2001-2005 estimated an increase each year but the estimates since 2006 indicate a stable level with some annual variability.  However, the 2012 estimate is a 19% decrease from 2011 and the 2013 and 2014 surveys have estimated a 17% increase over 2012.  Similarly, there was a 24% decrease from 2014 to 2015 followed by a 48% increase from 2015 to 2016, the highest biomass estimate since 1984. Fluctuations of the magnitude shown between 1980 and 1990, 1998 and 1999, 2008 and 2009, 2011 and 2012, 2014 and 2015, and 2015 and 2016 are unreasonable considering the elements of slow growth and long life span of Yellowfin Sole combined with low to moderate exploitation rate, characteristics which should produce more gradual changes in abundance (`r table_nums("Srvbio_CI",display="cite")`). Biomass estimates from the northern Bering Sea have shown an increase in Yellowfin Sole biomass from 310,617 t in 2010 to 520,029 t in 2019 (`r table_nums("NBS_bio",display="cite")`).

Experiments examining the bridle efficiency of the Bering Sea survey trawl indicate that Yellowfin Sole are herded into the trawl path from an area between the wing tips of the net and the point where the bridles contact the seafloor (Somerton and Munro 2001).  The herding experiments suggest that the survey trawl vulnerability (a component of catchability) is greater than 1.0.  The likelihood profile of $q$ from the model indicated a small variance with a narrow range of likely values with a low probability of $q$ being equal to the value of 1.0 in a past assessment (Wilderbuer and Nichol 2003).

Variability of Yellowfin Sole survey biomass estimates (`r figure_nums("srvCI",display="cite")`) is in part due to the availability of Yellowfin Sole to the survey area (Nichol 1998, Nichol et al. 2019).  Yellowfin Sole are known to undergo annual migrations from wintering areas off the shelf-slope break to near shore waters where they spawn throughout the spring and summer months (Nichol 1995; Wakabayashi 1989; Wilderbuer et al. 1992).  Exploratory survey sampling in coastal waters of the eastern Bering Sea during early summer indicate that Yellowfin Sole concentrations can be greater in these shallower areas not covered by the standard AFSC survey than in the survey proper.  Commercial bottom trawlers have commonly found high concentrations of Yellowfin Sole in areas such as near Togiak Bay (Low and Narita 1990) and in more recent years from Kuskokwim Bay to just south of Nunivak Island.  The coastal areas are sufficiently large enough to offer a substantial refuge for Yellowfin Sole from the current survey.  

Over the past 18 years, survey biomass estimates for Yellowfin Sole have shown a positive correlation with shelf bottom temperatures (Nichol, 1998); estimates have generally been lower during cold years. The 1999 survey, which was conducted in exceptionally cold waters, indicated a decline in biomass that was unrealistic.  The bottom temperatures during the 2000 survey were much warmer than in 1999, and the biomass increased, but still did not approach estimates from earlier years.  Average bottom temperature and biomass both increased again during the period 2001 – 2003, with the 2003 value the highest temperature and biomass observed over the 22 year time series up to that time.  Given that both the 1999 and 2000 surveys were conducted two weeks earlier than previous surveys, it is possible that the time difference may also have also affected the availability of Yellowfin Sole to the survey.  If, for example, the timing of peak Yellowfin Sole spawning in nearshore waters corresponded to the time of the survey, a greater proportion of the population would be unavailable to the standard survey area.  This pattern was observed again in 2009 and 2012 when the temperatures and the bottom trawl survey point estimates were lower.  Summer shelf bottom temperatures in 2012 were the 2nd coldest recorded by the survey and the time-series and resulted in a 19% decline from 2011.  Temperatures in the Bering Sea have been higher than the mean since 2013 (`r figure_nums("tempanom",display="cite")`), and the 2016 estimate of biomass was the highest in 32 years and 48% higher than the 2015 estimate. The 2017 survey estimate of 2,787,700 t was 3% lower than 2016, and the 2018 estimate of 1,892,925 was down 32% from 2017, followed by a 6% increase in `r thisyr`. 

We propose several possible reasons why survey biomass estimates are lower during years when bottom temperatures are low.  First, catchability may be lower because Yellowfin Sole may be less active when cold.  Less active fish may be less susceptible to herding and more likely to escape under the foot rope of survey gear. Secondly, bottom temperatures may influence the timing of the inshore spawning migrations of Yellowfin Sole and therefore affect their availability to the survey area (Nichol et al. 2019).  Because Yellowfin Sole spawning grounds include nearshore areas outside the survey area, availability of fish within the survey area can vary with the timing of this migration and the timing of the survey. In the case of 2016, a very warm year in the Bering Sea, it appears that a higher portion of the adult biomass was distributed on the shelf (outside of the spawning areas) relative to the average of all previous survey years, indicating earlier spawning migration (`r figure_nums("cpuediff",display="cite")`). Third, Yellowfin Sole growth appears to be correlated with temperature, as can be seen with greater length anomalies of 5 year old males in females in warm years and smaller lengths in cold years (`r figure_nums("tempanom",display="cite")`). 

Yellowfin Sole population numbers-at-age estimated from the annual bottom trawl surveys are shown in `r table_nums("natagesrv",display="cite")` and their occurrence in trawl survey hauls and associated collections of lengths and age structures since 1982 are shown in `r table_nums("occurrence",display="cite")`. Their total tonnage caught in the resource assessment surveys since 1982 are listed in `r table_nums("rescat",display="cite")` and also in an appendix table with IPHC survey catches (Table A1).

_Northern Bering Sea survey_

Trawl survey sampling was extended to the northern Bering Sea in 2010, 2017, 2018, and 2019.  The trawl surveys conducted in 2010, 2017, and 2019 occupied the same areas with similar sampling densities.  The 2018 survey was a reduced effort and only sampled a subset of the northern Bering Sea.  Stations in 2018 were 30 nautical miles apart (instead of 20 nm) and excluded Norton Sound and inshore areas north of Nunivak Island.  For comparison among years (2010, 2017, 2018), biomass estimates were derived by truncating the areal coverage of the 2010 and 2017 surveys to include only the area covered in 2018 that was common to all three surveys, and this was treated as a single stratum (`r figure_nums("NBS",display="cite")`).   This truncated area was 158,286 square kilometers (compared to 200,207 square kilometers in 2010 and 2017).  There has been an increase in the biomass estimate of Yellowfin Sole in the northern Bering Sea since 2010; the estimate in 2010 was 310,617 t and the estimate in 2019 was 520,029 t. Since bottom trawl fishing is presently prohibited in the northern Bering Sea, the biomass from this area has typically not been included in the stock assessment model, although Model 18.4 presented this year did incorporate EBS+NBS biomass estimates. Large shifts in the abundance of Yellowfin Sole into the Bering Sea have not been observed (`r figure_nums("NBS",display="cite")`), but the spatial distribution will continue to be monitored as shifts may occur under future climate change. A time series based on an ADF&G survey in Norton Sound confirms that the biomass of Yellowfin Sole is increasing there. The mean CPUE/km$^2$ of Yellowfin Sole in Norton Sound has increased from a mean CPUE of 201 over the first five survey years (1976, 1979, 1982, 1985, and 1988) to a mean CPUE of 390 over the last five survey years (2014, 2017, 2018, 2019, and 2020) (`r figure_nums("ADFG",display="cite")`).

_VAST estimates of biomass_

We incorporated vector-autoregressive spatio-temporal (VAST) biomass estimates into two new models; Model 18.3 incorporated VAST estimates from the EBS from 1982-2019, and Model 18.4 incorporated VAST estimates from the NBS and the EBS from 1982-2019 (Thorson 2019). Abundance indices for the EBS+NBS region were fit using a temporal smoother on epsilon and a cold pool effect. The EBS-only dataset did not use the temporal smoother on epsilon to avoid extra complexity of covariance among years, and also provided consistency with previous EBS-only indices. When fitting spatially balanced survey data, it is conventional to avoid specifying any temporal correlation for intercepts or spatio-temporal variation (Thorson et al. 2015); this minimizes covariance in the estimated index among years, and is done for all spatio-temporal indices in the eastern Bering Sea and Gulf of Alaska.  However, for spatially unbalanced survey data (e.g., when combining the EBS and NBS, and lacking NBS data in many years), it is appropriate to specify a temporal correlation for the spatio-temporal component (O’Leary et al. 2020).  This allows hotspots in density to be propagated forward and backwards in time in the NBS (e.g., a Brownian bridge in log-density between surveys in 2010 and 2017). The spatially varying response to cold-pool extent further refines this interpolation, and provides information about the rate of density increases in the NBS as informed by the annual cold-pool index (Thorson et al. 2020).

The VAST model fit survey numbers per unit area from all grid cells and corner stations in the 83-112 bottom trawl survey of the EBS, 1982-2019, as well as 83-112 samples available in the NBS in 1982, 1985, 1988, 1991, 2010, and 2017-2019.  NBS samples prior to 2010 did not follow the 30 nautical mile sampling grid that was used in 2010, 2017, and 2019, and the 2018 sampling followed a coarsened grid as well. 

The distribution of positive catch rates was specified using a gamma distribution; expected encounter probability and expected positive catch rates (catch given an encounter) were calculated from two linear predictors using a Poisson-link delta model (Thorson 2018).  We extrapolated density to the entire EBS and NBS in each year, using extrapolation grids that are available within FishStatsUtils when integrating densities. The extrapolation-grids were composed of a total of 51,769 cells where each cell represented an area of 3705 (2nmi) x 3705 (2nmi). This results in 36,690 extrapolation-grid cells for the eastern Bering Sea and 15,079 in the northern Bering Sea. We used bilinear interpolation to interpolate densities from 250 “knots” to these extrapolation-grid cells; knots where distributed spatially in proportion to the distribution of extrapolation-grid cells (i.e., having an approximately even distribution across space).  We estimated “geometric anisotropy” (the tendency for correlations to decline faster in some cardinal directions than others), and including a spatial and spatio-temporal term for both linear predictors.  To improve interpolation of density “hotspots” between unsampled years, we specified that the spatio-temporal term was autocorrelated across years (where the magnitude of autocorrelation was estimated as a fixed effect for each linear predictor).  However, we did not include any temporal correlation for intercepts, which we treated as fixed effects for each linear predictor and year.  Finally, we used epsilon bias-correction to correct for retransformation bias (Thorson and Kristensen 2016).  

# Analytic Approach

## General Model Structure

The abundance, mortality, recruitment and selectivity of Yellowfin Sole were assessed with a stock assessment model using the AD Model Builder language (Fournier et al. 2012; Ianelli and Fournier 1998).  The conceptual model is a separable catch-age analysis that uses survey estimates of biomass and age composition as auxiliary information (Fournier and Archibald 1982).  The assessment model simulates the dynamics of the population and compares the expected values of the population characteristics to the characteristics observed from surveys and fishery sampling programs.  This was accomplished by the simultaneous estimation of the parameters in the model using the maximum likelihood estimation procedure. The fit of the simulated values to the observable characteristics was optimized by maximizing a log(likelihood) function given some distributional assumptions about the observed data.  

The model includes ages one through 20. Fish older than twenty are allowed to accumulate into a plus group that includes fish of age twenty and older (20+). Since the sex-specific weight-at-age for Yellowfin Sole diverges after age of maturity (about age 10 for 40% of the stock), with females growing larger than males, the current assessment model is coded to accommodate the sex-specific aspects of the population dynamics of Yellowfin Sole.  The model allows for the input of sex-specific estimates of fishery and survey age composition and weight-at-age and provides sex-specific estimates of population numbers, fishing mortality, selectivity, fishery and survey age composition and allows for the estimation of sex-specific natural mortality and catchability.  The model retains the utility to fit combined sex data inputs.

The suite of parameters estimated by the model are classified by three likelihood components:

Data component	                           Distributional assumption
----------------------------------------- ---------------------------
Trawl fishery catch-at-age	               Multinomial
Trawl survey population age composition	  Multinomial
Trawl survey biomass estimates and S.E.	  Log-normal
----------------------------------------------------------------

The total log likelihood is the sum of the likelihoods for each data component (`r table_nums("liketab",display="cite")`).  The likelihood components may be weighted by an emphasis factor, however, equal emphasis was placed on fitting each likelihood component in the Yellowfin Sole assessment except for the catch. The AD Model Builder software fits the data components using automatic differentiation (Griewank and Corliss 1991) software developed as a set of libraries (AUTODIFF C++ library).  

Sharp increases in trawl survey abundance estimates for most species of Bering Sea flatfish between 1981 and 1982 indicate that the 83-112 trawl was more efficient for capturing these species than the 400-mesh eastern trawl used in 1975, and 1979-81.  Allowing the model to tune to these early survey estimates would underestimate the true pre-1982 biomass, thus exaggerating the degree to which biomass increased during that period.  Although this underestimate would have little effect on the estimate of current Yellowfin Sole biomass, it would affect the spawner and recruitment estimates for the time-series.  Hence, the pre-1982 survey biomass estimates were omitted from the analysis.

Total mortality $Z$ in the model was modeled as the sum of fishing mortality $F$ and natural mortality $M$, such that total mortality in year $t$ at age $a$ is $Z_{t,a}=F_{t,a}+M.$ 

Fishing mortality at each year and age, $F_{t,a}$, was the product of age-specific fishing gear selectivity $s_a$ and the median year-effect of fishing mortality ${\mu}^F$, with normally distributed error, $$F_{t,a}=s_a{{\mu}^F}e^{{\epsilon}^F_t}, {{\epsilon}^F_t}\backsim N(0,{{\sigma}_F^2}),$$ where ${\epsilon}^F_t$ is the residual year-effect of fishing mortality and ${\sigma}_F$ is the standard deviation of fishing mortality. Age-specific fishing selectivity $s_a$ was calculated using the logistic equation 

$$s_a={\displaystyle\frac{1}{1+e^{(-{\alpha}+age{\beta})}}}.$$

Catch in year $t$ for age $a$ fish $C_{t,a}$ was calculated: $$C_{t,a}={\displaystyle\frac{F_{t,a}}{Z_{t,a}}}(1-e^{Z_{t,a}})N_{t,a},$$ where $N_{t,a}$ is the number of fish at time $t$, age $a$. Total catch in each year $C_t$ was the sum of catch over all ages, $C_t={\sum_a}C_{t,a},$ and the proportion at age in catch was $P_{t,a}={\displaystyle\frac{C_{t,a}}{C_t}}.$

Recruitment from 1956-1975 was modeled as  $N_{t,1}=R_{t}=R_{0}e^{\tau_{t}}, {\tau}_t \backsim\ N(0,\sigma^2_R)$, where $R_0$ is the geometric mean of the modeled age 1 recruitment from 1956-1975, and $\sigma_{R}$ is the standard deviation of recruitment.

Recruitment from 1978-`r thisyr` was determined using the Ricker stock recruitment curve, $$R={\alpha}Se^{-{\beta}S},$$ where $S$ is the spawning stock biomass. Parameters $\alpha$ and $\beta$ were estimated by fitting spawning biomass and recruitment during the period 1978-`r thisyr-6`, and are shown from Model 18.1 (`r figure_nums("ricker1",display="cite")`) and Model 18.2 (`r figure_nums("ricker2",display="cite")`).

The number of fish in year $t+1$ at age $a$ was the number of fish in the previous year subjected to natural and fishing mortality, $$N_{t+1,a+1}=N_{t,a}e^{-Z_{t,a}}.$$

The "plus group" included all fish age 20 and older included fish surviving from age 19 as well as those age 20 and higher, $$N_{t+1,A}=N_{t,a}e^{-Z_{t,A-1}}+N_{t,A}e^{-Z_{t,A}}.$$

Spawning biomass was calculated as the product of weight-at-age and the number of mature females at each age, $$S_t={\sum}N_{t,a}W_{t,a}{\phi}_a,$$ where ${\phi}_a$ is the proportion of mature females at age $a$ and $W_{a,t}$ is the mean body weight in kg of fish age $a$ in year $t$. Survey biomass was assumed to be the product of catchability $q$, survey selectivity $s_a$, and the biomass, $$Biomass_{survey,t}=q{\sum}N_{t,a}W_{t,a}s_a.$$

A Markov chain Monte Carlo (MCMC) was performed in ADMB to capture variability in $F_{MSY}$, $B_{MSY}$, recruitment, female spawning biomass, and total (age 1+) biomass. The MCMC was run with 1,000,000 iterations, and thinning every 200. An MCMC was run for Models 18.2 and 18.1.

The model of Yellowfin Sole population dynamics was evaluated with respect to the observations of the time-series of survey and fishery age compositions and the survey biomass trend since 1982. 

## Description of Alternative Models

In this assessment we considered Model 18.1 used in the `r thisyr-1` assessment updated with `r thisyr` data. Model 18.1 used the same natural mortality for males and females, $M$=0.12. A second model was considered in this assessment (Model 18.2) that used a fixed value for female natural mortality ($M$=0.12) and allowed male natural mortality to be estimated within the model. Model 18.2 is the preferred model.

In addition, two models were included that used VAST estimates of biomass rather than standard design-based estimates of biomass. Model 18.3 used VAST biomass and standard error estimates for the eastern Bering Sea area. Model 18.4 used VAST estimates of biomass and standard error for the eastern and northern portions of the Bering Sea. 

## Parameters Estimated Outside the Assessment Model

Natural mortality ($M$) was initially estimated by a least squares analysis where catch at age data were fitted to Japanese pair trawl effort data while varying the catchability coefficient ($q$) and $M$ simultaneously.  The best fit to the data (the point where the residual variance was minimized) occurred at a value of $M$=0.12 (Bakkala and Wespestad 1984).  This was also the value which provided the best fit to the observable population characteristics when $M$ was profiled over a range of values in the stock assessment model using data up to 1992.  Since then, natural mortality has been estimated as a free parameter in some of the stock assessment model runs which have been evaluated the past five years.  A natural mortality value of 0.12 is used for both sexes in Model 18.1 and fixed female natural mortality at $M$=0.12 and male natural mortality estimated by the model is used in Model 18.2.

Yellowfin Sole maturity schedules were estimated from in-situ observations from two studies as discussed in the "Data" section (`r table_nums("mature",display="cite")`).

## Parameter Estimates

A list of selected parameters estimated inside the model are shown in `r table_nums("pars",display="cite")`.

## Parameters Estimated Inside the Assessment Model

There were 507 parameters estimated by Model 18.1 and 508 by Models 18.2, 18.3, and 18.4. The number of key parameters are presented below:

\begin{table}[H]
\centering
\begin{tabular}{ rrrrrrr }
\hline
Fishing mortality  &   Selectivity	 & Survey catchability	  &  Year-class strength    &     Spawner-recruit	&   $M$  &  Total \\
\hline
68 & 317 & 4 & 115 & 2 & 2 (or 1) & 508 (or 507)  \\
\hline
\end{tabular}
\end{table}

The increase in the number of parameters estimated in this assessment compared to last year (7) can be accounted for by the input of another year of fishery data and the entry of another year-class into the observed population, four more sex-specific fishery selectivity parameters, male natural mortality, and an additional catchability parameter. The population simulation specifies the numbers-at-age in the beginning year of the simulation, the number of recruits in each subsequent year, and the survival rate for each cohort as it moves through the population over time.

_Selectivity_

Fishery and survey selectivity was modeled separately for males and females using the two parameter formulation of the logistic function. The model was run with an asymptotic selectivity curve for the older fish in the fishery and survey, but still allowed to estimate the shape of the logistic curve for young fish. The oldest year-classes in the surveys and fisheries were truncated at 20 and allowed to accumulate into the 20+ age category. A single selectivity curve, for both males and females, was fit for all years of survey data (`r figure_nums("srvsel",display="cite")`). 

Time-varying fishing selectivity curves were estimated because there have been annual changes in management, vessel participation and possibly gear selectivity (`r figure_nums("fshsel",display="cite")`). A logistic equation was used to model fishery selectivity and is a function of time-varying parameters specifying the age and slope at 50% selection,  $\varphi_t$ and $\eta_t$, respectively.  The fishing selectivity ($S^f$) for age a and year t is modeled as, 

\begin{align}
S^f_{a,t}=[1+e^{\eta_t(a-\varphi_t)}]^{-1},
\end{align}

where $\varphi_t$ and $\eta_t$ are time-varying and partitioned (for estimation) into parameters representing the mean and a vector of deviations (log-scale) conditioned to sum to zero.  The deviations are constrained by a lognormal prior with a variance that was iteratively estimated.  The process of iterating was to first set the variance to a high value to estimate the deviations.  The next step was to compare the variability of model estimates.  The variance of the model estimates were then rounded up slightly and fixed for subsequent runs.  The `r thisyr` values were fixed as the average of the 3 most recent years.

_Fishing Mortality_

The fishing mortality rates (F) for each age and year are calculated to approximate the catch weight by solving for F while still allowing for observation error in catch measurement.  A large emphasis (300) was placed on the catch likelihood component to force the model to closely match the observed catch.

_Survey Catchability_

Past assessments have examined the relationship between estimates of survey biomass and bottom water temperature.  To better understand how water temperature may affect the catchability of Yellowfin Sole to the survey trawl, catchability was estimated for each year in the stock assessment model as:

\begin{align}
q=e^{-{\alpha}+{\beta}T},
\end{align}

where $q$ is catchability, $T$ is the average annual bottom water temperature anomaly at survey stations less than 100 m, and $\alpha$ and $\beta$ are parameters estimated by the model.  The catchability equation has two parts.  The $e^{-\alpha}$ term is a constant or time-independent estimate of $q$. The second term, $e^{{\beta}T}$  is a time-varying (annual) $q$ which responds to metabolic aspects of herding or distribution (availability) which can vary annually with bottom water temperature.  The result of incorporating bottom temperature to estimate annual $q$ has resulted in an improved fit to the survey (described in the 2018 BSAI Yellowfin Sole assessment). 

In Model 18.1, a revised survey catchability model was introduced (in 2018), which included survey start date (expressed as deviation in days (- and +) from the average survey start date of June 4th). This feature was retained in Model 18.2, and its interaction with annual bottom water temperature was added to the catchability equation as:

\begin{align}
q=e^{-{\alpha}+{\beta}T+{\gamma}S+{\mu}T:S},
\end{align}

where $T$=survey bottom temperature (averaged per year for all stations <100 m), $S$=survey start date, and $T:S$=interaction of $T$ and $S$.  Earlier survey start dates usually encounter colder water and since the timing of the survey start date is positively correlated with bottom water temperature, improvement in fitting the survey biomass estimates can be gained by estimating two new parameters ($\mu$ and $\gamma$).  Akaike information criterion (AIC) were used to determine if the additional variables ($S$ and $T:S$) improved the regression fit.  The improvement in fit was more than offset by the additional two parameters (Nichol et al. 2019). 

_Spawner-Recruit Estimation_

Annual recruitment estimates from 1978-`r thisyr-6` were constrained to fit a Ricker (1958) form of the stock recruitment relationship as follows:

\begin{align}
R={\alpha}Se^{-{\beta}S},
\end{align}

where $R$ is age 1 recruitment, $S$ is female spawning biomass in metric tons the previous year, and $\alpha$ and $\beta$ are parameters estimated by the model.  This stock recruitment curve expresses a peak level of recruitment at an intermediate stock abundance and density dependence at higher stock sizes. The spawner-recruit fitting is estimated in a later phase after initial estimates of survival, numbers-at-age and selectivity are obtained.

# Results

## Model Evaluation

For this assessment, two models were examined in full (Model 18.1 and 18.2), and two additional exploratory models were examined, Model 18.3 and 18.4. Model 18.1 was the accepted model in the 2018 and 2019 Yellowfin Sole stock assessments. Model 18.2 fixed female natural mortality at $M$=0.12 as in previous years, but allowed the model to freely estimate male natural mortality. The model estimated male natural mortality to be higher than female natural mortality, which is in common with known life history parameters of other Alaska flatfish. In Arrowtooth Flounder, higher natural mortality is assumed for males and is consistent with their skewed sex ratio (Wilderbuer and Turnock 2009). Higher natural mortality for male flatfish has been assumed to flatfish from other regions as well (Maunder and Wong 2011).

Models 18.1 and 18.2 differ for some parameter estimates. The trend in survey catchability was similar with Model 18.1 and Model 18.2, but catchability was lower with Model 18.2 (`r figure_nums("plotq",display="cite")`). The sex ratio estimate changed slightly with Model 18.2. The proportion female was estimated to be slightly lower in Model 18.1 than Model 18.2, as higher male natural mortality increased the estimated number of males in the population (`r figure_nums("sexratio",display="cite")`). Overall, the total negative log likelihod was lower for Model 18.2, and provided a better fit to the survey and fishery ages, as well as an improvement to the fit to survey catchability, with the total negative log likelihood reduced from 1,449 in Model 18.1 to 1,386 in Model 18.2 (`r table_nums("liketab",display="cite")`, `r figure_nums("srv_agecomp1",display="cite")`, `r figure_nums("srv_agecomp2",display="cite")`,  `r figure_nums("fsh_agecomp1",display="cite")`,  `r figure_nums("fsh_agecomp2",display="cite")`). 

`r table_nums("Mcomparison",display="cite")` indicates that the ABC from Model 18.2 for `r thisyr+1` would be `r formatC(1000*(extra_sd2$ABC_HM[1]-extra_sd1$ABC_HM[1]),format="d",big.mark=",")` t higher than Model 18.1. This is due to the higher biomass estimate resulting from an increased value of male natural mortality in Model 18.2. Model 18.2 also provided a slightly better fit to survey biomass, but this effect was primarily noticeable during the years 1988-1995. Overall Model 18.2 provided very little change in the fit to survey biomass (`r figure_nums("srvbio_fit",display="cite")`). Models 18.3 and 18.4 fit their corresponding estimates of survey biomass fairly well, but there was some discontinuity in the fit for 2015, that was consistent among models.

Posterior distributions of several key parameters in the model capture variability in posterior distributions of parameter estimates and differences between Model 18.2 and Model 18.1 (`r figure_nums("mcmcplots",display="cite")`). Model 18.2 resulted in higher estimates for $B_{MSY}$, total and age 6 biomass and female spawning biomass and recruitment, but similar values to Model 18.1 for $F_{MSY}$. The posterior distribution for female spawning biomass is above the Model 18.2 estimate for $B_{MSY}$ (`r figure_nums("mcmcplots",display="cite")`).

Given the uncertainty of the productivity of Yellowfin Sole at low spawning stock sizes, and because the AFSC policy for reference point time-series selection is to use the post 1977 regime shift values unless there is a compelling reason to do otherwise, the productivity of Yellowfin Sole in this assessment was estimated by fitting the 1977-`r thisyr-6` spawner-recruit data in the model. The resulting stock recruitment curves are very similar for Model 18.1 and 18.2 (`r figure_nums("ricker1",display="cite")` and `r figure_nums("ricker2",display="cite")`).  

Model 18.2 is the preferred model for estimating the Yellowfin Sole stock size and management quantities for the `r thisyr+1` fishing season.  However, two other models were considered for an exploratory analysis of VAST biomass estimates and inclusion of the Bering Sea survey. Model 18.3 provided similar estimates of total (age 2+) and spawning biomass as Model 18.2; both of which used biomass estimates from the EBS and similar model parameterization (`r figure_nums("BIOM_SSB",display="cite")`). Model 18.2 provided consistently higher estimates than Model 18.3. Model 18.4 yielded the highest estimates of total and spawning biomass, which is reasonable, as biomass estimates were based on the standard EBS region plus the northern Bering Sea. Reference points resulting from all models, as well as the 2019 accepted model are shown in (`r table_nums("Mcomparison",display="cite")`).

## Time Series Results 

The data was updated in `r thisyr` to include current values of catch, fishery and survey age compositions from `r thisyr-1`. The latest year of data was included in fishery weight-at-age.  The preferred model (18.2) also incorporates a model estimate of male natural mortality, which increases estimates of biomass. These changes produced Model 18.2 ABC and OFL estimates for `r thisyr+1` higher than the `r thisyr-1` assessment (Model 18.1) projections for 2020, `r ABC_thisF` t and `r ABC_nextF` t. Model 18.2 produced slightly higher estimates for ABC and OFL than Model 18.1 due to the estimate of higher male natural mortality (`r table_nums("Mcomparison",display="cite")`). Reference points for Model 18.3 were very similar to Model 18.2. Reference points for Model 18.4 were the highest of all models, because it included biomass estimates for the EBS+NBS. 
The model results indicate the stock has been in a slowly declining condition since 1994 (`r figure_nums("BioFSBCI",display="cite")`).  The five past years in the Bering Sea have had bottom temperature anomalies above the mean. The temperature-dependent $q$ adjustment for `r thisyr` was `r round(YFS2$q[38,2],2)`.

_Fishing Mortality and Selectivity_

The full-selection fishing mortality, $F$, has averaged `r round(mean(YFS2$F_m[61:66,18]),4)` over the period 2014-`r thisyr-1` (`r table_nums("fmort",display="cite")`). Model estimated selectivities, `r figure_nums("srvsel",display="cite")` and `r figure_nums("fshsel",display="cite")` indicate that both sexes of Yellowfin Sole are 50% selected by the fishery at about age 9 and nearly fully selected by age 13, with annual variability. Based on results from the stock assessment model, annual average exploitation rates of Yellowfin Sole since 1977 ranged from 3% to 7% of the total biomass, and have averaged approximately 4%.

_Abundance Trends_

Model 18.2 estimated $q$ at an average value of `r round(mean(YFS2$q[,2]),2)` for the period 1982-`r thisyr` which resulted in the model estimate of the `r thisyr` age 2+ total biomass at `r formatC(YFS2$TotBiom[67,2],format="d",big.mark=",")` million t (`r table_nums("biomCI",display="cite")`).  Model results indicate that Yellowfin Sole total biomass (age 2+) was at low levels during most of the 1960s and early 1970s (700,000-1,000,000 t) after a period of high exploitation (`r table_nums("biomCI",display="cite")`, `r figure_nums("BioFSBCI",display="cite")`).  Sustained above average recruitment from 1967-1976 combined with light exploitation resulted in a biomass increase to a peak of approximately 3.6 million t by 1985.  The population biomass has since been in a slow decline as the strong 1981 and 1983 year-classes have passed through the population, with only the 1991, 1995 and 2003 year-classes at levels observed during the 1970s.  The present biomass is estimated at `r 100*round(YFS2$TotBiom[67,2]/YFS2$TotBiom[32,2],2)`% of the peak 1985 level. The female spawning biomass has also declined since the peak in 1994, with a `r thisyr` estimate of `r formatC(YFS2$SSB[67,2],format="d",big.mark=",")` million t (`r table_nums("FSBCI",display="cite")`).  

Allowing $q$ to be correlated with annual bottom temperature and survey start date provides a better fit to the bottom trawl survey estimates than using a $q$ fixed at the average value (Fig. 4.18, Wilderbuer et al. 2018).  Both the trawl survey and the stock assessment model indicate that the Yellowfin Sole resource (total biomass) increased during the 1970s and early 1980s to a peak level during the mid-1980s.  The Yellowfin Sole population biomass slowly decreased over the 23 years since the mid-1990s as the majority of year-classes during those years were below average strength.  Average to above average recruitment from 2006 to 2009 is expected to maintain the abundance of Yellowfin Sole at a level above $B_{MSY}$ in the near future.  The stock assessment projection model indicates a slightly increasing trend in female spawning biomass through `r thisyr+13` if the fishing mortality rate continues at the same level as the average of the past 5 years (`r figure_nums("fishingavgF",display="cite")`).

_Recruitment Trends_

The primary reason for the sustained increase in abundance of Yellowfin Sole during the 1970s and early 1980s was the recruitment of a series of stronger than average year-classes spawned in 1967-76 (`r table_nums("rec",display="cite")` and `r figure_nums("recfig",display="cite")`).  The 1981 year-class was the strongest observed (and estimated) during the time series, followed by the 1983 year-class. Survey age composition estimates and the assessment model also estimate that the 1987 and 1988 year-classes were average and the 1986 and 1988 year-classes were above average.  Recruitment since 1998 has been average, and the 2016 year-class appeared to be one of the lowest on record (`r figure_nums("recfig",display="cite")`).
 
_Retrospective Analysis_

```{r, echo=FALSE, message=FALSE}

YFS2020=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro0/fm.rep")
YFS2019=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro1/fm.rep")
YFS2018=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro2/fm.rep")
YFS2017=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro3/fm.rep")
YFS2016=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro4/fm.rep")
YFS2015=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro5/fm.rep")
YFS2014=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro6/fm.rep")
YFS2013=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro7/fm.rep")
YFS2012=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro8/fm.rep")
YFS2011=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro9/fm.rep")
YFS2010=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro10/fm.rep")

a=-1*(YFS2020$SSB[1:66,2]-YFS2019$SSB[,2])/YFS2020$SSB[1:66,2]
b=-1*(YFS2020$SSB[1:65,2]-YFS2018$SSB[,2])/YFS2020$SSB[1:65,2]
c=-1*(YFS2020$SSB[1:64,2]-YFS2017$SSB[,2])/YFS2020$SSB[1:64,2]
d=-1*(YFS2020$SSB[1:63,2]-YFS2016$SSB[,2])/YFS2020$SSB[1:63,2]
e=-1*(YFS2020$SSB[1:62,2]-YFS2015$SSB[,2])/YFS2020$SSB[1:62,2]
f=-1*(YFS2020$SSB[1:61,2]-YFS2014$SSB[,2])/YFS2020$SSB[1:61,2]
g=-1*(YFS2020$SSB[1:60,2]-YFS2013$SSB[,2])/YFS2020$SSB[1:60,2]
h=-1*(YFS2020$SSB[1:59,2]-YFS2012$SSB[,2])/YFS2020$SSB[1:59,2]
i=-1*(YFS2020$SSB[1:58,2]-YFS2011$SSB[,2])/YFS2020$SSB[1:58,2]
j=-1*(YFS2020$SSB[1:57,2]-YFS2010$SSB[,2])/YFS2020$SSB[1:57,2]

Rho18_2=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

#Model 18_1
YFS202018_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro0/fm.rep")
YFS201918_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro1/fm.rep")
YFS201818_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro2/fm.rep")
YFS201718_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro3/fm.rep")
YFS201618_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro4/fm.rep")
YFS201518_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro5/fm.rep")
YFS201418_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro6/fm.rep")
YFS201318_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro7/fm.rep")
YFS201218_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro8/fm.rep")
YFS201118_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro9/fm.rep")
YFS201018_1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro10/fm.rep")

a_18_1=-1*(YFS202018_1$SSB[1:66,2]-YFS201918_1$SSB[,2])/YFS202018_1$SSB[1:66,2]
b_18_1=-1*(YFS202018_1$SSB[1:65,2]-YFS201818_1$SSB[,2])/YFS202018_1$SSB[1:65,2]
c_18_1=-1*(YFS202018_1$SSB[1:64,2]-YFS201718_1$SSB[,2])/YFS202018_1$SSB[1:64,2]
d_18_1=-1*(YFS202018_1$SSB[1:63,2]-YFS201618_1$SSB[,2])/YFS202018_1$SSB[1:63,2]
e_18_1=-1*(YFS202018_1$SSB[1:62,2]-YFS201518_1$SSB[,2])/YFS202018_1$SSB[1:62,2]
f_18_1=-1*(YFS202018_1$SSB[1:61,2]-YFS201418_1$SSB[,2])/YFS202018_1$SSB[1:61,2]
g_18_1=-1*(YFS202018_1$SSB[1:60,2]-YFS201318_1$SSB[,2])/YFS202018_1$SSB[1:60,2]
h_18_1=-1*(YFS202018_1$SSB[1:59,2]-YFS201218_1$SSB[,2])/YFS202018_1$SSB[1:59,2]
i_18_1=-1*(YFS202018_1$SSB[1:58,2]-YFS201118_1$SSB[,2])/YFS202018_1$SSB[1:58,2]
j_18_1=-1*(YFS202018_1$SSB[1:57,2]-YFS201018_1$SSB[,2])/YFS202018_1$SSB[1:57,2]  

Rho18_1=(a_18_1[length(a_18_1)]+b_18_1[length(b_18_1)]+c_18_1[length(c_18_1)]+d_18_1[length(d_18_1)]+e_18_1[length(e_18_1)]+
      f_18_1[length(f_18_1)]+g_18_1[length(g_18_1)]+h_18_1[length(h_18_1)]+i_18_1[length(i_18_1)]+j_18_1[length(j_18_1)])/10;

thisyr=2020
```

A within-model retrospective analysis was included for the recommended assessment model (Model 18.2) and Model 18.1. In this analysis, retrospective female spawning biomass was calculated by sequentially dropping data one year at a time and then comparing the peeled estimate to the reference stock assessment model used in the assessment (`r figure_nums("retro1",display="cite")`). Mohn's rho did not change significantly for Model 18.2; it was `r round(Rho18_2,3)` for Model 18.2 and `r round(Rho18_1,3)` for Model 18.1. A similar retrospective pattern was observed as in recent years, in which earlier retrospective years indicated a lower level of spawning biomass than the current year's data (`r figure_nums("retro1",display="cite")`). Retrospective plots did not change significantly betweeen models 18.1 and 18.2 (`r figure_nums("retro1",display="cite")`). The difference in female spawning biomass was negative for most recent years, except for the most recent (`r figure_nums("retro2",display="cite")`), and very similar among models. It is notable that there was very little difference in the retrospective pattern for the current year vs. 2019 and 2018. This is an improvement in the retrospective pattern than seen in previous years. The Mohn’s rho appears to exceed the rule of thumb guideline of 0.20 for long-lived stocks proposed by Hurtado-Ferro at al. (2015), which includes flatfish. The rule of thumb is that values of Mohn’s rho higher than 0.20 or lower than -0.15 may be an indication of a retrospective pattern.

In the 2017 assessment it was demonstrated that low values of Mohn’s rho and desirable retrospective patterns of female spawning biomass were obtainable if lower values of $M$ and $q$ were used relative to the base model.  The Plan Team and SSC requested a plot of the model-estimated female spawning biomass trajectory that reduced the retrospective pattern using $M$ fixed at 0.09 and $q$=1.0 on top of the estimated female spawning biomass trajectory with confidence interval from the assessment.  

The retrospective technique may not always be the best tool for model selection, at least for BSAI Yellowfin Sole as there is tension between model fit and good retrospective pattern over the range of parameterization examined. In 2017 the Plan Team recommended that the assessment continue to explore the retrospective patterns in relation to $M$ and $q$ by profiling over a range of combinations of $M$ and $q$ and recording the resulting values of Mohn’s rho and also total likelihood.  Profiling over $M$ and $q$ was performed in the 2018 assessment. The best retrospective patterns did not occur at corresponding best model fit values The retrospective technique may not always be the best tool for model selection, at least for BSAI Yellowfin Sole as there is tension between model fit and good retrospective pattern over the range of parameterization examined.

# Risk Table

## Assessment related considerations

The BSAI Yellowfin Sole assessment is based on surveys conducted annually on the EBS shelf from 1982-2019, continually except for 2020 due to the COVID-19 pandemic.  Fish ages, derived from otoliths collected during the surveys and the fishery to calculate annual estimates of population and fishery age composition, have been validated.  The assessment model exhibits good fits to all compositional and abundance data and converges to a single minima in the likelihood surface.  Recruitment estimates track strong year-classes that are consistent with the data.  

The retrospective pattern from the current assessment model was less than desirable and has been the subject of some concern for the assessment.  Peculiar to the Yellowfin Sole assessment, in comparison to the northern rock sole and Alaska plaice assessments (that have preferable patterns), is the large amount of variability in the annual survey biomass assessments for this stock due to the temperature-influenced availability to the survey.  This large variability in the annual estimates can contribute to undesirable patterns since the earlier years are not fitting the same highly variable information as the current year.  

The level of uncertainty due to lack of survey data for 2020 was assessed in Bryan et al. 2020. The BSAI yellowfin sole and EBS snow crab models exhibit a negative bias that becomes more negative when the most recent survey data were not included in the assessment model (-.209 to -.0.237). Bias in recruitment was greater for EBS Pacific cod, tanner crab and snow crab and less for BSAI yellowfin, northern rock sole, flathead sole, and Greenland turbot when the most recent survey data was missing from the assessment model (additional ${\sigma^2}$ with no recent survey was 0.001). Based on this analysis, level of uncertainty in the Yellowfin Sole stock is lower than for other species. Regardless, this is the first year that new survey data was not available for Yellowfin Sole, and although uncertainty is expected to increase without survey data, it is relatively low in comparison to other species and does not pose an assessment concern for this one year.

## Population dynamics considerations

Stock assessment model results indicate that Yellowfin Sole total biomass (age 2+) was at low levels during most of the 1960s and early 1970s (700,000-1,000,000 t) after a period of high exploitation.  Sustained above average recruitment from 1967-76 combined with light exploitation resulted in a biomass increase to a peak of 3.6 million t by 1985.  The population biomass has since been in a slow decline as the strong 1981 and 1983 year-classes have passed through the population, with only the 1991, 1995 and 2003 year-classes at levels observed during the 1970s, although the 2006-2010 year-classes all look about average according to the 2018 stock assessment.  The present biomass is estimated at `r 100*round(YFS2$TotBiom[67,2]/YFS2$TotBiom[32,2],2)`% of the peak 1985 level and female spawning biomass is at `r formatC(round(FSB_next,0),big.mark=",",format="d")` t, while $B_{MSY}$ is estimated at `r formatC(round(Bmsy_next,0),big.mark=",",format="d")` t.  Projections indicate that the $FSB$ will remain well-above the $B_{MSY}$ level through 2033 (`r figure_nums("fishingavgF",display="cite")`).  Population dynamics are not a concern for this assessment.

## Environmental/ecosystem considerations

Following two years of physical oceanographic perturbations, the eastern Bering Sea experienced a return to near-normal climatic conditions in 2020. Summer bottom temperatures and spatial extent of the cold pool were average based on the ROMS hindcast model and observations from the 2020 Dyson cruise. However, summer sea surface temperatures through August were above average in the southern and northern Bering Sea, similar to those observed in 2019 (Siddon 2020). 

Yellowfin Sole (YFS) demonstrate earlier migration to spawning grounds and spawning events in warm years, also somatic growth increases in warmer temperatures. In 2019, fish condition (as measured by length-weight residuals [updated method]) was positive in the southeastern Bering Sea (SEBS) and NBS and continued upward trends since 2017 in both areas (Rohan and Lahman 2020). The mean length of the groundfish community increased in 2019 and was buoyed by prominent species including Yellowfin Sole, which had above average mean length (Whitehouse 2020).

The 2019 distribution of age-classes showed older/larger fish over the southern shelf and younger/smaller fish over the northern shelf (L. Britt, pers comm). This indicates favorable growth and survival of juvenile YFS in the NBS. A proposed thermal window (Yeung et al. In Prep.) suggests continued warming over the EBS shelf may result in temperatures above the thermal physiological maximum of YFS. Such high temperatures in juvenile habitats (i.e., inner domain) could negatively affect production of YFS, which may be adapted to colder temperatures.

The dominant prey of YFS are polychaete worms, miscellaneous worms, clams, and benthic amphipods. Direct measurements of infaunal abundance trends are not available, however, abundance trends of motile epifauna that also consume infauna (i.e., indirect measurements) are quantified from the NOAA AFSC bottom trawl survey. The biomass of motile epifauna (e.g., brittle stars, urchins, sand dollars) remained above the long-term mean in 2019, although decreased 10% from 2018. This suggests sufficient prey availability for YFS over the southern Bering Sea shelf (Whitehouse 2019). 

Predators of YFS include Pacific cod and Pacific halibut. In 2019, the abundance and biomass of Pacific cod increased across the eastern Bering Sea, especially in abundance indicating successful recruitment of early age classes (L. Britt, Sept. GPT presentation). This dramatic increase of predators over the shelf suggests potential increased risk of predation, although size, spatial, and/or temporal mismatches may exist and provide refuge for YFS. 

Competitors for YFS prey resources in the northern Bering Sea may include gray whales (e.g., benthic amphipods). Since January 2019, a total of 213 gray whale strandings have been reported, with 49 of those within Alaska. An Unusual Mortality Event was declared for gray whales in 2019 (see K. Savage ‘Noteworthy’ in the 2019 Eastern Bering Sea Ecosystem Status Report for more information). Gray whale life history includes annual migrations of up to 20,000 km from summer feeding grounds in the northern Bering and Chukchi seas to southern Baja California to mate and calve. Preliminary findings in several of the whales shows evidence of emaciation; benthic prey (primarily amphipods) in the Bering, Chukchi, and Beaufort seas are a main prey source. The 2019 strandings may reflect 2018 conditions (prior to their migration) of poor feeding or competition for limited prey resources and/or indicate thresholds in the carrying capacity of the northern Bering Sea ecosystem.

Together, the most recent data available suggest there are no apparent ecosystem concerns--level 1. The main points are summarized below:

* Summer bottom temperatures and spatial extent of the cold pool were average, indicating a cooler thermal experience for YFS, which may be adapted to colder temperatures, than in recent years.
* In 2019, YFS condition (weighted length-weight residuals) was positive in the SEBS and NBS and continued upward trends since 2017;
*	The mean size of the groundfish community increased in 2019 buoyed by species including YFS, which had above average mean length;
*	YFS abundance and biomass remained below the long-term mean over the southern shelf;
*	YFS abundance and biomass increased between 2017 and 2019 over the northern shelf;
*	Indirect measurements of prey availability suggest sufficient prey availability for YFS over the southern Bering Sea shelf;
*	Increase of predators over the eastern Bering Sea shelf indicates increased risk of predation, although size, spatial, and/or temporal mismatches may exist and provide refuge for YFS;
*	2019 gray whale Unusual Mortality Event reflects poor feeding conditions in the northern Bering Sea during 2018.

## Fishery performance considerations

Recent surveys of the northern Bering sea have not indicated a large shift in the spatial distribution of the eastern Bering Sea stock of Yellowfin Sole. If the stock moves northward out of the eastern Bering Sea under climate change into untrawlable areas in the northern Bering sea, then fisheries would be unable to target the stock in the untrawlable zone. A NOAA Coastal and Oceans Climate Applications proposal will be submitted examine the implications to the fishery and the region of the northern Bering Sea if the stock of Yellowfin Sole shifts northward. At the current time, fishery CPUE is not showing a contrasting pattern from the stock biomass trend, unusual spatial pattern of fishing, or changes in the percent of TAC taken, changes in the duration of fishery openings.

Several other fishery performance considerations are as follows:

* Landings of benthic foragers (including YFS) remained relatively stable through 2018.
*	Landings of benthic forager flatfish may be larger than salmon, but salmon ex-vessel value is higher because it commands a higher price.
*	Revenues from benthic forager flatfish (including YFS) decreased from 2012-2015 as a result of decreased prices; since 2015 price increases have increased value while landings have remained stable.


\begin{table}[ht]
\centering
\begin{tabular}{ p{3cm}p{3cm}p{3cm}p{3cm}p{3cm} }
\hline
 Assessment \newline consideration & Population \newline dynamics & Environmental \newline ecosystem & Fishery \newline performance & Overall \\
\hline
 Level 1: Only minor, low level of concern & Level 1: Stock trends are typical for the stock and expected given stock dynamics; recent recruitment is within the normal range. & Level 1: Stock trends are typical for the stock and expected given stock dynamics; recent recruitment is within the normal range. & Level 1: No apparent environmental/ecosystem concerns & Level 1: Normal. \\ 
\hline
\end{tabular}
\end{table}

No changes are recommended to the ABC, based on this risk table assessment.

## Harvest Recommendations
```{r,echo=FALSE}
library(knitr)

thisyr    = 2020
```

_Scenario Projections and Two-Year Ahead Overfishing Level_

In addition to the seven standard harvest scenarios, Amendments 48/48 to the BSAI and GOA Groundfish Fishery Management Plans require projections of the likely OFL two years into the future.  The `r thisyr` numbers at age from the stock assessment model are projected to `r thisyr` given the `r thisyr-1` catch and then a `r thisyr` catch of `r formatC(cn10,format="d",big.mark=",")` t was applied to the projected `r thisyr` population biomass to obtain the `r thisyr+1` OFL. 

The SSC determined in December 2006 that Yellowfin Sole would be managed under the Tier 1 harvest guidelines, and therefore future harvest recommendations would be based on maximum sustainable yield $MSY$ and the associated fishing effort $F_{MSY}$ values calculated from a spawner-recruit relationship.  $MSY$ is an equilibrium concept and its value is dependent on both the spawner-recruit estimates which are assumed to represent the equilibrium stock size-recruitment relationship and the model used to fit the estimates.  In the Yellowfin Sole stock assessment model, a Ricker form of the stock-recruit relationship was fit to various combinations of these data and estimates of $F_{MSY}$ and $B_{MSY}$ were calculated, assuming that the fit to the stock-recruitment data represents the long-term productivity of the stock (details provided in Wilderbuer et al. 2018). The `r thisyr+1`  ABC is calculated using Tier 1 methodology. The Tier 1 harvest level is calculated as the product of the harmonic mean of $F_{MSY}$ and the geometric mean of the `r thisyr+1`  biomass estimate.

The geometric mean of the `r thisyr+1`  biomass estimate, $B_{gm}$, is estimated using the equation  $B_{gm}=e^{ln(B)-(cv^2/2)},$ 
where  $B$ is the point estimate of the `r thisyr+1`  biomass from the stock assessment model and $cv^2$ is the coefficient of variation of the point estimate (a proxy for sigma). The harmonic mean of $F_{MSY}$, $F_{har}$ is estimated as $F_{har}=e^{ln(F_{MSY}-(ln(sd^2)/2)}$, where $F_{MSY}$ is the peak mode of the $F_{MSY}$ distribution and $sd^2$ is the square of the standard deviation of the $F_{MSY}$ distribution.

In 2006 the SSC selected the 1978-2001 data set for the Tier 1 harvest recommendation.  Using this approach for the `r thisyr+1` harvest (now the 1978-2014 time-series) recommendation (Model 18.2), the $F_{ABC}$ =  $F_{Hmean}$ = `r FABC_this`. The estimate of age 6+ total biomass for `r thisyr+1` is `r TotBio_thisF` t. The calculations outlined above give a Tier 1 ABC harvest recommendation of `r ABC_thisF` t and an OFL of `r OFL_thisF` t for `r thisyr+1`.  This results in an `r 100*(1-round(ABC_this/OFL_this,2))` % (`r formatC(OFL_this-ABC_this,format="d",big.mark=",")` t) buffer between ABC and OFL. 

The stock assessment analysis must also consider harvest limits, usually described as overfishing fishing mortality levels with corresponding yield amounts. Amendment 56 to the BSAI FMP sets the Tier 1 harvest limit at the $F_{MSY}$ fishing mortality value.  The overfishing fishing mortality values, ABC fishing mortality values and their corresponding yields are given as follows:

Harvest level	                            F value      `r thisyr+1`  Yield    
----------------------------------------- ------------ --------------------
Tier 1 $F_{OFL}$ = $F_{MSY}$              `r FOFL_this`        `r OFL_thisF` t         
Tier 1 $F_{ABC}$ = $F_{harmonic_mean}$    `r FABC_this`        `r ABC_thisF` t
----------------------------------------------------------------

A complete record of catch, ABC, and OFL since 1980 is available in `r table_nums("ABCOFL",display="cite")`.

\pagebreak

_Status Determination_

A standard set of projections is required for each stock managed under Tiers 1, 2, or 3 of Amendment 56.  This set of projections encompasses seven harvest scenarios designed to satisfy the requirements of Amendment 56, the National Environmental Policy Act, and the Magnuson-Stevens Fishery Conservation and Management Act (MSFCMA), which was implemented in 1977.

For each scenario, the projections begin with the vector of `r thisyr` numbers at age estimated in the assessment. This vector is then projected forward to the beginning of `r thisyr+1` using the schedules of natural mortality and selectivity described in the assessment and the best available estimate of total (year-end) catch for `r thisyr`. In each subsequent year, the fishing mortality rate is prescribed on the basis of the spawning biomass in that year and the respective harvest scenario. In each year, recruitment is drawn from an inverse Gaussian distribution whose parameters consist of maximum likelihood estimates determined from recruitments estimated in the assessment. Spawning biomass is computed in each year based on the time of peak spawning and the maturity and weight schedules described in the assessment. Total catch is assumed to equal the catch associated with the respective harvest scenario in all years. This projection scheme is run 1,000 times to obtain distributions of possible future stock sizes, fishing mortality rates, and catches.

Five of the seven standard scenarios will be used in an Environmental Assessment prepared in conjunction with the final SAFE.  These five scenarios, which are designed to provide a range of harvest alternatives that are likely to bracket the final TAC for `r thisyr+1`, are as follows (max $F_{ABC}$ refers to the maximum permissible value of $F_{ABC}$ under Amendment 56):

* Scenario 1:  In all future years, $F$ is set equal to max $F_{ABC}$.  (Rationale:  Historically, $TAC$ has been constrained by ABC, so this scenario provides a likely upper limit on future TACs.)
* Scenario 2:  In all future years, F is set equal to a constant fraction of max $F_{ABC}$, where this fraction is equal to the ratio of the $F_{ABC}$ value for 2019 recommended in the assessment to the max $F_{ABC}$ for `r thisyr+1`.  (Rationale:  When $F_{ABC}$ is set at a value below max $F_{ABC}$, it is often set at the value recommended in the stock assessment.)
* Scenario 3:  In all future years, $F$ is set equal to the `r thisyr-5` - `r thisyr-1` average $F$.  (Rationale:  For some stocks, $TAC$ can be well below ABC, and recent average $F$ may provide a better indicator of $F_{TAC}$ than $F_{ABC}$.)
* Scenario 4:  In all future years, $F$ is set equal to $F_{60}$%. (Rationale: This scenario
provides a likely lower bound on $F_{ABC}$ that still allows future harvest rates to be adjusted downward when stocks fall below reference levels.)
* Scenario 5:  In all future years, $F$ is set equal to zero.  (Rationale:  In extreme cases, $TAC$ may be set at a level close to zero.)

Two other scenarios are needed to satisfy the MSFCMA’s requirement to determine whether a stock is currently in an overfished condition or is approaching an overfished condition.  These two scenarios are as follow (for Tier 3 stocks, the $MSY$ level is defined as $B_{35\%}$):

* Scenario 6:  In all future years, F is set equal to $F_{OFL}$.  (Rationale:  This scenario determines whether a stock is overfished.  If the stock is expected to be above its $MSY$ level in 2016 and above its $MSY$ level in 2030 under this scenario, then the stock is not overfished.)
* Scenario 7:  In `r thisyr+1` and `r thisyr+2`, $F$ is set equal to max $F_{ABC}$, and in all subsequent years, F is set equal to FOFL.  (Rationale:  This scenario determines whether a stock is approaching an overfished condition.  If the stock is expected to be above its $MSY$ level in `r thisyr+13` under this scenario, then the stock is not approaching an overfished condition.)

Simulation results shown in `r table_nums("projection",display="cite")` indicate that Yellowfin Sole are not currently overfished and are not approaching an overfished condition.  If fishing continues at the same fishing mortality as in the past 5 years, the stock is projected to remain well above $B_{MSY}$ (`r figure_nums("fishingavgF",display="cite")`). A phase plane figure of the estimated time-series of Yellowfin Sole female spawning biomass (FSB) relative to the harvest control rule indicates that the stock is above $B_{MSY}$, has been consistently fished below $F_{MSY}$ for decades, and that projections of female spawning biomass are also expected to be above $B_{MSY}$ (`r figure_nums("phaseplane",display="cite")`). The ABC and OFL for `r thisyr+1` and `r thisyr+2` assuming average catch rates are shown in the following table.


Year	 Catch	    FSB	              Geom. mean 6+ biomass	    ABC	            OFL
----- --------- ----------------- ------------------------- --------------- ---------
`r thisyr+1`	 `r formatC(cn10,format="d",big.mark=",")`	  `r FSB_thisF` 	        `r TotBio_thisF`	           `r ABC_thisF`      `r OFL_thisF`
`r thisyr+2`	 `r formatC(cn10,format="d",big.mark=",")`	  `r FSB_nextF`	         `r TotBio_nextF`	           `r ABC_nextF`      `r OFL_nextF`
-------------------------------------------------------------

Based on the 2020 assessment Model 18.2, an F=0.16348 would have produced a 2019 catch equal to the 2019 OFL. 

# Ecosystem Considerations

## Ecosystem Effects on the Stock

_Prey availability/abundance trends_

Yellowfin Sole diet by life stage varies as follows:  Larvae consume plankton and algae, early juveniles consume zooplankton, late juvenile stage and adults prey includes bivalves, polychaetes, amphipods, mollusks, euphausids, shrimps, brittle stars, sculpins and miscellaneous crustaceans.  Information is not available to assess the abundance trends of the benthic infauna of the Bering Sea shelf.  The original description of infaunal distribution and abundance by Haflinger (1981) resulted from sampling conducted in 1975 and 1976 and has not been re-sampled since.  The large populations of flatfish which have occupied the middle shelf of the Bering Sea over the past twenty-five years for summertime feeding do not appear food-limited.  These populations have fluctuated due to the variability in recruitment success which suggests that the primary infaunal food source has been at an adequate level to sustain the Yellowfin Sole resource. 

_Predator population trends_

As juveniles, it is well-documented from studies in other parts of the world that flatfish are prey for shrimp species in near shore areas.  This has not been reported for Bering Sea yellowfn sole due to a lack of juvenile sampling and collections in near shore areas, but is thought to occur.  As late juveniles they have been found in stomachs of Pacific cod and Pacific halibut; mostly small Yellowfin Sole ranging from 7 to 25 cm standard length..

Past, present and projected future population trends of these predator species can be found in their respective SAFE chapters in this volume and also from Annual reports compiled by the International Pacific Halibut Commission.  Encounters between Yellowfin Sole and their predators may be limited since their distributions do not completely overlap in space and time.

_Changes in habitat quality_

Changes in the physical environment which may affect Yellowfin Sole distribution patterns, recruitment success and migration timing patterns are catalogued in the Ecosystem Considerations Report of this SAFE report.  Habitat quality may be enhanced during years of favorable cross-shelf advection (juvenile survival) and warmer bottom water temperatures with reduced ice cover (higher metabolism with more active feeding).

## Fishery Effects on the Ecosystem 

1. The Yellowfin Sole target fishery contribution to the total bycatch of other target species is shown for 1992-2019 in `r table_nums("bycatch1",display="cite")`, and bycatch of the Other Species group (Octopus,Shark, Skate, Squid, and Sculpin) are presented in `r table_nums("bycatch2",display="cite")`. The catch of non-target species from 2003-2019 is shown in `r table_nums("bycatch3",display="cite")`.  The Yellowfin Sole target fishery contribution to the total bycatch of prohibited species is summarized for 2015 as follows:

Prohibited species 	                  Yellowfin Sole fishery % of total bycatch
------------------------------------- ----------------------------------------------
Halibut mortality	                    30
Herring	                              2
Red King crab	                        5
C. bairdi	                            25.5
Other Tanner crab	                    78.2
Salmon	                               <1
------------------------------------------

2.	Relative to the predator needs in space and time, the Yellowfin Sole target fishery has a low selectivity for fish 7-25 cm and therefore has minimal overlap with removals from predation.

3.	The target fishery is not perceived to have an effect on the amount of large size target fish in the population due to its history of light to moderate exploitation (6%) over the past 30 years.  Population age composition data indicate a large 20+ age group.

4.	Yellowfin Sole fishery discards are presented in the Catch History section.

5.	It is unknown what effect the fishery has had on Yellowfin Sole maturity-at-age and fecundity, but based on two maturity studies conducted 20 years apart, it is expected to be minimal.

6.	Analysis of the benthic disturbance from the Yellowfin Sole fishery is available in the Preliminary draft of the Essential Fish Habitat Environmental Impact Statement and summarized in `r table_nums("eco",display="cite")`.

# Data Gaps and Research Priorities

Genetic studies are needed to confirm the assumption that Yellowfin Sole consist of a single stock throughout the Bering Sea. Additional studies of maturity at age throughout the range of Yellowfin Sole (including the northern Bering Sea) are also warranted. 

In addition, research is needed to study the spatial variation in juvenile flatfish growth and condition in relation to habitat quality in the Bering Sea. The bottom trawl used in the Bering Sea surveys is not efficient in retaining animals of size $\leq$ 14 cm (Kotwicki et al. 2017).  In recent studies where the 83-112 bottom trawl and the 3-m plumb staff beam trawl were fished consecutively at a survey station, the catch per unit effort (CPUE, number/hectare) of juvenile Yellowfin Sole ($\leq$ 16 cm) estimated from the bottom trawl can be lower than the CPUE from the beam trawl by as high as an order of magnitude, or erroneously indicate absence (Yeung, unpubl. data). As a result of the low catch of small fish in the surveys, there is high uncertainty at the left tail of the age-length curve.  The age-at-length from otolith analysis of juveniles collected with the beam trawl (n=84) was consistently older by 1-3 years than the estimated age using the survey-derived age-length key (Matta and Yeung, unpubl. data), suggesting that currently the age of juveniles may have been underestimated.  Juvenile Yellowfin Sole are known historically to be concentrated in shallow, nearshore habitats near Kuskokwim and Togiak Bays in the EBS that are out of bottom-trawl survey range, just as the NBS surveys now showed them in high abundance in habitat of such type in Norton Sound in the NBS.  Long-term, systematic survey of the nearshore with appropriate sampling gear will improve the assessment of the density and distribution of juvenile Yellowfin Sole, and the understanding of the linkages between environmental drivers, habitat quality and usage, and biomass production.  Norton Sound and Kuskokwim-Togiak Bays should be focal areas of investigation for their potential importance as nurseries.  These coastal areas are of high anthropogenic and environmental sensitivity, and are experiencing anomalously high water temperatures because of climate change that are likely to impact fish growth and condition.  To fully assess Yellowfin Sole stock production, the level of connectivity between the EBS and NBS populations will need to be addressed with tools such as tagging, genomics, biomarkers and otolith microchemistry.

\pagebreak
# Literature Cited

Alaska Fisheries Science Center.  2016. Wholesale market profiles for Alaska groundfish and crab fisheries.  134 p. Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv. 7600 Sand Point Way NE. Seattle, WA.

Bakkala, R. G. and V. Wespestad.  1984.  Yellowfin sole.  In R. G. Bakkala and L. resources of the eastern Bering Sea and Aleutian Islands region in 1983, p. 37-60. U.S. Dep. Commer., NOAA Tech. Memo.  NMFS F/NWC-53.

Bakkala, R. G., and T. K. Wilderbuer.  1990.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands     Region as Projected for 1990, p. 60-78.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, Ak 99510.

Bryan, M. Dorn, M., Stockhausen, W., Barbeaux, S., Ianelli, J,. Lowe, S., McGilliard, C., Monnahan, C., Spencer, P., Spies, I. and Thompson, T. 2020. Evaluating the impact of not having recent survey data in Alaska Fisheries Science Center groundfish and crab stock assessment models. https://meetings.npfmc.org/CommentReview/DownloadFile?p=f95ec800-30da-487b-a35a-506c71f5accb.pdf&fileName=Uncertainty_retrospective_Bryanetal.pdf

Clark, W. G., Hare, S. R., Parms, A. M., Sullivan, P, J., Trumble, R. J.  1999.  Decadal changes in growth and recruitment of Pacific halibut (Hipplglossus stenolepis).  Can. J. fish. Aquat. Sci. 56, 242-252.

Dorn, M.W. 1992. Detecting environmental covariates of Pacific whiting _Merluccius productus_ growth using a growth-increment regression model. Fish. Bull. 90:260-275.

Fissel, B. 2020. Flatfish (BSAI) Economic Performance Report for 2019.

Fournier, D. A., H.G. Skaug, J. Ancheta, J. Ianelli, A. Magnusson, M. N. Maunder, A. Nielsen, and J. Sibert.  2012.  AD Model Builder: using automatic differentiation for statistical inference of highly parameterized complex nonlinear models.  Optim. Methods Softw. 27:233-239.

Fournier, D. A. and C.P. Archibald.  1982.  A general theory for analyzing catch-at-age data.  Can. J. Fish Aquat. Sci.  39:1195-1207.

Haflinger, K.  1981.  A survey of benthic infaunal communities of the Southeastern Bering Sea shelf.  In Hood and Calder (editors) The Eastern Bering Sea Shelf: Oceanography and Resources, Vol. 2. P. 1091-1104.  Office Mar. Pol. Assess., NOAA. Univ. Wash. Press, Seattle, Wa 98105.

Hurtado-Ferro, F., Szuwalski, C.S., Valero, J.L., Anderson, S.C., Cunningham, C.J., Johnson, K.F., Licandeo, R., McGilliard, C.R., Monnahan, C.C., Muradian, M.L. and Ono, K., 2015. Looking in the rear-view mirror: bias and retrospective patterns in integrated, age-structured stock assessment models. ICES Journal of Marine Science, 72(1), pp.99-110.

Ianelli, J. N. and D. A. Fournier.  1998.  Alternative age-structured analyses of the NRC simulated stock assessment data.  In Restrepo, V. R. [ed.]  Analyses of simulated data sets in support of the NRC study on stock assessment methods.  NOAA Tech. Memo.  NMFS-F/SPO-30.  96 p.

Ianelli, J. N., Fissel, B., Holsman, K., Honkalehto, T., Kotwicki, S., Monnahan, C., Siddon, E., Stienessen, S., and Thorson, J. 2019. Assessment of the Walleye Pollock Stock in the Eastern Bering Sea. NPFMC Bering Sea and Aleutian Islands Stock Assessment and Fishery Evaluation. https://www.afsc.noaa.gov/REFM/Stocks/assessments.htm. 

Kastelle, C., T. Helser, S. Wischniowski, T. Loher, B. Geotz and L. Kautzi.  2016. Incorporation of bomb-produced 14C into fish otoliths: A novel approach for evaluating age validation and bias with an application to yellowfin sole and northern rockfish. Ecological modeling 320 (2016) 79-91.

Kimura, D.K. 1989. Variability in estimating catch-in-numbers-at-age and its impact on cohort analysis. In R.J. Beamish and G.A. McFarlane (eds.), Effects on ocean variability on recruitment and an evaluation of parameters used in stock assessment models. Can. Spec. Publ. Fish. Aq. Sci. 108:57-66.

Kotwicki, S., Lauth, R. R., Williams, K., and Goodman, S. E. 2017. Selectivity ratio: A useful tool for comparing size selectivity of multiple survey gears. Fisheries Research, 191: 76-86.

Low, L. and R.E. Narita.  1990.  Condition of groundfish resources in the Bering Sea-Aleutian Islands region as assessed in 1988.  U.S. Dep. Commer., NOAA Tech. Memo.  NMFS-F/NWC-178, 224 p.

Matta, M. E., B. A. Black and T. K. Wilderbuer.  2010.  Climate-driven synchrony in otolith growth-increment chronologies for three Bering Sea flatfish species.  MEPS, Vol. 413:137-145, 2010.

Maunder, M.N. and Wong, R.A., 2011. Approaches for estimating natural mortality: application to summer flounder (_Paralichthys dentatus_) in the US mid-Atlantic. Fisheries Research, 111(1-2), pp.92-99.

Nichol, D. R .  1995.  Spawning and maturation of female yellowfin sole in the eastern Bering Sea.  In Proceedings of the international flatfish symposium, October 1994, Anchorage, Alaska, p. 35-50.  Univ. Alaska, Alaska Sea Grant Rep. 95-04.

Nichol, D. R.  1998.  Annual and between sex variability of yellowfin sole, Pleuronectes asper, spring-summer distributions in the eastern Bering Sea.  Fish. Bull., U.S. 96: 547-561.

Nichol, D.G., Kotwicki, S., Wilderbuer, T.K., Lauth, R.R. and Ianelli, J.N., 2019. Availability of yellowfin sole Limanda aspera to the eastern Bering Sea trawl survey and its effect on estimates of survey biomass. Fisheries Research, 211, pp.319-330.

O’Leary, C.A., Thorson, J.T., Ianelli, J.N. and Kotwicki, S., 2020. Adapting to climate‐driven distribution shifts using model‐based indices and age composition from multiple surveys in the walleye pollock (_Gadus chalcogrammus_) stock assessment. Fisheries Oceanography, 29(6), pp.541-557.

Ricker, W. E.  1958.  Handbook of computations for biological statistics of fish populations.  Bull. Fish. Res. Bd. Can.,  (119) 300 p.

Rohan, S., and Laman, N., 2020. Eastern and Northern Bering Sea Groundfish Condition. In Siddon, E.C., 2020. Ecosystem Status Report 2020: Eastern Bering Sea, Stock Assessment and Fishery Evaluation Report, North Pacific Fishery Management Council, 1007 West Third, Suite 400, Anchorage, Alaska 99501   
Rose, C. S., J. R. Gauvin and C. F. Hammond.  2010. Effective herding of flatfish by cables with minimal seafloor contact.  Fishery Bulletin 108(2):136-144.

Savage, K., 2020. 2019-2020 Gray Whale Unusual Mortality Event. In Siddon, E.C., 2020. Ecosystem Status Report 2020: Eastern Bering Sea, Stock Assessment and Fishery Evaluation Report, North Pacific Fishery Management Council, 1007 West Third, Suite 400, Anchorage, Alaska 99501   

Siddon, E.C., 2020. Ecosystem Status Report 2020: Eastern Bering Sea, Stock Assessment and Fishery Evaluation Report, North Pacific Fishery Management Council, 1007 West Third, Suite 400, Anchorage, Alaska 99501   

Somerton, D. A. and P. Munro.  2001.  Bridle efficiency of a survey trawl for flatfish.  Fish. Bull. 99:641-652 (2001).

Somerton, D., Weinberg, K., Munro, P., Rugolo, L. and Wilderbuer, T., 2018. The effects of wave-induced vessel motion on the geometry of a bottom survey trawl and the herding of yellowfin sole (Limanda aspera). Fishery Bulletin, 116(1).

TenBrink, T. T. and T. K. Wilderbuer.  2015.  Updated maturity estimates for flatfishes (Pleuronectidae) in the eastern Bering Sea, with notes on histology and implications to fisheries management.  Coastal and Marine Fisheries: Dynamics, Management and Ecosystem Science. O:1-9. 2015. DOI: 10.1080/19425120.2015.1091411.

Thorson, J.T., Kristensen, K., 2016. Implementing a generic method for bias correction in statistical models using random effects, with spatial and population dynamics examples. Fish. Res. 175, 66–74. https://doi.org/10.1016/j.fishres.2015.11.016

Thorson, J.T., 2018. Three problems with the conventional delta-model for biomass sampling data, and a computationally efficient alternative. Can. J. Fish. Aquat. Sci. 75, 1369–1382. https://doi.org/10.1139/cjfas-2017-0266

Thorson, J.T., 2019. Measuring the impact of oceanographic indices on species distribution shifts: The spatially varying effect of cold-pool extent in the eastern Bering Sea. Limnol. Oceanogr. 64, 2632–2645. https://doi.org/10.1002/lno.11238

Wakabayashi, K.   1989.  Studies on the fishery biology of yellowfin sole in the eastern Bering Sea. [In Jpn., Engl. Summ.] Bull. Far Seas Fish. Res. Lab. 26:21-152.

Walters, G. E. and T. K. Wilderbuer.  2000.  Decreasing length at age in a rapidly expanding population of northern rock sole in the eastern Bering Sea and its effect on management advice.  Journal of Sea Research 44(2000)17-26.

Whitehouse, G.A., 2019. 2019 Report Card. In Siddon, E., and Zador, S., 2019. Ecosystem Status Report 2019: Eastern Bering Sea, Stock Assessment and Fishery Evaluation Report, North Pacific Fishery Management Council, 605 W 4th Ave, Suite 306, Anchorage, AK 99501.

Whitehouse, G.A., 2020. Mean Length of the Fish Community. In Siddon, E.C., 2020. Ecosystem Status Report 2020: Eastern Bering Sea, Stock Assessment and Fishery Evaluation Report, North Pacific Fishery Management Council, 1007 West Third, Suite 400, Anchorage, Alaska 99501   

Wilderbuer, T.K., G.E. Walters, and R.G. Bakkala   1992.  Yellowfin sole, _Pleuronectes aspera_, of the eastern Bering Sea: biological characteristics, history of exploitation, and management.  Mar Fish. Rev. 54(4):1-18.

Wilderbuer, T.K. and Turnock, B.J., 2009. Sex-specific natural mortality of arrowtooth flounder in Alaska: Implications of a skewed sex ratio on exploitation and management. North American Journal of Fisheries Management, 29(2), pp.306-322.

Wilderbuer, T. K. and D. Nichol.  2003.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2004, chapter 4.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, Ak  99510.

Wilderbuer, T. K. D. G. Nichol, and J. Ianelli.  2018.  Yellowfin sole.  In Stock Assessment and Fishery Evaluation Document for Groundfish Resources in the Bering Sea/Aleutian Islands Region as Projected for 2019, chapter 4.  North Pacific Fishery Management Council, P. O. Box 103136, Anchorage, Ak  99510.

Yeung, C., Copeman, L. A., Matta, M. E., Yang, M.-S. In Prep. Latitudinal variation in the growth and condition of juvenile flatfishes in the Bering Sea.




```{r, echo=FALSE, hierarchy}



tab.14_cap <- table_nums(name = "tab_14", caption = "Model estimates of annual average fishing mortality for male and female Yellowfin Sole.")

tab.15_cap <- table_nums(name = "tab_15", caption = "Model estimates of Yellowfin Sole full selection fishing mortality and exploitation rate (catch/total biomass).")


tab.20_cap <- table_nums(name = "tab_20", caption = "Model estimates of Yellowfin Sole age 5 recruitment (millions) from the 2017 and 2018 stock assessments.")


tab.24_cap <- table_nums(name = "tab_24", caption = "Estimated non-target species catch (t) in the Yellowfin Sole fishery, 2003-2018 (PSC not included).")



tab.27_cap <- table_nums(name = "tab_27", caption = "Catch and bycatch (t) of other BSAI target species in the Yellowfin Sole directed fishery from 1992-2016 estimated from a combination of regional office reported catch and observer sampling of the catch.")




```

\pagebreak
# Tables

`r table_nums(name = "catch", caption = paste("Foreign and domestic catch (t) of Yellowfin Sole 1954-",thisyr,".  Foreign catches are designated as joint venture processing (JVP) and domestic annual processing (DAP). Domestic catch since 1991 is subdivided into catch from the Aleutian Islands and the Bering Sea. Catch for ",thisyr," was downloaded November 15, 2020.",sep=""))`
```{r catch,message=FALSE,echo=FALSE}
catchZ=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/catch_YFS.csv",header=TRUE,skip=1)
colnames(catchZ)=c("Year","Foreign","JVP","DAP","Aleutian Islands","Bering Sea","Total")
kable(catchZ,"latex",booktabs=T,linesep="",longtable=TRUE,align=c('r','r','r','r','r','r','r'))%>%
  add_header_above(c(" ", " ","Domestic" = 4, " " ))
```

\pagebreak
`r table_nums(name = "retdis", caption = paste("Estimates of retained and discarded (t) Yellowfin Sole caught in Bering Sea fisheries from 1991 through October 12th, ",thisyr,", and the proportion discarded.",sep=""))`
```{r retdis,message=FALSE,echo=FALSE}
retdis=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/RetDis_2020.csv",header=TRUE)#Oct. 12 2020
Year=names(table(retdis$Year))
rdtable_full=matrix(0,length(Year),3)
colnames(rdtable_full)=c("Year","Retained (t)","Discarded (t)")
rdtable_full[,1]=Year
for (i in 1:length(Year)){
 rdtable_full[i,2]=round(sum(retdis$Retained..mt.[which(retdis$Year==Year[i])]))
 rdtable_full[i,3]=round(sum(retdis$Discards..mt.[which(retdis$Year==Year[i])]))
}
ret=formatC(as.numeric(as.character(rdtable_full[,2])),format="d",big.mark=",")
dis=formatC(as.numeric(as.character(rdtable_full[,3])),format="d",big.mark=",")
prop=round(as.numeric(as.character(rdtable_full[,3]))/(as.numeric(as.character(rdtable_full[,2]))+as.numeric(as.character(rdtable_full[,3]))),2)

rdfull=cbind(Year,ret,dis,prop)
colnames(rdfull)=c("Year","Retained (t)","Discarded (t)","Proportion discarded")

kable(rdfull,"latex",booktabs=T,linesep="",longtable=TRUE,align='r')
```

\pagebreak
`r table_nums(name = "retdiscat", caption = paste("Discarded and retained catch of non-CDQ Yellowfin Sole, by fishery, in ",thisyr-1,". Gear types include longline (HAL), bottom trawl (NPT), pot (POT), and pelagic trawl (PTR). Catch was non-zero for all target-gear combinations shown, but may appear as zero as results were rounded to the nearest metric ton (t). Source: NMFS AKRO BLEND/Catch Accounting System.",sep=""))`
```{r retdiscat,message=FALSE, echo=FALSE}
#note: get FMP groundfish total discards and discard rate by regulatory area in BSAI
#retdis2018=read.csv(here("/doc/Rmd/retdis2018.csv"),header=TRUE)
retdis2019=retdis[which(retdis$Year=="2019"),]
target=names(table(retdis2019$Target))[2:18]
gear=c("HAL","NPT","POT","PTR")
rdtab=matrix(0,length(target)*4,3)
rownames(rdtab)=rep(target,4)
colnames(rdtab)=c("Gear","Discarded","Retained")
rdtab[,1]=rep(gear,each=length(target))
for(i in 1:length(target)){
 for(j in 1:length(gear)){
 rdtab[i+((j-1)*13),2]=sum(retdis2019$Discards..mt.[which(retdis2019$Target==target[i]&retdis2019$Gear==gear[j])])
 rdtab[i+((j-1)*13),3]=sum(retdis2019$Retained..mt.[which(retdis2019$Target==target[i]&retdis2019$Gear==gear[j])])
 }}
rd=data.frame(rdtab[which((as.numeric(rdtab[,2])+as.numeric(rdtab[,3]))>0),])
rowz=c("Halibut","Other Species","Pacific Cod","Alaska Plaice","Atka Mackerel",
"Greenland Turbot","Halibut","Kamchatka Flounder","Other Species","Pacific Cod","Pollock - bottom",
"Pollock - midwater","Atka Mackerel","Yellowfin Sole")

rd1=cbind(as.character(rowz),as.character(rd[1:14,1]),formatC(round(as.numeric(as.character(rd[1:14,2]))),big.mark=",",format="d"),formatC(as.numeric(as.character(rd[1:14,3])),big.mark=",",format="d"))
colnames(rd1)=c("Trip target name","Gear type","Discarded (t)","Retained (t)")

kable(rd1,"latex",booktabs=T,linesep="",longtable=FALSE,align="r")
```

\pagebreak
`r table_nums(name = "occurrence", caption = "Occurrence of Yellowfin Sole in the eastern Bering Sea trawl survey and collections of length and age structures and the number of otoliths aged from the survey. The final column represents the number of otoliths read in each year from the fishery.")`
```{r occurrence}
haul_oto=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Hauls_otoliths.csv",header=TRUE)
colnames(haul_oto)=c("Year","Total hauls","Hauls with length","Number of lengths","Hauls with otoliths","Hauls with ages","N. ages (survey)","N. ages (fishery)")
kable(haul_oto,"latex",booktabs=T,linesep="")%>%kable_styling(latex_options="scale_down")
```

\pagebreak
`r table_nums(name = "catageprop", caption =paste("Yellowfin Sole fishery catch-at-age (proportions), 1975-",thisyr-1," female first then male, ages 7-17+.",sep=""))`
```{r catageprop,message=FALSE,echo=FALSE}
#YFS2$catage_f from 1954-thisyr, want from 1975, ages 7 - 17+
#select 1975 to last year

a=data.frame(seq(1975,thisyr-1,1),round(femcat,4)[22:(nrow(femcat)-1),7:17],rowSums(round(femcat,4)[22:(nrow(femcat)-1),7:17]))
colnames(a)=c("Year",seq(7,16,1),"17+","Total female proportion over age 7")
kable(a,"latex",booktabs=T,linesep="")%>% 
  kable_styling(latex_options="scale_down")

b=data.frame(seq(1975,thisyr-1,1),round(malcat,4)[22:(nrow(malcat)-1),7:17],rowSums(round(malcat,4)[22:(nrow(malcat)-1),7:17]))
colnames(b)=c("Year",seq(7,16,1),"17+","Total male proportion over age 7")
kable(b,"latex",booktabs=T,linesep="")%>% 
  kable_styling(latex_options="scale_down")

```

\pagebreak
`r table_nums(name = "mature", caption = "Female Yellowfin Sole proportion mature at age from Nichol (1995) and TenBrink and Wilderbuer (2015).")`
```{r mature,message=FALSE,echo=FALSE}
mat=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/maturity_T10.csv",header=TRUE)
colnames(mat)=c("Age","1992, 1993 samples","2012 samples","Combined")
kable(mat,"latex",booktabs=T,linesep="")%>%add_header_above(c(" "=1,"Nichol (1995)"=1,"TenBrink and Wilderbuer (2015)"=1,"Total"=1))

```



\pagebreak
`r table_nums(name = "wtagetab", caption = "Mean unsmoothed weight-at-age (grams) for Yellowfin Sole, based on survey data, females presented first, followed by males, 1964-2019.")`
```{r wtagetab}
thisyr=2020 #No new data in 2020
nyrs=length(seq(1964,thisyr-1,1))
wt_f=YFS2$wt_srv_f[11:(nyrs+10),]#YFS2 is the accepted model.
wt_m=YFS2$wt_srv_m[11:(nyrs+10),]
colnames(wt_f)=seq(1,20,1)
rownames(wt_f)=seq(1964,thisyr-1,1)
colnames(wt_m)=seq(1,20,1)
rownames(wt_m)=seq(1964,thisyr-1,1)
print(kable(wt_f,"latex",booktabs=T,linesep="")%>%kable_styling(latex_options="scale_down")%>%add_header_above(c("Year", "Age (Females)"=19 )))

print(kable(wt_m,"latex",booktabs=T,linesep="")%>%kable_styling(latex_options="scale_down")%>%add_header_above(c("Year", "Age (Males)"=19 )))
```




\pagebreak
`r table_nums(name = "Srvbio_CI", caption = "Yellowfin Sole biomass estimates (t) from the annual Bering Sea shelf bottom trawl survey, with upper and lower 95% confidence intervals, based on Model 18.2. Note that this survey was not conducted in 2020.")`
```{r Srvbio_CI, message=FALSE,echo=FALSE}
srvbio=cbind(YFS2$yr_bts,formatC(1000*YFS2$ob_bts,format="d",big.mark=","),formatC(1000*YFS2$ob_bts-1.96*YFS2$sd_ob_bts,format="d",big.mark=","),formatC(1000*YFS2$ob_bts+1.96*YFS2$sd_ob_bts,format="d",big.mark=","))
colnames(srvbio)=c("Year","Biomass (t)","Lower confidence interval","Upper confidence interval")
kable(srvbio,"latex",booktabs=T,linesep="")


```


\pagebreak
`r table_nums(name = "biomCI", caption = paste("Model estimates of Yellowfin Sole age 2+ total biomass (t) from the",thisyr-1," and ",thisyr," stock assessments, Model 18.1, Model 18.1, and 18.2."))`
```{r biomCI, message=FALSE,echo=FALSE}
biom=data.frame(round(1000*YFS2$TotBiom[,c(2,4,5)]),round(1000*YFS1$TotBiom[,c(2,4,5)]),c(formatC(round(1000*YFS0$TotBiom[,2]),format="d",big.mark=",",digits=0),"-"))
colnames(biom)=c("Biomass (t)","LCI","HCI","Biomass (t)","LCI","HCI","Biomass (t)")
rownames(biom)=seq(1954,2020,1)
kable(biom,"latex",booktabs=T,linesep="",format.args=list(format="d",big.mark=","),longtable=TRUE,align="r")%>%add_header_above(c(" "=1,"Model 18.2 (2020)"=3,"Model 18.1 (2020)"=3,"Model 18.1 (2019)"))
```

\pagebreak
`r table_nums(name = "NBS_bio", caption = "Yellowfin Sole biomass estimates (t) from the northern Bering Sea survey, with upper and lower 95% confidence intervals, as well as number of hauls, hauls with Yellowfin Sole, and hauls in which length data was obtained.")`
```{r NBS_bio, message=FALSE,echo=FALSE}
NBSbiomass2019=520028.93
NBSvariance2019=3868517857.3
NBS=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/NBS_YFS.csv",header=TRUE)
colnames(NBS)=c("Year","Biomass (t)","LCI","HCI","Haul count","Hauls with catch","Number count","Length count")
kable(NBS,"latex",booktabs=T,linesep="")
```
 
\pagebreak
`r table_nums(name = "natagesrv", caption = paste("Yellowfin Sole population numbers-at-age (millions) estimated from the annual EBS bottom trawl surveys, 1987-",thisyr-1," (Current year data is not yet available). Data come from the 'plusnw' extended survey area. Females are presented first, followed by males.",sep=""))`
```{r natagesrv}
catage_p=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/survey/yellowfin_sole_agecomp_ebs_plusNW.csv",header=TRUE)
catage_s=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/yfs_agecomp_ebs_standard.csv",header=TRUE)

age=seq(2,17,1)
yrs=names(table(catage_p$YEAR))

catage_f=matrix(0,length(yrs),length(age))
catage_m=matrix(0,length(yrs),length(age))

isEmpty <- function(x) 
 {
 return(identical(x, numeric(0)))
 }

for(i in 1:length(yrs)){
 for(j in 1:16)
 {
  if (yrs[i] %in% c(1982:1986)){
   if(!isEmpty(catage_s$AGEPOP[which(catage_s$YEAR==yrs[i]&catage_s$SEX==2&catage_s$AGE==(j+1)&catage_s$SUBAREA==999999)]))
   {catage_f[i,j]=catage_s$AGEPOP[which(catage_s$YEAR==yrs[i]&catage_s$SEX==2&catage_s$AGE==(j+1)&catage_s$SUBAREA==999999)]}
      if(!isEmpty(catage_s$AGEPOP[which(catage_s$YEAR==yrs[i]&catage_s$SEX==1&catage_s$AGE==(j+1)&catage_s$SUBAREA==999999)]))
    {catage_m[i,j]=catage_s$AGEPOP[which(catage_s$YEAR==yrs[i]&catage_s$SEX==1&catage_s$AGE==(j+1)&catage_s$SUBAREA==999999)]}
  }
  if (yrs[i] >=1987){
   if(!isEmpty(catage_p$AGEPOP[which(catage_p$YEAR==yrs[i]&catage_p$SEX==2&catage_p$AGE==(j+1)&catage_p$STRATUM==999999)]))
  catage_f[i,j]=catage_p$AGEPOP[which(catage_p$YEAR==yrs[i]&catage_p$SEX==2&catage_p$AGE==(j+1)&catage_p$STRATUM==999999)]
      if(!isEmpty(catage_p$AGEPOP[which(catage_p$YEAR==yrs[i]&catage_p$SEX==1&catage_p$AGE==(j+1)&catage_p$STRATUM==999999)]))
  catage_m[i,j]=catage_p$AGEPOP[which(catage_p$YEAR==yrs[i]&catage_p$SEX==1&catage_p$AGE==(j+1)&catage_p$STRATUM==999999)]
  }
 }
}

rownames(catage_f)=yrs
colnames(catage_f)=c(seq(2,16,1),"17+")

print(kable(formatC(catage_f/1000000,format="d",big.mark=","),"latex",booktabs=T,linesep="",align='r')%>%kable_styling(latex_options="scale_down")%>%add_header_above(c("Year", "Age (Females)"=16 )))

rownames(catage_m)=yrs
colnames(catage_m)=c(seq(2,16,1),"17+")

print(kable(formatC(catage_m/1000000,format="d",big.mark=","),"latex",booktabs=T,linesep="",align='r')%>%kable_styling(latex_options="scale_down")%>%add_header_above(c("Year", "Age (Males)"=16 )))

```



\pagebreak
`r table_nums(name = "rescat", caption = paste("Total tonnage of Yellowfin Sole caught in resource assessment surveys in the eastern Bering Sea from 1977-2019."))`
```{r rescat, message=FALSE,echo=FALSE}
rescatch=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/ResearchCatch.csv",header=TRUE)
colnames(rescatch)=c("Year","Research catch (t)")
kable(rescatch,"latex",booktabs=T,linesep="")
```



\pagebreak 


`r table_nums(name="liketab",caption="Comparison of likelihood values for survey and fishery age, selectivity, survey biomass, recruitment, catchability, and total likelihood for Models 18.1 and 18.2.")`
```{r liketab, echo=FALSE}
totallike2=sum(YFS2$wt_like,YFS2$age_likeihood_for_survey,YFS2$age_likelihood_for_fishery,YFS2$catch_likelihood,YFS2$selectivity_likelihood,YFS2$survey_likelihood,YFS2$recruitment_likelilhood) #recommended
totallike1=sum(YFS1$wt_like,YFS1$age_likeihood_for_survey,YFS1$age_likelihood_for_fishery,YFS1$catch_likelihood,YFS1$selectivity_likelihood,YFS1$survey_likelihood,YFS1$recruitment_likelilhood)  
```

\begin{table}[h]
\centering
\begin{tabular}{ lrr }
\hline
 Likelihood component & Model $18.1$ & Model $18.2$ \\
\hline
Survey age	        &       `r round(YFS1$age_likeihood_for_survey,2)`  &  `r round(YFS2$age_likeihood_for_survey,2)`   \\
Fishery age  	  &       `r round(YFS1$age_likelihood_for_fishery,2)` &  `r round(YFS2$age_likelihood_for_fishery,2)`  \\
Selectivity     &       `r round(sum(YFS1$selectivity_likelihood),2)`& `r round(sum(YFS2$selectivity_likelihood),2)`\\
Survey biomass     &       `r round(YFS1$survey_likelihood,2)`& `r round(YFS2$survey_likelihood,2)`\\
Recruitment     &       `r round(sum(YFS1$recruitment_likelilhood),2)`& `r round(sum(YFS2$recruitment_likelilhood),2)`  \\
Catchability & `r round(YFS1$catch_likelihood,4)` & `r round(YFS2$catch_likelihood,4)` \\
\hline
Total              &       `r round(totallike1,2)`      &`r round(totallike2,2)`      \\ 
\hline
\end{tabular}
\end{table}




\pagebreak
`r table_nums(name = "pars", caption = "Parameter values and their 95% confidence intervals, estimated within the preferred stock assessment model, Model 18.2.")`
```{r pars, echo=FALSE,message=FALSE}

pars=as.data.frame(read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.std",header=TRUE))
pars2=pars[c(1:6,113,181,182,317,385,453:458,712:716,727,728,729:795),]

pars3=cbind(pars2[1:45,2:4],c(rep("|",45)),pars2[46:90,2:4])
pars3[,1]=as.character(pars3[,1])
pars3[1:7,1]=c("male natural mortality","alpha (q-temp model)","beta (q-temp model)","beta (survey start date)","beta (start date/temp interaction)","mean log recruitment","log_avg_fmort")

colnames(pars3)=c("Name","Value","Standard Deviation","|","Name","Value","Standard Deviation")
rownames(pars3)=c()
kable(pars3,"latex",booktabs=T,linesep="",align=c("l","r","r","r","l","r","r"))%>%kable_styling(latex_options="scale_down")
       

```


\pagebreak

`r table_nums(name="Mcomparison",caption="Comparison of reference points for Model 18.2, 18.1 (2020), and Model 18.1 (2019) (upper panel), and Models 18.3 and 18.4 (lower panel). Values are in metric tons (t). Female, then male natural mortality is listed for each year and model.")`

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 18.2 (2020)}  & \multicolumn{2}{c}{Model 18.1 (2020)}& \multicolumn{2}{c}{Model 18.1 (2019)}               \\
        Quantity & `r thisyr+1`      &`r thisyr+2`   & `r thisyr+1`      &`r thisyr+2`& `r thisyr`      &`r thisyr+1` \\ 
  \hline
$M$ (natural mortality rate)         &  `r round(YFS2$natmort_f,2)`, `r round(YFS2$natmort_m,3)`  & `r round(YFS2$natmort_f,2)`, `r round(YFS2$natmort_m,3)`  &  `r round(YFS1$natmort_f,2)`, `r round(YFS1$natmort_m,2)`   &  `r round(YFS1$natmort_f,2)`, `r round(YFS1$natmort_m,2)`   &  `r round(YFS1$natmort_f,2)`, `r round(YFS1$natmort_m,2)`   &  `r round(YFS1$natmort_f,2)`, `r round(YFS1$natmort_m,2)`  \\
Tier                                  &  1a   &  1a   &  1a   & 1a &  1a   & 1a   \\
Projected total (age 6+) biomass (t)  &  `r formatC(extra_sd2$GM_Biom[1]*1000,format="d",big.mark=",")`   &  `r formatC(extra_sd2$GM_Biom[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$GM_Biom[2]*1000,format="d",big.mark=",")` &  `r formatC(extra_sd0$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd0$GM_Biom[2]*1000,format="d",big.mark=",")` \\
Projected female spawning biomass (t) &  `r formatC(extra_sd2$SSB[1]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd2$SSB[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$SSB[2]*1000,format="d",big.mark=",")` &  `r formatC(extra_sd0$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd0$SSB[2]*1000,format="d",big.mark=",")` \\
$\:\:\:\:\:\:B_{100\%}$                           &  `r B0_2`  &  `r B0_2`  &  `r B0_1`  & `r B0_1` & `r B0_0`  & `r B0_0`  \\
$\:\:\:\:\:\:B_{MSY\%}$                            &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd0$Bmsy[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd0$Bmsy[1],format="d",big.mark=",")` \\
$F_{OFL}$                             &  `r round(extra_sd2$AM_Fmsyr[1],3)`   &  `r round(extra_sd2$AM_Fmsyr[2],3)`   &  `r round(extra_sd1$AM_Fmsyr[1],3)`  & `r round(extra_sd1$AM_Fmsyr[2],3)`  &  `r round(extra_sd0$AM_Fmsyr[1],3)`  & `r round(extra_sd0$AM_Fmsyr[2],3)` \\
$maxF_{ABC}$                          &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &   `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`    & `r round(extra_sd1$HM_Fmsyr[2],3)` &  `r round(extra_sd0$HM_Fmsyr[1],3)`    & `r round(extra_sd0$HM_Fmsyr[2],3)`    \\
$F_{ABC}$                             &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &  `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`   & `r round(extra_sd1$HM_Fmsyr[2],3)` &  `r round(extra_sd0$HM_Fmsyr[1],3)`   & `r round(extra_sd0$HM_Fmsyr[2],3)`   \\
$OFL$                                 &  `r formatC(1000*extra_sd2$OFL_AM[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$OFL_AM[2],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$OFL_AM[2],format="d",big.mark=",")` &  `r formatC(1000*extra_sd0$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd0$OFL_AM[2],format="d",big.mark=",")`
\\
$maxABC$                              &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd0$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd0$ABC_HM[2],format="d",big.mark=",") ` \\
$ABC$                                 &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") ` & `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd0$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd0$ABC_HM[2],format="d",big.mark=",") ` \\
\hline
Status                               & `r thisyr-1`       & `r thisyr`      &  `r thisyr-1`             & `r thisyr`  &  `r thisyr-1`             & `r thisyr`          \\
\hline
Overfishing                           & No         & n/a       & No                        & n/a     & No                        & n/a                 \\
Overfished                           & n/a         & No       & n/a                        & No         & n/a                        & No                  \\
Approaching overfished               & n/a         & No       & n/a                        & No   & n/a                        & No                  \\
\hline
\end{tabular}
\medskip
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 18.3}  & \multicolumn{2}{c}{Model 18.4}              \\
        Quantity & `r thisyr+1`      &`r thisyr+2`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
$M$ (natural mortality rate)         &  `r round(YFS3$natmort_f,2)`, `r round(YFS3$natmort_m,3)`   & `r round(YFS3$natmort_f,2)`, `r round(YFS3$natmort_m,3)` &  `r round(YFS4$natmort_f,2)`, `r round(YFS4$natmort_m,3)`   &  `r round(YFS4$natmort_f,2)`, `r round(YFS4$natmort_m,3)`    \\
Tier                                  &  1a   &  1a   &  1a   & 1a \\
Projected total (age 6+) biomass (t)  &  `r formatC(extra_sd3$GM_Biom[1]*1000,format="d",big.mark=",")`   &  `r formatC(extra_sd3$GM_Biom[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd4$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd4$GM_Biom[2]*1000,format="d",big.mark=",")`  \\
Projected female spawning biomass (t) &  `r formatC(extra_sd3$SSB[1]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd3$SSB[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd4$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd4$SSB[2]*1000,format="d",big.mark=",")`  \\
$\:\:\:\:\:\:B_{100\%}$                           &  `r B0_3`  &  `r B0_3`  &  `r B0_4`  & `r B0_4`   \\
$\:\:\:\:\:\:B_{MSY\%}$                            &  `r formatC(1000*extra_sd3$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd3$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd4$Bmsy[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd4$Bmsy[1],format="d",big.mark=",")` \\
$F_{OFL}$                             &  `r round(extra_sd3$AM_Fmsyr[1],3)`   &  `r round(extra_sd3$AM_Fmsyr[2],3)`   &  `r round(extra_sd4$AM_Fmsyr[1],3)`  & `r round(extra_sd4$AM_Fmsyr[2],3)` \\
$maxF_{ABC}$                          &  `r round(extra_sd3$HM_Fmsyr[1],3)`   &   `r round(extra_sd3$HM_Fmsyr[2],3)`   &  `r round(extra_sd4$HM_Fmsyr[1],3)`    & `r round(extra_sd4$HM_Fmsyr[2],3)` \\
$F_{ABC}$                             &  `r round(extra_sd3$HM_Fmsyr[1],3)`   &  `r round(extra_sd3$HM_Fmsyr[2],3)`   &  `r round(extra_sd4$HM_Fmsyr[1],3)`   & `r round(extra_sd4$HM_Fmsyr[2],3)`  \\
$OFL$                                 &  `r formatC(1000*extra_sd3$OFL_AM[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd3$OFL_AM[2],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd4$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd4$OFL_AM[2],format="d",big.mark=",")`
\\
$maxABC$                              &  `r formatC(1000*extra_sd3$ABC_HM[1],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd3$ABC_HM[2],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd4$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd4$ABC_HM[2],format="d",big.mark=",") ` \\
$ABC$                                 &  `r formatC(1000*extra_sd3$ABC_HM[1],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd3$ABC_HM[2],format="d",big.mark=",") ` & `r formatC(1000*extra_sd4$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd4$ABC_HM[2],format="d",big.mark=",") ` \\
\hline
Status                               & `r thisyr-1`       & `r thisyr`      &  `r thisyr-1`             & `r thisyr`            \\
\hline
Overfishing                           & No         & n/a       & No                        & n/a                 \\
Overfished                           & n/a         & No       & n/a                        & No                      \\
Approaching overfished               & n/a         & No       & n/a                        & No                 \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections for Model 18.1 were based on estimated catches of 118,642 t in `r thisyr`, and projections for Model 18.2 were based on `r formatC(cn10,format="d",big.mark=",")` t used in place of maximum ABC for `r thisyr+1`. Projections for Models 18.3 and 18.4 were based on estimated catches of `r formatC(cn10,format="d",big.mark=",")` used in place of maximum ABC for `r thisyr+1`.
  \end{tablenotes}
\end{table}



\pagebreak


`r table_nums(name="fmort",caption="Model estimates of Yellowfin Sole full selection fishing mortality (F) and exploitation rate (catch/total biomass).")`
```{r, echo = FALSE, results = 'asis', warning = F}
fm=data.frame(cbind(YFS2$F_f[,18],YFS2$Obs_catch/YFS2$TotBiom[,2],cbind(YFS1$F_f[,18],YFS1$Obs_catch/YFS1$TotBiom[,2])))

colnames(fm)=c("Full selection F","Catch/Total Biomass","Full selection F","Catch/Total Biomass")
rownames(fm)=seq(1954,2020,1)
kable(fm,"latex",booktabs=TRUE,linesep="",align="r",digits=3,longtable=TRUE)%>%add_header_above(c(" "=1,"Model 18.2"=2,"Model 18.1"=2))
```

\pagebreak
`r table_nums(name = "FSBCI", caption = paste("Model estimates of Yellowfin Sole female spawning biomass (FSB) in metric tons (t) and upper (HCI) and lower (LCI) 95% confidence intervals from the",thisyr-1," and ",thisyr," stock assessments, including Model 18.1, 18.1 and 18.2."))`
```{r FSBCI, message=FALSE,echo=FALSE}
biom=data.frame(1000*YFS2$SSB[,c(2,4,5)],1000*YFS1$SSB[,c(2,4,5)],c(formatC(1000*YFS0$SSB[,2],format="d",big.mark=",",digits=0),"-"))
colnames(biom)=c("FSB (t)","LCI","HCI","FSB (t)","LCI","HCI","Biomass (t)")
rownames(biom)=seq(1954,2020,1)
kable(biom,"latex",booktabs=T,linesep="",format.args=list(format="d",big.mark=","),digits=0,align="r",longtable=TRUE)%>%add_header_above(c(" "=1,"Model 18.2"=3,"Model 18.1 (2020)"=3,"Model 18.1 (2019)"))
```


\pagebreak
`r table_nums(name="rec",caption="Model estimates of age 1 recruitment (in billions of fish), 1954-2019, with 95% lower and upper confidence intervals (LCI, HCI) for Model 18.1 and 18.2.")`
```{r rec, message=FALSE,echo=FALSE}
pars1=as.data.frame(read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m1/fm.std",header=TRUE))
pars2=as.data.frame(read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.std",header=TRUE))

age1recpred1=pars1[539:605,3]
age1recstd1=pars1[539:605,4]

age1recpred2=pars2[539:605,3]
age1recstd2=pars2[539:605,4]

rec=data.frame(age1recpred1,age1recpred1-1.96*age1recstd1,age1recpred1+1.96*age1recstd1,age1recpred2,age1recpred2-1.96*age1recstd2,age1recpred2+1.96*age1recstd2)

rownames(rec)=seq(1954,2020,1)
colnames(rec)=c("Recruitment","LCI","HCI","Recruitment","LCI","HCI")
kable(rec,"latex",booktabs=TRUE,linesep="",align="r",digits=3,longtable=TRUE)%>%add_header_above(c("Year"=1,"Model 18.1"=3,"Model 18.2"=3))

```


\pagebreak
`r table_nums(name = "ABCOFL", caption = paste("Yellowfin Sole total allowable catch (TAC), overfishing limit (OFL), and acceptable biological catch (ABC) levels, 1980-2020. Data is in metric tons. Estimates for 2020 are calculated using Model 18.2, and the 2020 TAC has not yet been set."))`
```{r ABCOFL, message=FALSE,echo=FALSE}
ABCOFL=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/YFS_ABCOFL.csv",header=TRUE)


colnames(ABCOFL)=c("Year","TAC","ABC","OFL","Catch")

kable(ABCOFL,"latex",booktabs=TRUE,linesep="",align="r")
```


\pagebreak
`r table_nums(name="projection",caption="Projections of Yellowfin Sole female spawning biomass (FSB), future catch, and full selection fishing mortality rates (F) for seven future harvest scenarios. Estimates of FSB and catch are in metric tons (t). All estimates are based on Model 18.2.")`
```{r, echo = FALSE, results = 'asis', warning = F}
alt12=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt12.csv",header=TRUE,sep=",");colnames(alt12)=c("","Year","FSB","Catch","F")
alt3=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt3.csv",header=TRUE,sep=",");colnames(alt3)=c("","Year","FSB","Catch","F")
alt4=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt4.csv",header=TRUE,sep=",");colnames(alt4)=c("","Year","FSB","Catch","F")
alt5=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt5.csv",header=TRUE,sep=",");colnames(alt5)=c("","Year","FSB","Catch","F")
alt6=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt6.csv",header=TRUE,sep=",");colnames(alt6)=c("","Year","FSB","Catch","F")
alt7=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt7.csv",header=TRUE,sep=",");colnames(alt7)=c("","Year","FSB","Catch","F")


#bigfile=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/bigfile.out",header=TRUE)

#use this function to generate files
#altfn=function(source,alt,thisyr){
# Year=seq(thisyr,thisyr+13,1)
## altT=matrix(0,14,4)
# altT[,1]=Year
# for(i in 1:length(Year)){
#  altT[i,3]=formatC(round(1000*mean(source$Catch[which(source$Alternative==alt&source$Yr==Year[i])])),format="d",big.mark=",")
#  altT[i,2]=formatC(round(1000*mean(source$SSB[which(source$Alternative==alt&source$Yr==Year[i])])),format="d",big.mark=",")
#  altT[i,4]=round(mean(source$F[which(source$Alternative==alt&source$Yr==Year[i])]),3)
 #}
 #return(altT)
#}

#alt12=altfn(bigfile,1,2020)#good
#alt3=altfn(bigfile,3,2020)#good?
#alt4=altfn(bigfile,4,2020)#good
#alt5=altfn(bigfile,5,2020)#good
#alt6=altfn(bigfile,6,2020)#good
#alt7=altfn(bigfile,7,2020)#good
#write.csv(alt12,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt12.csv")
#write.csv(alt3,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt3.csv")
#write.csv(alt4,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt4.csv")
#write.csv(alt5,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt5.csv")
#write.csv(alt6,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt6.csv")
#write.csv(alt7,"/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/alt7.csv")

t1 <- kable(alt12[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c("Maximum ABC harvest permissible"=4),align="l")%>%add_header_above(c("Scenarios 1 and 2"=4),line=FALSE,align="l")
t2 <- kable(alt3[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c("Harvest at average F over past 5 years"=4),align="l")%>%add_header_above(c("Scenario 3"=4),line=FALSE,align="l")
cat(c("\\begin{table}[h] \\centering ", 
      t1,
    "\\hspace{1cm} \\centering ",
      t2,
    "\\end{table}"))  

t3 <- kable(alt4[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c(" harvest permissible set at F60"=4),align="l")%>%add_header_above(c("Scenario 4, Maximum Tier 3 ABC"=4),line=FALSE,align="l")
t4 <- kable(alt5[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c("No fishing"=4),align="l")%>%add_header_above(c("Scenario 5"=4),line=FALSE,align="l")
cat(c("\\begin{table}[h] \\centering ", 
      t3,
    "\\hspace{1cm} \\centering ",
      t4,
    " \\end{table}")) 

t6 <- kable(alt6[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c(" Yellowfin Sole are currently overfished"=4),align="l")%>%add_header_above(c("Alternative 6, Determination of whether"=4),line=FALSE,align="l")
t7 <- kable(alt7[,2:5], format = 'latex',booktabs=TRUE,linesep="")%>%add_header_above(c("stock is approaching an overfished condition"=4),align="l")%>%add_header_above(c("Scenario 7, Determination of whether"=4),align="l",line=FALSE)
cat(c("\\begin{table}[h] \\centering ", 
      t6,
    "\\hspace{1cm} \\centering ",
      t7,
    " \\end{table}")) 
```





\pagebreak
\begin{landscape}
`r table_nums(name = "bycatch1", caption = paste("	
Incidental catch of FMP Groundfish in the Yellowfin Sole fishery. Source: NMFS AKRO Blend/Catch Accounting System; 1991-present."))`
```{r bycatch1, message=FALSE,echo=FALSE}
bycatch1=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/FMP Groundfish Bycatch1991_2020.csv",header=TRUE)

yrs=names(table(bycatch1$Year))
spp=names(table(bycatch1$Species.Group.Name))
#b1=matrix(0,length(yrs),length(spp))
#for(i in 1:length(yrs)){
# for(j in 1:length(spp)){
#  b1[i,j]=sum(bycatch1$Catch..mt.[which(bycatch1$Year==yrs[i]&bycatch1$Species.Group.Name==spp[j])])
# }
#}

#b1f=formatC(b1,format="d",big.mark=",")
#colnames(b1f)=spp
#rownames(b1f)=yrs
#write.csv(b1f,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/b1f.csv")
b1fa=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/b1fa.csv",header=TRUE)
colnames(b1fa)=c("Year","Arrowtooth Fl.","Atka Mackerel","AK Plaice","Kamchatka Fl.","Other Flatfish","Flathead Sole","Flounder","Greenland Turbot")
b1fb=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/b1fb.csv",header=TRUE)
colnames(b1fb)=c("Year","Northern RF","Shortraker","Other RF","Pacific Cod","Pollock","Rock Sole","Sablefish","Sharpchin/Northern RF","SR/RE/Sharpchin/N. RF","Pacific Ocean Perch")

kable(b1fa,"latex",booktabs="TRUE",linesep="")%>%kable_styling(latex_options = "scale_down")

kable(b1fb,"latex",booktabs="TRUE",linesep="")%>%kable_styling(latex_options = "scale_down")

```
\end{landscape}

\pagebreak
`r table_nums(name = "bycatch2", caption = paste("Bycatch of Other Species in the Yellowfin Sole directed fishery, which includes Octopus, Shark, Skate, Squid, and Sculpin. These species are included in the FMP but not available by species in the FMP Groundfish Incidental catch table. Bycatch reported in metric tons. Source: NMFS AKRO Catch Accounting System, Nontarget Estimates; available for 2003 and later."))`
```{r bycatch2, message=FALSE,echo=FALSE}
#bycatch2=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/FMP Other Species Bycatch CAS2_YFIN.csv",header=TRUE)

bycatch2=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/FMP Other Species Bycatch CAS2_1991-2020.csv",header=TRUE)

yrs=names(table(bycatch2$Year))
spp=names(table(bycatch2$Species.Group.Name))
b2=matrix(0,length(yrs),length(spp))
for(i in 1: length(yrs)){
 for(j in 1:length(spp)){
  b2[i,j]=sum(bycatch2$Weight.Posted..mt.[which(bycatch2$Year==yrs[i]&bycatch2$Species.Group.Name==spp[j])])
 }
}

b2f=formatC(b2,format="d",big.mark=",")
colnames(b2f)=spp
rownames(b2f)=yrs
kable(b2f[,2:8],"latex",booktabs="TRUE",linesep="",align="r")


```

\pagebreak
`r table_nums(name = "bycatch3", caption = paste("Catch (t) of BSAI non-target and ecosystem species in the Yellowfin Sole directed fishery from 1992-2020 estimated from a combination of regional office reported catch and observer sampling of the catch. Source:  NMFS AKRO Catch Accounting System, Nontarget Estimates; available for 2003 and later."))`
```{r bycatch3, message=FALSE,echo=FALSE}
bycatch3=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Nontarget Species Bycatch_YFS.csv",header=TRUE)

yrs=names(table(bycatch3$Year))
spp=names(table(bycatch3$Species.Group.Name))
b3=matrix(0,length(yrs),length(spp))
for(i in 1: length(yrs)){
 for(j in 1:length(spp)){
  b3[i,j]=sum(bycatch3$Nontarget.Estimate..mt.[which(bycatch3$Year==yrs[i]&bycatch3$Species.Group.Name==spp[j])],na.rm=TRUE)
 }
}
b3=na.omit(b3)


b3f=formatC(b3,format="d",big.mark=",")

colnames(b3f)=spp
rownames(b3f)=yrs
write.csv(b3f,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/b3f.csv")
b3f=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/b3f.csv",header=TRUE)

b4f=t(b3f)
kable(b4f,"latex",booktabs="TRUE",linesep="")%>%kable_styling(latex_options = "scale_down")%>%row_spec(1,hline=T)
```

\pagebreak

\begin{landscape}

`r table_nums(name="eco",caption="Ecosystem indicators for Yellowfin Sole, interpretation and evaluation.")`
```{r eco, message=FALSE, echo=FALSE}

eco=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/EcoYFS.csv",header=TRUE,skip=1)
kable(eco,"latex",booktabs=T,linesep="")%>%kable_styling(latex_options="scale_down") 
```

\end{landscape}


\pagebreak

# Figures

```{r spawnplot,echo=FALSE,message=FALSE}

```

\begin{center}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Yellowfin Sole Spawning Distribution-B.pdf}
\end{center}
`r figure_nums(name = "spawnplot", caption ="Distribution of wintering, spawning, and feeding areas for Yellowfin Sole in the Bering Sea, and observed regional grouping. Migration routes from wintering to feeding take place in spring, and the dates that Yellowfin Sole return to their wintering areas are unknown.")`

\pagebreak



   
```{r catchfig, message=FALSE, echo=FALSE,fig.width = 5.1, fig.height = 4}  
catchtab=data.frame(cbind(YFS2$Yr,YFS2$Obs_catch))
colnames(catchtab)=c("Year","Catch")
catchtab[67,2]=128.092
ggplot(data=catchtab,aes(x=Year,y=Catch))+geom_line(aes(x=Year,y=Catch))+
theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Catch (x 1,000 t)")+scale_x_continuous(breaks = seq(1955,2020, by = 5))+theme(legend.position="right")+scale_color_discrete(name="")
```


```{r fig_1b, message=FALSE, echo=FALSE,fig.width = 6.25, fig.height = 4}
#Figure 1 lower panel
#yrs=names(table(YFS_catch$Year))#actually do not use all yrs just 2003:2020
#yrs=seq(2003,2020,1)
#cat_month=matrix(0,length(yrs),12)
#for(i in 1:length(yrs)){
# for (j in 1:12){
#  cat_month[i,j]=sum(YFS_catch$Extrapolated_weight[which(YFS_catch$Year==yrs[i]&YFS_catch$Month.1==j)])
# }
#}

#colnames(cat_month)=c(1:12)
#rownames(cat_month)=yrs

#cat_month1=cat_month/rowSums(cat_month)
#cat_month2=matrix(0,length(yrs),12)
#for(i in 1:length(yrs)){
#cat_month2[i,]=cumsum(cat_month1[i,])
#}
#Cat=c(cat_month2)
#Year=rep(yrs,12)
#Month=rep(seq(1,12,1),each=length(yrs))
#catch_month=data.frame(Cat,Year,Month)
#write.csv(catch_month,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/catch_month.csv")

catch_month=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/catch_month.csv")
ggplot(data=catch_month, aes(x=Month,y=Cat,group=factor(Year)))+geom_line(aes(colour=Year),size=1.2)+scale_x_continuous(breaks = seq(1,12, by = 1))+theme(legend.position="right")+labs(y = "Relative cumulative catch")+scale_colour_gradient(low="lightblue",high="darkblue")+theme_few(base_size=14)

```

`r figure_nums(name="catchfig",caption = paste("Yellowfin Sole annual total catch (1,000s t) in the Eastern Bering Sea from 1954-",thisyr," (upper panel). Yellowfin Sole annual cumulative catch by month and year (non CDQ) 2003-November 15, 2020 (lower panel).",sep=""))`

\pagebreak


```{r pie_bymonth,fig.align='center',message=FALSE, echo=FALSE,fig.align='center'}  
library(scales)
par(mar=c(5,6,6,1))
retdis2020=retdis[which(retdis$Year=="2020"),]
area=names(table(retdis2019$Reporting.Area.Code))
areaz=vector()
for(i in 1:length(area)){
 areaz[i]=sum(retdis2019$Total.Catch..mt.[which(retdis2019$Reporting.Area.Code==area[i])])
}
area_res=as.data.frame(cbind(area,round(areaz)))
area_res2=area_res[which(as.numeric(as.character(area_res[,2]))>1000),]
area_res3=data.frame(as.factor(as.character(area_res2[,1])),as.numeric(as.character(area_res2[,2])))
area_res4=cbind(area_res3,area_res3[,2]/sum(area_res3[,2]))
colnames(area_res4)=c("NMFS.Area","Catch_full","Catch")
area_res5=cbind(area_res4,cumsum(area_res4$Catch)-(area_res4$Catch/2))
colnames(area_res5)=c("NMFS.Area","Catch_full","Catch","pos")

blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

ggplot(area_res5, aes(x="", y=Catch, fill=NMFS.Area))+geom_bar(width = 2, stat = "identity")+coord_polar("y",start=0,direction=1)+blank_theme+theme(axis.text.x=element_blank()) +geom_text(aes(label = NMFS.Area),position = position_stack(vjust = 0.5),size=c(4,8,8,4,4))+scale_fill_discrete(name = "NMFS Area")+ theme(legend.text=element_text(size=15),legend.title=element_text(size=16))

```

```{r fig_3b, message=FALSE, echo=FALSE,fig.align='center'} 
#blend_catchYFS=read.csv("/Users/ingridspies/YFS_Blend_CAS.csv",header=TRUE)
#blend_catch2019=blend_catchYFS[which(blend_catchYFS$Year==2019),]
#cat_mo2019=data.frame(cbind(c("January","February","March","April","May","June","July","August","September"),table(blend_catch2019$Month)))
#write.csv(cat_mo2019,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/cat_mo2019b.csv")

cat_mo2020=matrix(0,10,3)
for(i in 1:10){
 cat_mo2020[i,3]=sum(YFS_catch$Extrapolated_weight[which(YFS_catch$Year==2020&YFS_catch$Month.1==i)],na.rm=TRUE)
}
cat_mo2020[,2]=c("January","February","March","April","May","June","July","August","September","October")
colnames(cat_mo2020)=c("N","Month","Catch")
cat_mo2020=as.data.frame(cat_mo2020)
cat_mo2020$Month=factor(cat_mo2020$Month,levels=cat_mo2020$Month)
cat_mo2020$Catch=as.numeric(as.character(cat_mo2020$Catch))
Proportion=percent(round(cat_mo2020$Catch/sum(cat_mo2020$Catch),2))
cm2020=cbind(cat_mo2020,Proportion)

ggplot(cm2020, aes(x="", y=Catch, fill=Month))+
 geom_bar(width = 2, stat = "identity")+
 coord_polar("y", start=0,direction=-1)+
 blank_theme+theme(axis.text.x=element_blank()) +
 geom_text(aes(label = Proportion),position = position_stack(vjust =0.5),vjust=c(-.3,rep(1.1,9)),hjust=c(rep(.5,9),.3), size=c(5,rep(5,9)))+scale_fill_discrete(name = "Month")+ 
 theme(legend.text=element_text(size=15),legend.title=element_text(size=16))
 
```
`r figure_nums(name="pie_bymonth",caption = paste("Yellowfin Sole catch proportion by area (upper panel) and by month (lower panel) in the Eastern Bering Sea in ",thisyr,".",sep=""))` 

\pagebreak



```{r obs_sizecomp,message=FALSE,echo=FALSE}
sc=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2020YFSfisherylengths.csv",header=TRUE)
sc1=sc/colSums(sc)


Males=c(sc[,2]/sum(sc[,2]),sc[,5]/sum(sc[,5]),sc[,8]/sum(sc[,8]),sc[,11]/sum(sc[,11]),sc[,14]/sum(sc[,14]),sc[,17]/sum(sc[,17]),sc[,20]/sum(sc[,20]),rowSums(sc[,c(2,5,8,11,14,17,20)])/sum(rowSums(sc[,c(2,5,8,11,14,17,20)])))
Females=c(sc[,3]/sum(sc[,3]),sc[,6]/sum(sc[,6]),sc[,9]/sum(sc[,9]),sc[,12]/sum(sc[,12]),sc[,15]/sum(sc[,15]),sc[,18]/sum(sc[,18]),sc[,21]/sum(sc[,21]),rowSums(sc[,c(3,6,9,12,15,18,21)])/sum(rowSums(sc[,c(3,6,9,12,15,18,21)])))
Area=rep(c(rep(509,nrow(sc)),rep(513,nrow(sc)),rep(514,nrow(sc)),rep(516,nrow(sc)),rep(517,nrow(sc)),rep(521,nrow(sc)),rep(524,nrow(sc)),rep("All",nrow(sc))),2)
Proportion=c(Males,Females)
Length=rep(sc[,1],16)
Sex=c(rep("Males",length(Males)),rep("Females",length(Females)))

sctab=data.frame(Area,Proportion,Sex,Length)
ggplot(sctab)+geom_line(aes(x=Length,y=Proportion,group=Sex,color=Sex))+facet_wrap(~Area)+theme_bw()+labs(x="Length (cm)")
```

`r figure_nums(name="obs_sizecomp",caption = paste("Size composition of the Yellowfin Sole catch in 2020 (through October 1) caught by trawl gear, by subarea and total, for the primary areas where Yellowfin Sole are caught, 509, 513, 514, 516, 517, 521, and 524."))`


\pagebreak


```{r fishmo,message=FALSE,echo=FALSE}



```
\begin{center}
\includegraphics[width=6.5in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/YFS_2020_catchbyMonth.pdf}
\end{center}

`r figure_nums(name="fishmo",caption="Catch of Yellowfin Sole in the BSAI in 2020 by month, reported by observers. Circles represent presence of Yellowfin Sole the catch by the following gear types: non-pelagic trawl, pair trawl, or pelagic trawl.")`

\pagebreak

```{r wtage, message=FALSE, echo=FALSE}  

wts_f=YFS2$wt_srv_f
colnames(wts_f)=seq(1,20,1)
rownames(wts_f)=seq(1954,2020,1)

wts_m=YFS2$wt_srv_m
colnames(wts_m)=seq(1,20,1)
rownames(wts_m)=seq(1954,2020,1)

 d <- (as.data.frame(wts_f[47:67,]))
 d$Year=row.names(d)
 wts_f2=pivot_longer(d,-Year)
 colnames(wts_f2)=c("Year","Age","Weight")
 wts_f2$Age=factor(wts_f2$Age,levels=seq(1,20,1))
 wts_f2$Year=factor(wts_f2$Year)
 
  dm <- (as.data.frame(wts_m[47:67,]))
 dm$Year=row.names(dm)
 wts_m2=pivot_longer(dm,-Year)
 colnames(wts_m2)=c("Year","Age","Weight")
 wts_m2$Age=factor(wts_m2$Age,levels=seq(1,20,1))
 wts_m2$Year=factor(wts_m2$Year)
 
pf= ggplot(wts_f2)+aes(x=Age,y=Weight)+geom_bar(stat="identity")+facet_wrap(~Year)+scale_x_discrete(breaks = seq(1,20, by = 4))+theme_bw()+ylab("Weight (g)")+ggtitle("Survey empirical weight-at-age (g), females")
 
pm=  ggplot(wts_m2)+aes(x=Age,y=Weight)+geom_bar(stat="identity")+facet_wrap(~Year)+scale_x_discrete(breaks = seq(1,20, by = 4))+theme_bw()+ylab("Weight (g)")+ggtitle("Survey empirical weight-at-age (g), males")

pf
pm
 
```
`r figure_nums(name="wtage",caption = "Empirical estimates of weight (g) at age for Yellowfin Sole females and males, 2000-2020.")`
    
 
\pagebreak


```{r black, message=FALSE, echo=FALSE}  

```

\begin{center}
\includegraphics[width=5in,angle=270,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Black_Fig3.pdf}
\end{center}
`r figure_nums(name="black",caption = "Master chronology for Yellowfin Sole and time series of mean summer bottom temperature and May sea surface temperature for the southeastern Bering Sea (Panel A).  All data were normalized to a mean of 0 and standard deviation of 1.  Correlations of chronologies with bottom temperature and sea surface temperature are shown in panels B and C, respectively (Matta et al. 2010).")`

\pagebreak



```{r tempanom, message=FALSE, echo=FALSE}  
YFSage=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/survey/YFSage.csv",header=TRUE)
fem5=vector();mal5=vector()
yrs=names(table(substr(YFSage$CRUISE,1,4)))
for(i in 1:length(yrs)){
 fem5[i]=mean(YFSage$LENGTH[which(YFSage$AGE==5&substr(YFSage$CRUISE,1,4)==yrs[i]&YFSage$SEX==2)])
 mal5[i]=mean(YFSage$LENGTH[which(YFSage$AGE==5&substr(YFSage$CRUISE,1,4)==yrs[i]&YFSage$SEX==1)])
}

Year=rep(seq(1982,2018,1),3)
Series=c(rep("Temperature",37),rep("Males",37),rep("Females",37))
Data=c(10*YFS2$Bottom_temp[1,1:37],(mal5[9:45]-mean(mal5[9:45])),(fem5[9:45]-mean(fem5[9:45])))       
env=data.frame(Year,Series,Data)

ggplot(data=env,aes(x=Year,y=Data,type=Series))+geom_line(aes(x=Year,y=Data,color=Series))+theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+ylab("Anomaly")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=1))+geom_hline(yintercept=0,linetype=1)


```
`r figure_nums(name='tempanom',caption="Yellowfin Sole length-at-age anomalies, for 5-year old males and females, and bottom temperature anomalies (Model 18.2).  Correspondence in these residuals is apparent with a 2-3 year lag effect from the mid-1990s to 2019.  Late 1980s and early 1990s pattern may be a density-dependent response in growth from the large 1981 and 1983 year-classes. Note: Bottom temperature anomalies were scaled up by a factor of 10 to demonstrate the pattern and match length anomalies.")`

\pagebreak

```{r cpueline,message=FALSE,echo=FALSE}
cpue=read.csv("/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/race_cpue_by_haul.csv",header=TRUE)
yr=names(table(cpue$Year))
cpueyr=vector()
for(i in 1:length(yr)){
cpueyr[i]=mean(cpue$Weight.CPUE..kg.km2.[which(cpue$Year==yr[i])]) 
}

cp=data.frame(as.numeric(yr),cpueyr)
colnames(cp)=c("Year","CPUE")

ggplot(cp)+geom_line(aes(x=Year,y=CPUE/100),size=1.2)+labs(x = "Year", y = "CPUE")+ylab("Average catch per unit effort, kg/hectare")+theme_bw()

```
`r figure_nums(name="cpueline",caption="Average catch per unit effort on NMFS eastern Bering Sea surveys, 1982-2019, in kg/hectare.")`

\pagebreak


```{r cpuefig,message=FALSE,echo=FALSE}


#In 2020 a single vessel (#62608 caught 33kg of YFS in the Bering Sea in 2020 in Pot gear. This was the first time YFS was caught in pot gear. It was not the first time with longline gear.)



```
\begin{center}
\includegraphics[width=7.5in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/YFS_20yrs_trawl12_2deg.pdf}
\end{center}

`r figure_nums(name='cpuefig',caption="Catch of Yellowfin Sole by trawl gear in the BSAI, 2001-2020, by year, reported by observers. Gear types include pelagic and non-pelagic trawl. Colored circles represent catch of Yellowfin Sole, with darker shades of red representing higher catch.")`


\pagebreak


```{r srvCI, message=FALSE, echo=FALSE}  
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI))

colnames(srv_bio)=c("Year","Biomass","sd","LCI","HCI")
ggplot(data=srv_bio,aes(x=Year,y=Biomass))+geom_point(aes(x=Year,y=Biomass))+geom_errorbar(aes(ymin=LCI, ymax=HCI), width=.1)+theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2019, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=1))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")

```
`r figure_nums(name="srvCI",caption = paste("Annual eastern Bering Sea bottom trawl survey biomass point estimates and 95% confidence intervals for Yellowfin Sole, 1982-",thisyr,", Model 18.2.",sep=""))`
                                                     
\pagebreak


```{r cpuediff,message=FALSE,echo=FALSE}

```
\begin{center}
    \includegraphics[width=6.5in]{/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/yfs_cpuediff_2019_arcmap.pdf}
\end{center}
`r figure_nums(name="cpuediff",caption = "Difference between the 1985-2018 average trawl survey CPUE for yellowfin sole and the
2019 survey CPUE. Green circles indicate that the magnitude of the catch was greater in 2019 than the long-term average, red circles indicate the catch was greater in the longterm
average than in 2019.")`

\pagebreak


```{r NBS,echo=FALSE,message=FALSE}
```
\begin{figure}[h]
    \centering
    \includegraphics[width=0.495\textwidth]{/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/NBS_survey/yfs10bw.png}
    \includegraphics[width=0.495\textwidth]{/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/NBS_survey/yfs17bw.png}
    \includegraphics[width=0.495\textwidth]{/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/NBS_survey/yfs18bw.png}
    \includegraphics[width=0.495\textwidth]{/Users/ingridspies/Documents/WorkDellStuff/Assessments/YFS/2019 YFS/2019/data/NBS_survey/yfs19bw.png}
\end{figure}

`r figure_nums(name = "NBS", caption ="Distribution of Yellowfin Sole in the eastern and northern Bering sea based on surveys conducted in 2010 (upper left), 2017 (upper right), 2018 (lower left), and 2019 (lower right).")`

\pagebreak



```{r, ADFG,eval=TRUE,message=FALSE, echo=FALSE}
ADFG=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/YellowfinNortonSound_ADFGsurvey.csv",header=TRUE)

ADFG1=ADFG[-which(ADFG$Year==2006&ADFG$Haul>77),]#remove survey outside of norton sound

yrs=names(table(ADFG1$Year))
meanYFS=vector()
for(i in 1:length(yrs)){
meanYFS[i]=mean(ADFG1$CPUE_per_km2[which(ADFG1$Year==yrs[i])])
}
NSYFS=data.frame(cbind(yrs,meanYFS))
colnames(NSYFS)=c("Year","CPUE")
NSYFS$Year=as.numeric(NSYFS$Year)
NSYFS$CPUE=as.numeric(NSYFS$CPUE)

ggplot(NSYFS)+geom_line(aes(x=Year,y=CPUE/100),size=1.2)+labs(x = "Year", y = "Average CPUE kg/hectare")+theme_bw()+theme(axis.text=element_text(size=11),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+ggtitle("Average Yellowfin Sole CPUE in Norton Sound (ADF&G survey)")
```

`r figure_nums(name = "ADFG", caption ="Average catch per unit effort (CPUE) of Yellowfin Sole in Norton Sound, based on an ADF&G survey time series.")`


```{r ricker1,echo=FALSE,message=FALSE}

 df <- data.frame(YFS1$SRR_SSB)
 df$Year <- YFS1$Year
 df$rhat <- YFS1$rechat
 df$rhat.sd <- YFS1$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS1$Yr[62:67],YFS1$SSB[62:67,2],(YFS1$natage_f[62:67,1]+YFS1$natage_m[62:67,1]))
  df3=data.frame(YFS1$Yr[25:61],YFS1$SSB[25:61,2],(YFS1$natage_f[25:61,1]+YFS1$natage_m[25:61,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, billions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.1")+theme_bw()
 
```
`r figure_nums(name="ricker1",caption = paste("Ricker stock recruitment curve for Model 18.1 with 95% confidence intervals (shaded region) fit to female spawning biomass and recruitment data from 1978-2014. Years in black indicate data used to fit the model, years in blue were not used to fit the model.",sep=""))`


\pagebreak
```{r ricker2,echo=FALSE,message=FALSE}

 df <- data.frame(YFS2$SRR_SSB)
 df$Year <- YFS2$Year
 df$rhat <- YFS2$rechat
 df$rhat.sd <- YFS2$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS2$Yr[62:67],YFS2$SSB[62:67,2],(YFS2$natage_f[62:67,1]+YFS2$natage_m[62:67,1]))
  df3=data.frame(YFS2$Yr[25:61],YFS2$SSB[25:61,2],(YFS2$natage_f[25:61,1]+YFS2$natage_m[25:61,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, billions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+ggtitle("Model 18.2")+theme_bw()
 
```
`r figure_nums(name="ricker2",caption = paste("Ricker stock recruitment curve for Model 18.2 with 95% confidence intervals (shaded region) fit to female spawning biomass and recruitment data from 1978-2014. Years in black indicate data used to fit the model, years in blue were not used to fit the model.",sep=""))`

\pagebreak
```{r srvsel, echo=FALSE, message=FALSE}
srvsel2=data.frame(cbind(seq(1,20,1),YFS2$sel_srv_f,YFS2$sel_srv_m))
colnames(srvsel2)=c("Age","Female","Male")
p2=ggplot(data=srvsel2)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.2")

srvsel1=data.frame(cbind(seq(1,20,1),YFS1$sel_srv_f,YFS1$sel_srv_m))
colnames(srvsel1)=c("Age","Female","Male")
p1=ggplot(data=srvsel1)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.1")

grid.arrange(p1, p2, ncol = 1)


```

`r figure_nums(name="srvsel",caption = "Estimate of survey selectivity for males and females, Model 18.1 upper panel, Model 18.2 lower panel.")`


\pagebreak
```{r fshsel,fig.height=8.5,echo=FALSE,message=FALSE}
#sf=data.frame(rep(seq(1954,2019,1),20),rep(seq(1,20,1),each=66),as.vector(YFS2$sel_fsh_f))
#colnames(sf)=c("Year","Age","Selectivity")
#ggplot(data=sf,x=Age,y=Selectivity)+geom_line(aes(x=Age,y=Selectivity))+facet_wrap(~Year)+th#eme_few()+ theme(axis.text.x = element_text(angle = 90, hjust = 1, size=7))+ #theme(axis.text.y = element_text(angle = 0, hjust = 1, size=7))

#sf=data.frame(rep(seq(1954,2019,1),each=20),rep(seq(1,20,1),66),as.vector(t(YFS2$sel_fsh_f)))
#colnames(sf)=c("Year","Age","Selectivity")
#ggplot(data=sf,aes(x=Age,y=Selectivity,type=Year))+geom_line(aes(x=Age,y=Selectivity,colour=factor(Year)))+ylab("Fishery Selectivity")+xlab("Age")

mdf <- data.frame(Year=YFS2$Yr,Sex="males",YFS2$sel_fsh_m)
mdf <- rbind(mdf,data.frame(Year=YFS2$Yr,Sex="females",YFS2$sel_fsh_f))
names(mdf)[3:22] <- 1:20
sdf <- (gather(mdf,Age,selectivity,3:22) ) %>% filter(Year>=min(YFS2$Yr),Year<=max(YFS2$Yr)) %>% mutate(Age=as.numeric(Age)) #+ arrange(age,Year)

ggplot(sdf,aes(x=Age,y=fct_rev(as.factor(Year)),height = selectivity,fill=Sex,color=Sex,alpha=0.3)) +
 geom_density_ridges(stat = "identity",scale=1,alpha = 0.3) + ylab("Year")+ theme(axis.text.y = element_text(angle = 0, hjust = 1, size=5))+theme_bw()

```

`r figure_nums(name="fshsel",caption = "Estimate of fishery selectivity for males and females, 1954-2019, Model 18.2.")`

\pagebreak
```{r plotq, message=FALSE,echo=FALSE}

    df <- data.frame( Year    = YFS2$yrs_srv )
    df$Model <- "Model 18.2"
    df$q_srv   <- YFS2$q_srv
    
    df1 <- data.frame( Year    = YFS1$yrs_srv )
    df1$Model <- "Model 18.1"
    df1$q_srv   <- YFS1$q_srv
    
    df2=data.frame(rbind(df1,df))
    
    ggplot(df2) +geom_line(aes(x = Year, y = q_srv, col = Model),size=1.2)+ 
        labs(x = "Year", y = "Survey catchability")+theme_bw()

```
`r figure_nums(name="plotq",caption = paste("Survey catchability for Model 18.1 and 18.2, 1982-",thisyr-1,".",sep=""))`


\pagebreak
```{r sexratio,message=FALSE,echo=FALSE}
        df <- data.frame(rowSums(YFS2$natage_f)/rowSums(YFS2$natage_f+YFS2$natage_m))
        df$Model <- "Model 18.2"
        df$Year=YFS2$Yr
        colnames(df)=c("Sex_Ratio","Model","Year")
        
        df1 <- data.frame(rowSums(YFS1$natage_f)/rowSums(YFS1$natage_f+YFS1$natage_m))
        df1$Model <- "Model 18.1"
        df1$Year=YFS2$Yr

        colnames(df1)=c("Sex_Ratio","Model","Year")
        df2=rbind(df1,df)
        
        ggplot(df2) + geom_point(data=df2, aes(x = Year, y = Sex_Ratio,color=Model),size=3)+labs(xlab = "Year", ylab = "Proportion female")+
          ylab("Proportion Female")+theme_bw()

```
`r figure_nums(name="sexratio",caption = paste("Model estimates of the proportion of female Yellowfin Sole in the population, 1982-",thisyr,".",sep=""))`


\pagebreak
```{r srv_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
#Survey
nages=20
dff <- data.frame(Model="Model 18.1", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.1", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")+ggtitle("Fit to Survey Age Compositions, Model 18.1")
```

`r figure_nums(name="srv_agecomp1",caption=paste("Model 18.1 fit to the time-series of survey age composition, by sex, 1979-",thisyr-1,".",sep=""))`

\pagebreak
```{r srv_agecomp2, message=FALSE,echo=FALSE,fig.height=7.5}
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")+ggtitle("Fit to Survey Age Compositions, Model 18.2")

```

`r figure_nums(name="srv_agecomp2",caption=paste("Model 18.2 fit to the time-series of survey age composition, by sex, 1979-",thisyr-1,".",sep=""))`



\pagebreak

```{r fsh_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.1", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.1", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +ggtitle("Fit to Fishery Age Compositions, Model 18.1")

```

`r figure_nums(name="fsh_agecomp1",caption=paste("Model 18.1 fit to the time-series of fishery age composition, by sex, 1975-",thisyr-1,".",sep=""))`

\pagebreak

```{r fsh_agecomp2,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +ggtitle("Fit to Fishery Age Compositions, Model 18.2")

```

`r figure_nums(name="fsh_agecomp2",caption=paste("Model 18.2 fit to the time-series of fishery age composition, by sex, 1975-",thisyr-1,".",sep=""))`

\pagebreak

```{r srvbio_fit, message=FALSE, echo=FALSE}  
#fit to survey biomass models 18.1 and 18.2
par(mar=c(0,0,0,0))
LCI=YFS1$ob_bts-1.96*YFS1$sd_ob_bts
HCI=YFS1$ob_bts+1.96*YFS1$sd_ob_bts
srv_bio1=data.frame(cbind(YFS1$yrs_srv,YFS1$ob_bts,YFS1$sd_ob_bts,LCI,HCI,YFS1$pred_srv[29:66]))
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio2=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI,YFS2$pred_srv[29:66]))
srv_bio3=rbind(srv_bio1,srv_bio2)
Model=c(rep("Model 18.1",nrow(srv_bio1)),rep("Model 18.2",nrow(srv_bio1)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","Model")

m1=ggplot(data=srv_bio4,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=10),axis.title.y = element_text(size=10))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

#fit to survey biomass models 18.3
LCI=YFS3$ob_bts-1.96*YFS3$sd_ob_bts
HCI=YFS3$ob_bts+1.96*YFS3$sd_ob_bts
srv_bio3=data.frame(cbind(YFS3$yrs_srv,YFS3$ob_bts,YFS3$sd_ob_bts,LCI,HCI,YFS3$pred_srv[29:66]))
Model=c(rep("Model 18.3",nrow(srv_bio3)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","Model")

m2=ggplot(data=srv_bio4,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=10),axis.title.y = element_text(size=10))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

#fit to survey biomass models 18.4
LCI=YFS4$ob_bts-1.96*YFS4$sd_ob_bts
HCI=YFS4$ob_bts+1.96*YFS4$sd_ob_bts
srv_bio4=data.frame(cbind(YFS4$yrs_srv,YFS4$ob_bts,YFS4$sd_ob_bts,LCI,HCI,YFS4$pred_srv[29:66]))
Model=c(rep("Model 18.4",nrow(srv_bio4)))
srv_bio5=cbind(srv_bio4,Model)
colnames(srv_bio5)=c("Year","Biomass","sd","LCI","HCI","Predicted","Model")

m3=ggplot(data=srv_bio5,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=10),axis.title.y = element_text(size=10))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))+ylim(0,5000)

grid.arrange(m1,m2,m3,ncol=1,nrow=3)

```
`r figure_nums(name="srvbio_fit",caption = paste("Model 18.1 and 18.2 (upper panel), Model 18.3 (middle panel), and Model 18.4 (lower panel) fit to NMFS eastern Bering Sea survey biomass estimates, from 1982-",thisyr-1,". Models 18.1, 18.2, and 18.3 incorporate estimates from the EBS only, while Model 18.4 used NBS+EBS estimates. Models 18.3 and 18.4 used VAST biomass and standard errror, while Models 18.1 and 18.2 used design-based biomass and error estimates.",sep=""))`


\pagebreak

```{r mcmcplots, message=FALSE, echo=FALSE}
hdr <- read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m1/hdr.dat",as.is=T,header=F)
mctmp2.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/evalout_YFIN2020.rep",col_names=FALSE)
mctmp1.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m1/evalout_YFIN.rep",col_names=FALSE)
names(mctmp1.df) <- hdr
names(mctmp2.df) <- hdr
mcdat=rbind(mctmp1.df,mctmp2.df)
mcdat$Model=c(rep("Model 18.1",nrow(mctmp1.df)),rep("Model 18.2",nrow(mctmp1.df)))

p1=ggplot(data=mcdat, aes(x=Fmsyr,fill=Model)) + geom_density(aes(x=Fmsyr),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Fmsy")+theme_bw()+ylab("Density")

p2=ggplot(data=mcdat, aes(x=Bmsy,fill=Model)) + geom_density(aes(x=Bmsy),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Bmsy (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(50,1000))

p3=ggplot(data=mcdat, aes(x=ln_mean_R,fill=Model)) + geom_density(aes(x=ln_mean_R),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("log(mean(Recruitment))x10^9") +theme_bw()+ylab("Density")

p4=ggplot(data=mcdat, aes(x=ABC_biom6,fill=Model)) + geom_density(aes(x=ABC_biom6),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Age 6 Biomass (x10^6 t)") +theme_bw()+ylab("Density")

p5=ggplot(data=mcdat, aes(x=SSB_2020,fill=Model)) + geom_density(aes(x=SSB_2020),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("FSB (x1,000 t)") +theme_bw()+ylab("Density")+geom_vline(xintercept=(Bmsy_this/1000))+xlim(c(500,1400))

p6=ggplot(data=mcdat, aes(x=TotBiom_2020,fill=Model)) + geom_density(aes(x=TotBiom_2020),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Total Biomass (x10^6 t)") +theme_bw()+ylab("Density")

grid.arrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```
`r figure_nums(name="mcmcplots",caption="MCMC posterior distributions from Models 18.1 and 18.2, for Fmsy, Bmsy, log(mean(Recruitment)), Age 6 biomass, female spawning biomass (FSB) for 2020, and total biomass for 2020.")`

\pagebreak

```{r BIOM_SSB, message=FALSE, echo=FALSE}

#Test plotting m2, m3 and m4 

TotBiom18_1=data.frame(YFS1$TotBiom,rep("18.1",nrow(YFS1$TotBiom)))
TotBiom18_2=data.frame(YFS2$TotBiom,rep("18.2",nrow(YFS2$TotBiom)))
TotBiom18_3=data.frame(YFS3$TotBiom,rep("18.3",nrow(YFS3$TotBiom)))
TotBiom18_4=data.frame(YFS4$TotBiom,rep("18.4",nrow(YFS4$TotBiom)))
colnames(TotBiom18_1)=c("Year","Biomass","sd","LCI","HCI","Model")
colnames(TotBiom18_2)=c("Year","Biomass","sd","LCI","HCI","Model")
colnames(TotBiom18_3)=c("Year","Biomass","sd","LCI","HCI","Model")
colnames(TotBiom18_4)=c("Year","Biomass","sd","LCI","HCI","Model")
TotBiom=rbind(TotBiom18_1,TotBiom18_2,TotBiom18_3,TotBiom18_4)

p_TotBio=ggplot(data=TotBiom,aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI))+
 geom_ribbon(aes(fill=Model),alpha=0.3)+geom_line(aes(color=Model))+
 ylab("Biomass (x 1,000 t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

SSBiom18_1=data.frame(YFS1$SSB,rep("18.1",nrow(YFS1$SSB)))
SSBiom18_2=data.frame(YFS2$SSB,rep("18.2",nrow(YFS2$SSB)))
SSBiom18_3=data.frame(YFS3$SSB,rep("18.3",nrow(YFS3$SSB)))
SSBiom18_4=data.frame(YFS4$SSB,rep("18.4",nrow(YFS4$SSB)))
colnames(SSBiom18_1)=c("Year","SSB","sd","LCI","HCI","Model")
colnames(SSBiom18_2)=c("Year","SSB","sd","LCI","HCI","Model")
colnames(SSBiom18_3)=c("Year","SSB","sd","LCI","HCI","Model")
colnames(SSBiom18_4)=c("Year","SSB","sd","LCI","HCI","Model")
SSBiom=rbind(SSBiom18_1,SSBiom18_2,SSBiom18_3,SSBiom18_4)

p_SSB=ggplot(data=SSBiom,aes(x=Year,y=SSB,ymin=LCI,ymax=HCI))+
 geom_ribbon(aes(fill=Model),alpha=0.3)+geom_line(aes(color=Model))+
 ylab("Spawning Biomass (x 1,000 t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

grid.arrange(p_TotBio,p_SSB,ncol=1,nrow=2)

```

`r figure_nums(name="BIOM_SSB",caption = paste("Total (age 2+) and spawning stock biomass for Yellowfin Sole, based on Models 18.1, 18.2, 18.3, and 18.4, from 1954-2020."))`


\pagebreak
```{r bioFSBCI, message=FALSE, echo=FALSE} 
TotBiom=data.frame(YFS2$TotBiom,rep("Biomass",nrow(YFS2$TotBiom)))
colnames(TotBiom)=c("Year","Biomass","sd","LCI","HCI","Type")
SSB=data.frame(YFS2$SSB,rep("FSB",nrow(YFS2$SSB)))
colnames(SSB)=c("Year","Biomass","sd","LCI","HCI","Type")
TotBiom2=rbind(TotBiom,SSB)
colnames(TotBiom2)=c("Year","Biomass","sd","LCI","HCI","Type")

theme_set(theme_gray(base_size = 18))
ggplot(data=TotBiom2,aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI))+
geom_ribbon(aes(fill=Type),alpha=0.3)+geom_line(aes(color=Type))+
ylab("Biomass (x 1,000 t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))+geom_hline(yintercept=Bmsy_this/1000)+geom_point(aes(x=2021,y=FSB_this/1000),color="blue")+geom_point(aes(x=2022,y=FSB_next/1000),color="blue")+geom_hline(yintercept=Bmsy_next/1000)

#+geom_point(aes(x=2021,y=TotBio_this/1000),color="red")+geom_point(aes(x=2022,y=TotBio_next/1000),color="red")#would like age 6+ estimates. 

```
`r figure_nums(name="BioFSBCI",caption = paste("Model estimates of total (age 2+) and female spawning biomass with 95% confidence intervals, 1954-",thisyr,", Model 18.2. Dots indicate female spawning biomass projection model estimates for 2021 and 2022.",sep=""))`

\pagebreak

```{r fishingavgF}
#Figure 32 get this from SSB in 5 yr average catch in alt3.
pcatch=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/percentiles.out",nrows=14,skip=144)
colnames(pcatch)=c("Year","C0","Cabc","Cofl","LowCI_Catch ","Median_Catch","Mean_Catch","UpperCI_Catch","Stdev_Catch")

pSSB=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2020_out/percentiles.out",nrows=14,skip=161)
colnames(pSSB)=c("Year","SSB100","SSBabc","SSBofl","LowCI_SSB","Median_SSB","Mean_SSB","UpperCI_SSB","Stdev_SSB")


plot(pSSB$Year,pSSB$Mean_SSB,type="l",ylim=c(0,1500),lwd=3,col="blue", xlab="Year",ylab="Female Spawning Biomass",cex.axis=1.4,cex.lab=1.4)
lines(pSSB$Year,pSSB$LowCI_SSB,lty=2,lwd=2)
lines(pSSB$Year,pSSB$UpperCI_SSB,lty=2,lwd=2)
abline(h=Bmsy_this/1000,col="red",lwd=2)
text(2021,(Bmsy_this/1000)+60,expression(B[MSY]),cex=1.4)


```

`r figure_nums(name="fishingavgF",caption=paste("Projected female spawning biomass for ",thisyr," to ",thisyr+13," (blue line), with 5% and 95% confidence intervals, and fishing at the 5-year (2015-2019) average fishing mortality rate, F=",round(mean(YFS2$F_m[62:66,18]),4),", Model 18.2."))`

\pagebreak
```{r recfig,echo=FALSE,message=FALSE}

recf=data.frame(YFS2$Yr,YFS2$natage_f[,5]+YFS2$natage_m[,5])
colnames(recf)=c("Year","Recruitment")
ggplot(data=recf)+geom_bar(aes(x=Year,y=Recruitment),alpha=0.4,stat="identity")+geom_hline(yintercept=mean(YFS2$natage_f[,5]+YFS2$natage_m[,5]))+theme_bw()+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=45,hjust=1))+ylab("Recruitment, age 5, billions of fish")
```
`r figure_nums(name="recfig",caption=paste("Year-class strength of age 5 Yellowfin Sole estimated by the stock assessment model. The horizontal line represents the average of the estimates from 67 years of recruitment, 1954-2020, 1.791 billion, Model 18.2."))`


\pagebreak

```{r retro1, echo=FALSE, message=FALSE}

#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#retrospective Model 18.1
std2020=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro0/fm.std")
std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro1/fm.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro2/fm.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro3/fm.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro4/fm.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro5/fm.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro6/fm.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro7/fm.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro8/fm.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro9/fm.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_1/retrospectives/retro10/fm.std")

ret20=data.frame(cbind(c(1954:2020),YFS2020$SSB[,2],YFS2020$SSB[,2]+1.96*as.numeric(as.vector(std2020[['V4']][608:674])),YFS2020$SSB[,2]-1.96*as.numeric(as.vector(std2020[['V4']][608:674]))))

ret19=data.frame(cbind(c(1954:2019),YFS2019$SSB[,2],YFS2019$SSB[,2]+1.96*as.numeric(as.vector(std2019[['V4']][601:666])),YFS2019$SSB[,2]-1.96*as.numeric(as.vector(std2019[['V4']][601:666]))))

ret18=data.frame(cbind(c(1954:2018),YFS2018$SSB[,2],YFS2018$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017$SSB[,2],YFS2017$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016$SSB[,2],YFS2016$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015$SSB[,2],YFS2015$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014$SSB[,2],YFS2014$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013$SSB[,2],YFS2013$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012$SSB[,2],YFS2012$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011$SSB[,2],YFS2011$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010$SSB[,2],YFS2010$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))
 
retro=as.data.frame(rbind(ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18,ret19,ret20))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2020",length(c(1954:2020))),rep("2019",length(c(1954:2019))),rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p18_1=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

#retro 18.2
std2020=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro0/fm.std")
std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro1/fm.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro2/fm.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro3/fm.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro4/fm.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro5/fm.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro6/fm.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro7/fm.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro8/fm.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro9/fm.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/retro18_2/retrospectives/retro10/fm.std")

ret20=data.frame(cbind(c(1954:2020),YFS2020$SSB[,2],YFS2020$SSB[,2]+1.96*as.numeric(as.vector(std2020[['V4']][608:674])),YFS2020$SSB[,2]-1.96*as.numeric(as.vector(std2020[['V4']][608:674]))))

ret19=data.frame(cbind(c(1954:2019),YFS2019$SSB[,2],YFS2019$SSB[,2]+1.96*as.numeric(as.vector(std2019[['V4']][601:666])),YFS2019$SSB[,2]-1.96*as.numeric(as.vector(std2019[['V4']][601:666]))))

ret18=data.frame(cbind(c(1954:2018),YFS2018$SSB[,2],YFS2018$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017$SSB[,2],YFS2017$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016$SSB[,2],YFS2016$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015$SSB[,2],YFS2015$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014$SSB[,2],YFS2014$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013$SSB[,2],YFS2013$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012$SSB[,2],YFS2012$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011$SSB[,2],YFS2011$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010$SSB[,2],YFS2010$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))
 
retro=as.data.frame(rbind(ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18,ret19,ret20))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2020",length(c(1954:2020))),rep("2019",length(c(1954:2019))),rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p18_2=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

p18_1+ggtitle("Model 18.1")
p18_2+ggtitle("Model 18.2")

```
`r figure_nums(name="retro1",caption = paste("Retrospective plot of female spawning biomass for Model 18.1 (upper panel) and Model 18.2 (lower panel).",sep=""))`

\pagebreak

```{r retro2, echo=FALSE,message=FALSE}
#plot differences
Years=c(c(1954:2019),c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010))


Difference=c(-1*(YFS2020$SSB[1:66,2]-YFS2019$SSB[,2])/YFS2020$SSB[1:66,2],
-1*(YFS2020$SSB[1:65,2]-YFS2018$SSB[,2])/YFS2020$SSB[1:65,2],
-1*(YFS2020$SSB[1:64,2]-YFS2017$SSB[,2])/YFS2020$SSB[1:64,2],
-1*(YFS2020$SSB[1:63,2]-YFS2016$SSB[,2])/YFS2020$SSB[1:63,2],
-1*(YFS2020$SSB[1:62,2]-YFS2015$SSB[,2])/YFS2020$SSB[1:62,2],
-1*(YFS2020$SSB[1:61,2]-YFS2014$SSB[,2])/YFS2020$SSB[1:61,2],
-1*(YFS2020$SSB[1:60,2]-YFS2013$SSB[,2])/YFS2020$SSB[1:60,2],
-1*(YFS2020$SSB[1:59,2]-YFS2012$SSB[,2])/YFS2020$SSB[1:59,2],
-1*(YFS2020$SSB[1:58,2]-YFS2011$SSB[,2])/YFS2020$SSB[1:58,2],
-1*(YFS2020$SSB[1:57,2]-YFS2010$SSB[,2])/YFS2020$SSB[1:57,2]) 


Difference18_1=c(-1*(YFS202018_1$SSB[1:66,2]-YFS201918_1$SSB[,2])/YFS202018_1$SSB[1:66,2],
-1*(YFS202018_1$SSB[1:65,2]-YFS201818_1$SSB[,2])/YFS202018_1$SSB[1:65,2],
-1*(YFS202018_1$SSB[1:64,2]-YFS201718_1$SSB[,2])/YFS202018_1$SSB[1:64,2],
-1*(YFS202018_1$SSB[1:63,2]-YFS201618_1$SSB[,2])/YFS202018_1$SSB[1:63,2],
-1*(YFS202018_1$SSB[1:62,2]-YFS201518_1$SSB[,2])/YFS202018_1$SSB[1:62,2],
-1*(YFS202018_1$SSB[1:61,2]-YFS201418_1$SSB[,2])/YFS202018_1$SSB[1:61,2],
-1*(YFS202018_1$SSB[1:60,2]-YFS201318_1$SSB[,2])/YFS202018_1$SSB[1:60,2],
-1*(YFS202018_1$SSB[1:59,2]-YFS201218_1$SSB[,2])/YFS202018_1$SSB[1:59,2],
-1*(YFS202018_1$SSB[1:58,2]-YFS201118_1$SSB[,2])/YFS202018_1$SSB[1:58,2],
-1*(YFS202018_1$SSB[1:57,2]-YFS201018_1$SSB[,2])/YFS202018_1$SSB[1:57,2]) 

Year=(c(rep("2019",length(c(1954:2019))),rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)
dat18_1=data.frame(Years,Difference18_1,Year)

p18_2=ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))


p18_1=ggplot(data=dat18_1,aes(x=Years,y=Difference18_1,type=Year))+geom_line(aes(x=Years,y=Difference18_1, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2020, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))

p18_1+ggtitle("Model 18.1")
p18_2+ggtitle("Model 18.2")
```
`r figure_nums(name="retro2",caption = paste("Relative differences spawning biomass between the ",thisyr," model and the retrospective model run for years ",thisyr-1," through ",thisyr-10,", Models 18.1 and 18.2.",sep=""))`

\pagebreak
```{r phaseplane}
#phase plane plot
par(mar=c(5,5,3,2))
par(mfrow=c(1,1))
F40=extra_sd2$HM_Fmsyr[1]
B40=extra_sd2$Bmsy[1]
FOFL=extra_sd2$AM_Fmsyr[1]
plot(0,0,xlim=c(0,max(YFS2$SSB[,2])*1.1),ylim=c(0,FOFL*1.6),col=1,xlab="Estimated female spawning biomass (x 1,000 t)",ylab="Estimated fishing mortality rate",cex.axis=1.2,cex.lab=1.1,pch=-1,cex=.00001)
segments(0,0,B40,F40,col="green",lwd=4)
segments(B40,F40,max(YFS2$SSB[,2])*1.1,F40,col="green",lwd=4)
abline(h=FOFL,lty=1)
abline(v=B40,lty=2)
legend("topright",c(expression("F" ["OFL"]),expression("B" ["MSY"]),expression("F" ["MSY"])),lwd=c(1,1,4),lty=c(1,2,1), col=c("black","black","green"),cex=1.1,bty="n")

#note: female and male fishing mortality rate is the same
points(YFS2$SSB[21:67,2],YFS2$F_f[21:67,19],type="l",col="red",lwd=4)

points(YFS2$SSB[67,2],YFS2$F_f[67,19],pch=15,col="red")
text(YFS2$SSB[67,2]-60,YFS2$F_f[67,19]+.005,"2020",cex=0.9)

#for(i in 1: 59){
#text(ATF2019$fspbio[i]  ,ATF2019$fishmort[i],labels=as.character(seq(1961,2019,1))[i],cex=0.9)}

points(extra_sd2$SSB[1],extra_sd2$Catch_Assump[1]/extra_sd2$GM_Biom[1],pch=15,col="blue")
text(extra_sd2$SSB[1],(extra_sd2$Catch_Assump[1]/extra_sd2$GM_Biom[1])+.005,"2021",cex=0.9)

points(extra_sd2$SSB[2]+20,extra_sd2$Catch_Assump[2]/extra_sd2$GM_Biom[2],pch=15,col="black")
text(extra_sd2$SSB[2]-60,(extra_sd2$Catch_Assump[2]/extra_sd2$GM_Biom[2])+.005,"2022",cex=0.9)


```

`r figure_nums(name="phaseplane",caption = paste("Fishing mortality rate and female spawning biomass from 1975 to ",thisyr," compared to the F35% and F40% control rules, based on Model 18.2.  Vertical line is B35%. Squares indicate estimates for 2020, 2021, and 2022.",sep=""))`

\pagebreak

## Appendix A

Table A1. Removals (kg) of Yellowfin Sole from the Bering Sea from sources other than those that are included in the Alaska Region’s official estimate of catch, 1990-`r thisyr`. Source NMFS Alaska Region: Sourced by the AKR.V_NONCOMMERCIAL_FISHERY_CATCH table, October 23, `r thisyr`. Abbreviations: IPHC (International Pacific Halibut Commission), ADFG (Alaska Department of Fish and Gam), NMFS (National Marine Fisheries Service).

```{r rescat2,message=FALSE,echo=FALSE}
recatch2=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/NoncommercialFishery CatchYFS_10_23_20.csv",header=TRUE)
yr=names(table(recatch2$Year))
ag=names(table(recatch2$Agency))
col=matrix(0,length(yr),length(ag))
for (i in 1:length(yr)){
 for(j in 1:length(ag)){
  col[i,j]=sum(recatch2$Weight[which(recatch2$Year==yr[i]&recatch2$Agency==ag[j])])
}}
col1=formatC(round(col),format="d",big.mark=",")
colnames(col1)=ag
rownames(col1)=yr

kable(col1,"latex",booktabs=T,linesep="",align="r")


#plot catch
#cat=data.frame(cbind(seq(1954,2020)),YFS2$Obs_catch)
#colnames(cat)=c("Year","Catch")
#ggplot(cat)+geom_line(data=cat,aes(x=Year,y=Catch))+geom_point(aes(x=2020,y=127.020),color="blue")+s#cale_x_continuous(breaks = seq(1954,2020, by = 6))+theme_bw()
```

\pagebreak

## Appendix B

Flatfish (BSAI) Economic Performance Report for 2019 (Author: Ben Fissel)

BSAI FMP flatfish are predominantly caught in the Eastern Bering Sea by catcher/processors in the Amendment 80 Fleet.  In 2019, total catch of FMP flatfish in the BSAI was 207 thousand t. Retained catch was 197 thousand t, which was a slight decrease (<1%) and was below the average catches between 2010-2014. The two most significant flatfish species in terms of market value and volume are yellowfin and rock sole.  These two species accounted for 64% and 12%, respectively, of the retained flatfish catch. Flathead sole, arrowtooth flounder, and Kamchatka flounder are also caught in significant quantities accounting for approximately 5-10% of the retained flatfish. The remainder of the catch volume is comprised of other flatfish which includes Alaska plaice and Greenland turbot. First-wholesale value decreased 1% to $210 million with a marginal decrease in prices. 
In 2008, Amendment 80 to the BSAI FMP rationalized the non-pollock groundfish fisheries by instituting a catch-share system that annually allocates quota. The group of catcher processors managed under this system is referred to as the Amendment 80 Fleet. The species targeted by the Amendment 80 fleet include flatfish. Amendment 80 also mandated improved retention and utilization of fishery resources, which lowered discard and bycatch rates. Since 2008 total FMP flatfish catch has increased to an average of 265 thousand t over 2008-2012 from 184 thousand t in 2003-2007, and retention has increased from approximately 70% to 90%. In late 2014 flatfish harvest specification flexibility was implemented through Amendment 105 that allows Amendment 80 and CDQ entities to exchange harvest allocation between yellowfin sole, rock sole, and flathead sole. The Alaska flatfish undergo relatively low fishing pressure and harvests are routinely below their TAC and TACs are below the Allowable Biological Catches (ABC) because of the 2 million metric ton cap on Bering Sea groundfish catch. While the TAC is not typically a binding constraint on the fishery, industry may react to TAC changes. Since 2012 approximately 75-80% of the aggregate flatfish TACs have been caught and TACs are approximately 43-55% of the aggregate ABCs, though these proportions vary across individual species.

First-wholesale value in the BSAI flatfish fisheries decreased 1% to $209.8 million with a 4% decrease in yellowfin sole price, a 6% decrease in the rock sole price, an 11% decrease in the flathead sole price, and an 8% decrease in the arrowtooth flounder price. Prices for most flatfish were at a decadal high in 2018 and the marginal decreases in 2019 left prices at a high level relative to prices over the last decade. Flatfish are primarily processed into the headed-and-gutted (H&G) and whole fish product forms and changes in production largely reflect changes in catch. The export volume of yellowfin sole and rock sole is approximately 75-90% of the annual volume of processed products.  Exports are primarily destined for China and South Korea, with China typically accounting approximately 80-85% of total exports. In 2019 China’s share of exports dropped to 71% and South Korea’s share of value increased from approximately 15% to 20% in 2019. A significant share of this product is re-processed into fillets and re-exported to North American and European markets. Flatfish can serve as a substitute for other higher priced whitefish products, and price changes for these other species can influence flatfish demand. Some rock sole is processed as H&G with roe, which is a higher priced product which is primarily destined f or Japanese markets. The Alaska flatfish fishery became MSC certified in 2010 and received the Responsible Fishery Management (RFM) certification in 2014. Certification provides access to some markets, particularly in Europe, and may enhance value. Some media reports have attributed the price increase in 2011 to the MSC certification and Asian markets where demand is expected to increase with growth in the middle class population. Reduced fishing opportunities in 2013-2014 for higher valued Atka mackerel may have diverted additional fishing effort towards flatfish increasing catch in these years. Increased supply and inventories from the additional catch put downward pressure on prices. As Atka mackerel fishing resumed more normal levels in 2015 and later, flatfish supply and inventories were reduced, prices began to rise. Atka mackerel catches were high in 2017 and 2018 which may have contributed to the reduced catch of flatfish despite high prices. Because of China’s significance as a re-processor of flatfish products, the tariffs between the U.S. and China have put downward pressure on flatfish prices and may inhibit value growth in some flatfish markets. Industry lacks immediate alternative reprocessing options to China. Export quantities of yellowfin sole and rock sole increased in 2019 from 2018 and the share of exports to China decreased despite rising export prices (Table 2).

Table 1. BSAI flatfish catch and first-wholesale market data. Total and retained catch (thousand metric tons), number of vessels, first-wholesale production (thousand metric tons), value (million US\$), price (US\$ per pound), and head and gut share of production; 2010-2014 average and 2015-2019.


```{r, fisselT1,echo=FALSE}
fisselT1=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Fissel_T1.csv")

colnames(fisselT1)=c("","2010-2014 Average","2015","2016","2017","2018","2019")
kable(fisselT1,"latex",booktabs=T,linesep="",longtable=FALSE,align=c("l","r","r","r","r","r","r"))%>%kable_styling(latex_options="scale_down")


```
 
Source: NMFS Alaska Region Blend and Catch-accounting System estimates; NMFS Alaska Region At-sea Production Reports; and ADF&G Commercial Operators Annual Reports (COAR). Data compiled and provided by the Alaska Fisheries Information Network (AKFIN).

\pagebreak

Table 2. Flatfish U.S. trade and global market data. Global production (thousand metric tons), U.S. share of global production, BSAI share of U.S. production. U.S. yellowfin sole and rock sole export volume (thousand metric tons), U.S. export value (million US \$), U.S. export price (US\$ per pound), the share of U.S. export value from China, and the Euro/U.S. Dollar exchange rate; 2010-2014 average and 2015-2019.

```{r, fisselT2,echo=FALSE}
fisselT2=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/Fissel_T2.csv")

colnames(fisselT2)=c("","2010-2014 Average","2015","2016","2017","2018","2019")

kable(fisselT2,"latex",booktabs=T,linesep="",longtable=FALSE,align=c("l","r","r","r","r","r","r"))%>%kable_styling(latex_options="scale_down")



```
 
Source: FAO Fisheries & Aquaculture Dept. Statistics http://www.fao.org/fishery/statistics/en. NOAA Fisheries, Fisheries Statistics Division, Foreign Trade Division of the U.S. Census Bureau, http://www.st.nmfs.noaa.gov/commercial-fisheries/foreign-trade/index. U.S. Department of Agriculture http://www.ers.usda.gov/data-products/agricultural-exchange-rate-data-set.aspx.
1 - The BSAI FMP share of U.S. production is calculated as the BSAI retained catch divided by the FAO's U.S. production of flounder, halibut and sole.




 