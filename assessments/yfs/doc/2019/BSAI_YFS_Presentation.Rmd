---
title: "Assessment of the Yellowfin Sole Stock in the Bering Sea and Aleutian Islands"
author: "Ingrid Spies, Thomas K. Wilderbuer, Daniel G. Nichol, and James Ianelli"
date: "11/13/2019"
output:
  beamer_presentation: 
    colortheme: dove
    fonttheme: serif
  pdf_document: 
    keep_tex: yes
theme: default
---

---
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \useinnertheme{circles}
- \useinnertheme{circles}
- \titlegraphic{\includegraphics[width=6cm]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/YFS_image.png}}
---

---

```{r global_options, include=FALSE,message=FALSE}
library(here)
library(here)
library(adnuts)
library(ggplot2)
library(RColorBrewer)
library(doBy)
library(tidyr)
library(dplyr)
library(gridExtra)
library(tidyverse)
library(purrr)
library(stringr)
library(ggplot2)
library(knitr)
library(kableExtra)
options(knitr.kable.NA = '')
knitr::opts_knit$set(root.dir = '../../' )
library(captioner)
library(bibtex)
library(knitcitations)
library(cowplot)
library(magick)
library(bookdown)
library(ggthemes)
library(scales)
library(gridExtra)
library(RColorBrewer)
library(ggridges)
require(knitr)
library(scales)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(ggmap)
library(widyr)
library(scales)
#install.packages("formattable")
#install.packages("formattable")
library(flextable)
library(officer)
library(ggthemes)

require(kfigr) # devtools::install_github("github mkoohafkan/kfigr")
opts_chunk$set(message=FALSE, warning=FALSE)

table_nums <- captioner::captioner(prefix = "Table 4.",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure 4.",levels = 1, auto_space = FALSE)

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")
#clean_cache(clean = TRUE)

thisyr    = 2019

source("/Users/ingridspies/admbmodels/Katch/assessments/R/read-rep.R")
#source("/Users/ingridspies/admbmodels/flatfish/assessments/R/plot_m.R")
YFS0=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/fm.rep")
YFS1=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/fm.rep")
YFS2=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/fm.rep")
extra_sd2=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/extra_sd.rep",header=TRUE)
extra_sd1=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/extra_sd.rep",header=TRUE)
extra_sd0=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2018/extra_sd.rep",header=TRUE)
B0_2=formatC(1000*YFS2$Bzero,format="d",big.mark=",")
B0_1=formatC(1000*YFS1$Bzero,format="d",big.mark=",")
B0_0=formatC(1000*YFS0$Bzero,format="d",big.mark=",")

ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_next=1000*extra_sd2$ABC_HM[1]
TotBio_this=extra_sd2$GM_Biom[1]*1000
TotBio_next=extra_sd2$GM_Biom[2]*1000

femcat=YFS2$catage_f/rowSums(YFS2$catage_f)
malcat=YFS2$catage_m/rowSums(YFS2$catage_m)

#Base version M0.34,with fishlenlikelihood, stark mat
bigfile=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/bigfile.out",header=TRUE)

percentiles=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentiles.out",nrows =1,header=TRUE)

percentdb=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentdb.out")

PABC_this=1000*mean(bigfile$ABC[which(bigfile$Yr==2020&bigfile$Alternative==1)])#average catch 
PABC_thisF=formatC(PABC_this,format="d",big.mark=",")  #pmeans from proejction

PABC_next=1000*mean(bigfile$ABC[which(bigfile$Yr==2021&bigfile$Alternative==1)])       
PABC_nextF=formatC(PABC_next,format="d",big.mark=",")

ABC_last=267500
ABC_this=1000*extra_sd2$ABC_HM[1]
ABC_thisF=formatC(ABC_this,format="d",big.mark=",")

ABC_next=1000*extra_sd2$ABC_HM[2]
ABC_nextF=formatC(ABC_next,format="d",big.mark=",")

OFL_this=1000*extra_sd2$OFL_AM[1]
OFL_thisF=formatC(OFL_this,format="d",big.mark=",")

OFL_next=1000*extra_sd2$OFL_AM[2]
OFL_nextF=formatC(OFL_next,format="d",big.mark=",")

TotBio_this=1000*extra_sd2$GM_Biom[1]
TotBio_thisF=formatC(TotBio_this,format="d",big.mark=",")

TotBio_next=1000*extra_sd2$GM_Biom[2]
TotBio_nextF=formatC(TotBio_next,format="d",big.mark=",")

TotBio_last=2331500
TotBio_lastF=formatC(TotBio_last,format="d",big.mark=",")

FSB_this=1000*extra_sd2$SSB[1]
FSB_thisF=formatC(FSB_this,format="d",big.mark=",")

FSB_next=1000*extra_sd2$SSB[2]
FSB_nextF=formatC(FSB_next,format="d",big.mark=",")

FSB_last=796600
FSB_lastF=formatC(FSB_last,format="d",big.mark=",")

FABC_this=round(extra_sd2$HM_Fmsyr[1],3)

FABC_next=round(extra_sd2$HM_Fmsyr[2],3)

FOFL_this=round(extra_sd2$AM_Fmsyr[1],3)
FOFL_next=round(extra_sd2$AM_Fmsyr[2],3)

Bmsy_this=1000*extra_sd2$Bmsy[1]
Bmsy_thisF=formatC(Bmsy_this,format="d",big.mark=",")

Bmsy_next=1000*extra_sd2$Bmsy[2]
Bmsy_nextF=formatC(Bmsy_next,format="d",big.mark=",")

catmo=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/YFScatch_OBSINT.csv",header=TRUE)

#proportion caught before November 2014-2018
prop=sum(catmo$TOTAL_WEIGHT[which(catmo$Month<11&catmo$Year<2019&catmo$Year>2013)])/sum(catmo$TOTAL_WEIGHT[which(catmo$Year<2019&catmo$Year>2013)])

catchZ=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/catch_YFS.csv",header=TRUE,skip=1)

c10=catchZ$Total[(nrow(catchZ)-10):(nrow(catchZ)-1)]
cn=str_replace(c10, ",", "")
cn10=mean(as.numeric(cn))#average catch last 10 years
```


## Responses to SSC and Plan Team Comments Specific to this Assessment

_SSC December 2018_

* The SSC encourages further exploration of the way mortality is handled in the model, for example through the use of sex-specific or time-varying mortality and the authors noted that they may be able to explore this more fully in 2019.

_Authors' response_

In the current assessment, a model was explored that used a fixed value for female natural mortality, and allowed male natural mortality to be estimated by within the model (Model 18.2).

## Two models were considered in this assessment.

* Model 18.1a: Same model as in the 2018 assessment, updated with 2019 data. Model 18.1a used the same natural mortality for males and females, $M$=0.12. 
   
* Model 18.2: Uses a fixed value for female natural mortality ($M$=0.12) and allowed male natural mortality to be estimated within the model. Model 18.2 is the preferred model.

## Responses to SSC and Plan Team Comments Specific to this Assessment

_SSC December 2018_

\small

* Given recent changes in the distribution of other species, the SSC encourages authors to explore variability over time in the proportion of the stock in the NBS. 

* Consider approaches for including the substantial biomass of NBS Yellowfin Sole in the model, with the expectations that NBS surveys will be conducted regularly in the future.

\normalsize

## Annual EBS and NBS bottom trawl survey biomass and 95% CIs for Yellowfin Sole, 1982-2019.

```{r srvCI, message=FALSE, echo=FALSE}  
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio=data.frame(cbind(YFS2$yrs_srv,1000*YFS2$ob_bts,1000*LCI,1000*HCI))

colnames(srv_bio)=c("Year","Biomass","LCI","UCI")


NBSbiomass2019=520028.93
NBSvariance2019=3868517857.3
NBS=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_survey/NBS_YFS.csv",header=TRUE)
colnames(NBS)=c("Year","Biomass (t)","LCI","HCI","Haul count","Hauls with catch","Number count","Length count")

NBS1 <- sapply(NBS, gsub, pattern = ",", replacement= "")
NBS2=as.data.frame(NBS1[,1:4])
colnames(NBS2)=c("Year","Biomass","LCI","UCI")
NBS2$Year=as.numeric(as.character(NBS2$Year))
NBS2$Biomass=as.numeric(as.character(NBS2$Biomass))
NBS2$LCI=as.numeric(as.character(NBS2$LCI))
NBS2$UCI=as.numeric(as.character(NBS2$UCI))

srvB=rbind(srv_bio,NBS2)
srvB$Survey=c(rep("EBS",nrow(srv_bio)),rep("NBS",nrow(NBS2)))

ggplot()+geom_line(data=srvB,aes(x=Year,y=Biomass,color=Survey))+geom_ribbon(data=srvB,aes(x=Year,ymin=LCI, ymax=UCI,fill=Survey), alpha=0.3)+theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y =element_text(size=14))+ylab("Biomass (t)")+scale_x_continuous(breaks = seq(1982,2019, by = 2))+theme(axis.text.x=element_text(angle=45,hjust=1))


```


## Distribution of Yellowfin Sole in the Bering sea, top row: 2010, 2017, bottom row: 2018, 2019.

```{r NBS,echo=FALSE,message=FALSE}
```
\begin{figure}[h]
    \centering
    \includegraphics[width=0.36\textwidth]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_survey/yfs10bw.png}
    \includegraphics[width=0.36\textwidth]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_survey/yfs17bw.png}
    \includegraphics[width=0.36\textwidth]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_survey/yfs18bw.png}
    \includegraphics[width=0.36\textwidth]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_survey/yfs19bw.png}
\end{figure}


## Estimated numbers at length (mm) of Yellowfin Sole from the EBS and NBS surveys, 2017 and 2019.
```{r NBSEBSlens,message=FALSE, echo=FALSE}

is.integer0 <- function(x)
{
  is.integer(x) && length(x) == 0L
}

lens=seq(50,500,10)

ebsl=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/EBS Shelf YFSlens.csv",header=TRUE)

ebsltab=matrix(0,length(lens),5)
for(i in 1:length(lens)){
 if(is.integer0(ebsl$Number.of.Females[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2017&ebsl$Stratum==999)])==FALSE){  
  ebsltab[i,2]=ebsl$Number.of.Females[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2017&ebsl$Stratum==999)]}
   if(is.integer0(ebsl$Number.of.Males[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2017&ebsl$Stratum==999)])==FALSE){  
  ebsltab[i,3]=ebsl$Number.of.Males[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2017&ebsl$Stratum==999)]}
   if(is.integer0(ebsl$Number.of.Females[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2019&ebsl$Stratum==999)])==FALSE){  
  ebsltab[i,4]=ebsl$Number.of.Females[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2019&ebsl$Stratum==999)]}
   if(is.integer0(ebsl$Number.of.Males[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2019&ebsl$Stratum==999)])==FALSE){  
  ebsltab[i,5]=ebsl$Number.of.Males[which(ebsl$Fish.Length..mm.==lens[i]&ebsl$Year==2019&ebsl$Stratum==999)]}
}
ebsltab[,1]=lens
colnames(ebsltab)=c("Length","2017 Females","2017 Males","2019 Females","2019 Males")

Females=c(ebsltab[,2],ebsltab[,4])
Males=c(ebsltab[,3],ebsltab[,5])
Proportion=c(Males,Females)
Length=rep(lens,4)
Sex=c(rep("Males",2*nrow(ebsltab)),rep("Females",2*nrow(ebsltab)))
Year=c(rep(2017,nrow(ebsltab)),rep(2019,nrow(ebsltab)),rep(2017,nrow(ebsltab)),rep(2019,nrow(ebsltab)))
EBSlen=data.frame(Proportion,Sex,Year,Length)   

p1=ggplot(data=EBSlen)+geom_line(aes(x=Length,y=Proportion,group=Sex,color=Sex))+facet_wrap(~Year)+theme_bw()+ggtitle("Eastern Bering Sea")

nbsl=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NBS_YFS_lens.csv",header=TRUE)

nbsl[is.na(nbsl)] <- 0
Males=c(nbsl[,2],nbsl[,4])
Females=c(nbsl[,3],nbsl[,5])
Proportion=c(Males,Females)
Length=rep(lens,4)
Sex=c(rep("Males",2*nrow(nbsl)),rep("Females",2*nrow(nbsl)))
Year=c(rep(2017,nrow(nbsl)),rep(2019,nrow(nbsl)),rep(2017,nrow(nbsl)),rep(2019,nrow(nbsl)))
NBSlen=data.frame(Proportion,Sex,Year,Length)

p2=ggplot(data=NBSlen)+geom_line(aes(x=Length,y=Proportion,group=Sex,color=Sex))+facet_wrap(~Year)+theme_bw()+ggtitle("Northern Bering Sea")

grid.arrange(p1, p2, ncol = 1)

```


## Size composition of the Yellowfin Sole catch in 2019 (through mid-September), by subarea and total.
```{r obs_sizecomp,message=FALSE,echo=FALSE}
sc=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/2019YFSfisherylengths.csv",header=TRUE)
sc1=sc/colSums(sc)


Males=c(sc[,2]/sum(sc[,2]),sc[,5]/sum(sc[,5]),sc[,8]/sum(sc[,8]),sc[,11]/sum(sc[,11]),sc[,14]/sum(sc[,14]),sc[,17]/sum(sc[,17]))
Females=c(sc[,3]/sum(sc[,3]),sc[,6]/sum(sc[,6]),sc[,9]/sum(sc[,9]),sc[,12]/sum(sc[,12]),sc[,15]/sum(sc[,15]),sc[,18]/sum(sc[,18]))
Area=rep(c(rep(509,nrow(sc)),rep(513,nrow(sc)),rep(514,nrow(sc)),rep(516,nrow(sc)),rep(517,nrow(sc)),rep("All",nrow(sc))),2)
Proportion=c(Males,Females)
Length=rep(sc[,1],12)
Sex=c(rep("Males",length(Males)),rep("Females",length(Females)))

sctab=data.frame(Area,Proportion,Sex,Length)
ggplot(sctab)+geom_line(aes(x=Length,y=Proportion,group=Sex,color=Sex))+facet_wrap(~Area)+theme_bw()
```

## NMFS areas 

\begin{center}
\includegraphics[width=8.5in,angle=270,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/NMFSareaz.pdf}
\end{center}


## Areas of largest catch in 2019 were 513 and 514.

```{r pie_bymonth,fig.align='center',message=FALSE, echo=FALSE,fig.align='center',fig.height=5}  
library(scales)
par(mar=c(5,6,6,1))
retdis=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/RetDis_full.csv",header=TRUE)#Sept 25 2019
retdis2019=retdis[which(retdis$Year=="2019"),]
area=names(table(retdis2019$Reporting.Area.Code))
areaz=vector()
for(i in 1:length(area)){
 areaz[i]=sum(retdis2019$Total.Catch..mt.[which(retdis2019$Reporting.Area.Code==area[i])])
}
area_res=as.data.frame(cbind(area,round(areaz)))
area_res2=area_res[which(as.numeric(as.character(area_res[,2]))>1000),]
area_res3=data.frame(as.factor(as.character(area_res2[,1])),as.numeric(as.character(area_res2[,2])))
area_res4=cbind(area_res3,area_res3[,2]/sum(area_res3[,2]))
colnames(area_res4)=c("NMFS.Area","Catch_full","Catch")
area_res5=cbind(area_res4,cumsum(area_res4$Catch)-(area_res4$Catch/2))
colnames(area_res5)=c("NMFS.Area","Catch_full","Catch","pos")

blank_theme <- theme_minimal()+
  theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  plot.title=element_text(size=14, face="bold")
  )

ggplot(area_res5, aes(x="", y=Catch, fill=NMFS.Area))+geom_bar(width = 2, stat = "identity")+coord_polar("y",start=0,direction=1)+blank_theme+theme(axis.text.x=element_blank()) +geom_text(aes(label = NMFS.Area),position = position_stack(vjust = 0.5),size=c(4,4,8,8,4))+scale_fill_discrete(name = "NMFS Area")+ theme(legend.text=element_text(size=15),legend.title=element_text(size=16))

```


## Largest fishery months in 2019 were February - May.
```{r fig_3b, message=FALSE, echo=FALSE,fig.align='center'} 
#blend_catchYFS=read.csv("/Users/ingridspies/YFS_Blend_CAS.csv",header=TRUE)
#blend_catch2019=blend_catchYFS[which(blend_catchYFS$Year==2019),]
#cat_mo2019=data.frame(cbind(c("January","February","March","April","May","June","July","August","September"),table(blend_catch2019$Month)))
#write.csv(cat_mo2019,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/cat_mo2019b.csv")
cat_mo2019b=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/cat_mo2019b.csv")
colnames(cat_mo2019b)=c("N","Month","Catch")
cat_mo2019b$Month=factor(cat_mo2019b$Month,levels=cat_mo2019b$Month)
cat_mo2019b$Catch=as.numeric(as.character(cat_mo2019b$Catch))
Proportion=percent(round(cat_mo2019b$Catch/sum(cat_mo2019b$Catch),2))
cm2019=cbind(cat_mo2019b,Proportion)

ggplot(cm2019, aes(x="", y=Catch, fill=Month))+
 geom_bar(width = 2, stat = "identity")+
 coord_polar("y", start=0,direction=-1)+
 blank_theme+theme(axis.text.x=element_blank()) +
 geom_text(aes(label = Proportion),position = position_stack(vjust =0.5),vjust=c(-.3,rep(1.1,8)),hjust=c(rep(.5,8),.3), size=c(5,rep(5,8)))+scale_fill_discrete(name = "Month")+ 
 theme(legend.text=element_text(size=15),legend.title=element_text(size=16))
 
```



## Difference between the 1985-2018 average trawl survey CPUE for yellowfin sole and the 2019 survey CPUE. 


```{r cpuediff,message=FALSE,echo=FALSE}

```
\begin{center}
    \includegraphics[width=3in]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/yfs_cpuediff_2019_arcmap.pdf}
\end{center}
\tiny

Green circles indicate that the magnitude of the catch was greater in 2019 than the long-term average, red circles indicate the catch was greater in the longterm
average than in 2019.
\normalsize

## Yellowfin Sole annual total catch (1,000s t) in the Eastern Bering Sea from 1954-2019. 
   
```{r catchfig, message=FALSE, echo=FALSE}  
catchtab=data.frame(cbind(YFS2$Yr,YFS2$Obs_catch))
colnames(catchtab)=c("Year","Catch")
ggplot(data=catchtab,aes(x=Year,y=Catch))+geom_line(aes(x=Year,y=Catch))+
theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Catch (x 1,000 t)")+scale_x_continuous(breaks = seq(1954,2019, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=1))+
 theme(legend.position="right")+scale_color_discrete(name="")
```


## Catch per unit effort on NMFS eastern Bering Sea surveys, 1982-2019. Units are in kg/km2.

```{r cpueline,message=FALSE,echo=FALSE}
cpue=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/race_cpue_by_haul.csv",header=TRUE)
yr=names(table(cpue$Year))
cpueyr=vector()
for(i in 1:length(yr)){
cpueyr[i]=sum(cpue$Weight.CPUE..kg.km2.[which(cpue$Year==yr[i])]) 
}

cp=data.frame(as.numeric(yr),cpueyr)
colnames(cp)=c("Year","CPUE")

ggplot(cp)+geom_line(aes(x=Year,y=CPUE),size=1.2)+labs(x = "Year", y = "CPUE")+theme_bw()

```


## Distribution of wintering, spawning, and feeding areas for Yellowfin Sole in the Bering Sea.

```{r spawnplot,echo=FALSE,message=FALSE}

```

\begin{center}
\includegraphics[height=3in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/Yellowfin Sole Spawning Distribution-B.pdf}
\end{center}

## Otolith growth rings show correlation between growth and temperature.

\begin{center}
\includegraphics[width=5in,angle=270,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/Black_Fig3.pdf}
\end{center}


## Yellowfin Sole length-at-age anomalies, for 5-year old males and females, and bottom temperature anomalies.  
```{r tempanom, message=FALSE, echo=FALSE}  
YFSage=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/YFSage.csv",header=TRUE)
fem5=vector();mal5=vector()
yrs=names(table(substr(YFSage$CRUISE,1,4)))
for(i in 1:length(yrs)){
 fem5[i]=mean(YFSage$LENGTH[which(YFSage$AGE==5&substr(YFSage$CRUISE,1,4)==yrs[i]&YFSage$SEX==2)])
 mal5[i]=mean(YFSage$LENGTH[which(YFSage$AGE==5&substr(YFSage$CRUISE,1,4)==yrs[i]&YFSage$SEX==1)])
}

Year=rep(seq(1982,2018,1),3)
Series=c(rep("Temperature",37),rep("Males",37),rep("Females",37))
Data=c(10*YFS2$Bottom_temp[1,1:37],(mal5[9:45]-mean(mal5[9:45])),(fem5[9:45]-mean(fem5[9:45])))       
env=data.frame(Year,Series,Data)

ggplot(data=env,aes(x=Year,y=Data,type=Series))+geom_line(aes(x=Year,y=Data,color=Series))+theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+ylab("Anomaly")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=1))+geom_hline(yintercept=0,linetype=1)


```
\tiny
Note: Bottom temperature anomalies scaled up by a factor of 10 to demonstrate pattern.
\normalsize


## Data included in the model

\small
Data source                                         Year
--------------------------------------------------- ----------------------------   
Fishery catch                                       1954 - `r thisyr`            
Fishery age composition	                            1964 - `r thisyr-1`          
Fishery weight-at-age	                              1964 - `r thisyr-1`  
Survey biomass and standard error                   1982 - `r thisyr` 
Bottom temperature	                                 1982 - `r thisyr` 
Survey age composition	                             1979 - `r thisyr-1` 
Annual length, weight-at-age surveys	               1979 - `r thisyr-1` 
Age at maturity	                                    Combined 1992 and 2012 samples
----------------------- 
\normalsize


## Maturity at age

* Yellowfin Sole maturity schedules estimated from two studies
* Nichol (1995) and TenBrink and Wilderbuer (2015)
 
```{r mature,message=FALSE,echo=FALSE,fig.width=7,fig.height=4}
mat=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/maturity_T10.csv",header=TRUE)
colnames(mat)=c("Age","1992, 1993 samples","2012 samples","Combined")

ggplot(data=mat)+geom_line(aes(x=Age,y=Combined))+theme_bw()

```

## Selectivity

* Two parameter formulation of the logistic function. 

* Used for fishery and survey.

* Modeled separately for males and females.

## Catchability

Survey catchability model was introduced in 2018, Model 18.1a.

* Included survey start date. 

* This feature retained in current model.

$q=e^{-{\alpha}+{\beta}T+{\gamma}S+{\mu}T:S},$

where $T$=survey bottom temperature (averaged per year for all stations <100 m), $S$=survey start date, and $T:S$=interaction of $T$ and $S$. 


## Spawner-Recruit Estimation

Annual recruitment estimates from 1978-2013 were constrained to fit a Ricker (1958) stock recruitment relationship:

$R={\alpha}Se^{-{\beta}S},$

where $R$ is age 1 recruitment, $S$ is female spawning biomass in metric tons the previous year, and $\alpha$ and $\beta$ are parameters estimated by the model. 


                                                     

## Estimate of survey selectivity for males and females, Model 18.1a upper panel, Model 18.2 lower panel.
```{r srvsel, echo=FALSE, message=FALSE}
srvsel2=data.frame(cbind(seq(1,20,1),YFS2$sel_srv_f,YFS2$sel_srv_m))
colnames(srvsel2)=c("Age","Female","Male")
p2=ggplot(data=srvsel2)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.2")

srvsel1=data.frame(cbind(seq(1,20,1),YFS1$sel_srv_f,YFS1$sel_srv_m))
colnames(srvsel1)=c("Age","Female","Male")
p1=ggplot(data=srvsel1)+geom_line(aes(x=Age,y=Female,col="Female"))+geom_line(aes(x=Age,y=Male,col="Male"))+theme_bw()+
 theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Proportion selected")+scale_x_continuous(breaks = seq(1,20, by = 2))+scale_color_discrete(name="")+ggtitle("Model 18.1a")

grid.arrange(p1, p2, ncol = 1)


```




## Estimate of fishery selectivity for males and females, 1954-2019.

```{r fshsel,echo=FALSE,message=FALSE}
#sf=data.frame(rep(seq(1954,2019,1),20),rep(seq(1,20,1),each=66),as.vector(YFS2$sel_fsh_f))
#colnames(sf)=c("Year","Age","Selectivity")
#ggplot(data=sf,x=Age,y=Selectivity)+geom_line(aes(x=Age,y=Selectivity))+facet_wrap(~Year)+th#eme_few()+ theme(axis.text.x = element_text(angle = 90, hjust = 1, size=7))+ #theme(axis.text.y = element_text(angle = 0, hjust = 1, size=7))

#sf=data.frame(rep(seq(1954,2019,1),each=20),rep(seq(1,20,1),66),as.vector(t(YFS2$sel_fsh_f)))
#colnames(sf)=c("Year","Age","Selectivity")
#ggplot(data=sf,aes(x=Age,y=Selectivity,type=Year))+geom_line(aes(x=Age,y=Selectivity,colour=factor(Year)))+ylab("Fishery Selectivity")+xlab("Age")

mdf <- data.frame(Year=YFS2$Yr,Sex="males",YFS2$sel_fsh_m)
mdf <- rbind(mdf,data.frame(Year=YFS2$Yr,Sex="females",YFS2$sel_fsh_f))
names(mdf)[3:22] <- 1:20
sdf <- (gather(mdf,Age,selectivity,3:22) ) %>% filter(Year>=min(YFS2$Yr),Year<=max(YFS2$Yr)) %>% mutate(Age=as.numeric(Age)) #+ arrange(age,Year)

ggplot(sdf,aes(x=Age,y=fct_rev(as.factor(Year)),height = selectivity,fill=Sex,color=Sex,alpha=0.3)) +
 geom_density_ridges(stat = "identity",scale=1,alpha = 0.3) + ylab("Year")+ theme(axis.text.y = element_text(angle = 0, hjust = 1, size=5))+theme_bw()

```



## Survey catchability for Model 18.1a and 18.2, 1982-2019.

```{r plotq, message=FALSE,echo=FALSE}
    df <- data.frame( Year    = YFS2$yrs_srv )
    df$Model <- "Model 18.2"
    df$q_srv   <- YFS2$q_srv 
    
    df1 <- data.frame( Year    = YFS1$yrs_srv )
    df1$Model <- "Model 18.1a"
    df1$q_srv   <- YFS1$q_srv 
    
    df2=data.frame(rbind(df1,df))
    
    ggplot(df2) +geom_line(aes(x = Year, y = q_srv, col = Model),size=1.2)+ 
        labs(x = "Year", y = "Survey catchability")+theme_bw()

```


## Model estimates of the proportion of female Yellowfin Sole in the population, 1982-2018.

```{r sexratio,message=FALSE,echo=FALSE}
        df <- data.frame(rowSums(YFS2$natage_f)/rowSums(YFS2$natage_f+YFS2$natage_m))
        df$Model <- "Model 18.2"
        df$Year=YFS2$Yr
        colnames(df)=c("Sex_Ratio","Model","Year")
        
        df1 <- data.frame(rowSums(YFS1$natage_f)/rowSums(YFS1$natage_f+YFS1$natage_m))
        df1$Model <- "Model 18.1a"
        df1$Year=YFS2$Yr

        colnames(df1)=c("Sex_Ratio","Model","Year")
        df2=rbind(df1,df)
        
        ggplot(df2) + geom_point(data=df2, aes(x = Year, y = Sex_Ratio,color=Model),size=3)+labs(xlab = "Year", ylab = "Proportion female")+
          ylab("Proportion Female")+theme_bw()

```


## Likelihood table for Model 18.1a and 18.2
```{r liketab, echo=FALSE}
totallike2=sum(YFS2$wt_like,YFS2$age_likeihood_for_survey,YFS2$age_likelihood_for_fishery,YFS2$catch_likelihood,YFS2$selectivity_likelihood,YFS2$survey_likelihood,YFS2$recruitment_likelilhood) #recommended
totallike1=sum(YFS1$wt_like,YFS1$age_likeihood_for_survey,YFS1$age_likelihood_for_fishery,YFS1$catch_likelihood,YFS1$selectivity_likelihood,YFS1$survey_likelihood,YFS1$recruitment_likelilhood)  
```

\begin{table}[h]
\centering
\begin{tabular}{ lrr }
\hline
 Likelihood component & Model $18.1a$ & Model $18.2$ \\
\hline
Survey age	        &       `r round(YFS1$age_likeihood_for_survey,2)`  &  `r round(YFS2$age_likeihood_for_survey,2)`   \\
Fishery age  	  &       `r round(YFS1$age_likelihood_for_fishery,2)` &  `r round(YFS2$age_likelihood_for_fishery,2)`  \\
Selectivity     &       `r round(sum(YFS1$selectivity_likelihood),2)`& `r round(sum(YFS2$selectivity_likelihood),2)`\\
Survey biomass     &       `r round(YFS1$survey_likelihood,2)`& `r round(YFS2$survey_likelihood,2)`\\
Recruitment     &       `r round(sum(YFS1$recruitment_likelilhood),2)`& `r round(sum(YFS2$recruitment_likelilhood),2)`  \\
Catchability & `r round(YFS1$catch_likelihood,4)` & `r round(YFS2$catch_likelihood,4)` \\
\hline
Total              &       `r round(totallike1,2)`      &`r round(totallike2,2)`      \\ 
\hline
\end{tabular}
\end{table}

## Comparison of results for Model 18.1a and Model 18.2

\tiny
\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 18.2}  & \multicolumn{2}{c}{Model 18.1a}              \\
        Quantity & `r thisyr+1`      &`r thisyr+2`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
$M$ (natural mortality rate)         &  0.12, 0.135   & 0.12, 0.135  &  0.12   &  0.12   \\
Tier                                  &  1a   &  1a   &  1a   & 1a    \\
Projected total (age 6+) biomass (t)  &  `r formatC(extra_sd2$GM_Biom[1]*1000,format="d",big.mark=",")`   &  `r formatC(extra_sd2$GM_Biom[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$GM_Biom[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$GM_Biom[2]*1000,format="d",big.mark=",")`  \\
Projected female spawning biomass (t) &  `r formatC(extra_sd2$SSB[1]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd2$SSB[2]*1000,format="d",big.mark=",")`  &  `r formatC(extra_sd1$SSB[1]*1000,format="d",big.mark=",")`  & `r formatC(extra_sd1$SSB[2]*1000,format="d",big.mark=",")`  \\
$\:\:\:\:\:\:B_{100\%}$                           &  `r B0_2`  &  `r B0_2`  &  `r B0_1`  & `r B0_1`   \\
$\:\:\:\:\:\:B_{MSY\%}$                            &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$Bmsy[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")` t & `r formatC(1000*extra_sd1$Bmsy[1],format="d",big.mark=",")` t \\
$F_{OFL}$                             &  `r round(extra_sd2$AM_Fmsyr[1],3)`   &  `r round(extra_sd2$AM_Fmsyr[2],3)`   &  `r round(extra_sd1$AM_Fmsyr[1],3)`  & `r round(extra_sd1$AM_Fmsyr[2],3)`  \\
$maxF_{ABC}$                          &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &   `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`    & `r round(extra_sd1$HM_Fmsyr[2],3)`     \\
$F_{ABC}$                             &  `r round(extra_sd2$HM_Fmsyr[1],3)`   &  `r round(extra_sd2$HM_Fmsyr[2],3)`   &  `r round(extra_sd1$HM_Fmsyr[1],3)`   & `r round(extra_sd1$HM_Fmsyr[2],3)`   \\
$OFL$                                 &  `r formatC(1000*extra_sd2$OFL_AM[1],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd2$OFL_AM[2],format="d",big.mark=",")`  &  `r formatC(1000*extra_sd1$OFL_AM[1],format="d",big.mark=",")`  & `r formatC(1000*extra_sd1$OFL_AM[2],format="d",big.mark=",")` 
\\
$maxABC$                              &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") ` &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") `  \\
$ABC$                                 &  `r formatC(1000*extra_sd2$ABC_HM[1],format="d",big.mark=",") `  &  `r formatC(1000*extra_sd2$ABC_HM[2],format="d",big.mark=",") ` & `r formatC(1000*extra_sd1$ABC_HM[1],format="d",big.mark=",") `  & `r formatC(1000*extra_sd1$ABC_HM[2],format="d",big.mark=",") `  \\
\hline
Status                               & `r thisyr-1`       & `r thisyr`      &  `r thisyr-1`             & `r thisyr`            \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections for Model 18.1a and 18.2 were based on estimated catches of 118,642 t in `r thisyr` and `r formatC(cn10,format="d",big.mark=",")` used in place of maximum ABC for `r thisyr+1`.
  \end{tablenotes}
\end{table}
\normalsize

## Ricker stock recruitment curve, 95% CIs fit to FSB (years in black) and recruitment 1978-2013, Model 18.2.
```{r ricker2,echo=FALSE,message=FALSE}

 df <- data.frame(YFS2$SRR_SSB)
 df$Year <- YFS2$Year
 df$rhat <- YFS2$rechat
 df$rhat.sd <- YFS2$rechat.sd
 df$lb   <- df$rhat/exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 df$ub   <- df$rhat*exp(2*sqrt(log(1+df$rhat.sd^2/df$rhat^2)))
 colnames(df)=c("ssb","rhat","rhat.sd","lb","ub")
 df2=data.frame(YFS2$Yr[60:66],YFS2$SSB[60:66,2],(YFS2$natage_f[60:66,1]+YFS2$natage_m[60:66,1]))
  df3=data.frame(YFS2$Yr[25:60],YFS2$SSB[25:60,2],(YFS2$natage_f[25:60,1]+YFS2$natage_m[25:60,1]))
 colnames(df2)=c("Year","FSB","Recruitment")
  colnames(df3)=c("Year","FSB","Recruitment")
 ggplot(df) +geom_line(aes(x = ssb, y = rhat)) +
  geom_ribbon(aes(x = ssb, ymax = ub, ymin = lb), alpha=0.3)+labs(x = "Female spawning biomass (x 1,000 t)", y = "Recruits (age 1, millions)")+geom_text(data=df2,aes(x = FSB, y = Recruitment,label=Year),color="blue")+geom_text(data=df3,aes(x = FSB, y = Recruitment,label=Year))+theme_bw()
 
```



## Model 18.2 fit to the time-series of survey age composition, by sex, 1979-2018.

```{r srv_agecomp2, message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS2$yrs_srv_age_s,YFS2$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")

```






## Model 18.2 fit to the time-series of fishery age composition, by sex, 1975-2018.

```{r fsh_agecomp2,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.2", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.2", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS2$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p 

```


## NMFS EBS survey biomass estimates, Model 18.1a and 18.2 fit to survey biomass estimates, 1982-2019.

```{r srvbio_fit, message=FALSE, echo=FALSE}  
#fit to survey biomass
LCI=YFS1$ob_bts-1.96*YFS1$sd_ob_bts
HCI=YFS1$ob_bts+1.96*YFS1$sd_ob_bts
srv_bio1=data.frame(cbind(YFS1$yrs_srv,YFS1$ob_bts,YFS1$sd_ob_bts,LCI,HCI,YFS1$pred_srv[29:66]))
LCI=YFS2$ob_bts-1.96*YFS2$sd_ob_bts
HCI=YFS2$ob_bts+1.96*YFS2$sd_ob_bts
srv_bio2=data.frame(cbind(YFS2$yrs_srv,YFS2$ob_bts,YFS2$sd_ob_bts,LCI,HCI,YFS2$pred_srv[29:66]))
srv_bio3=rbind(srv_bio1,srv_bio2)
Model=c(rep("Model 18.1a",nrow(srv_bio1)),rep("Model 18.2",nrow(srv_bio1)))
srv_bio4=cbind(srv_bio3,Model)
colnames(srv_bio4)=c("Year","Biomass","sd","LCI","HCI","Predicted","Model")

ggplot(data=srv_bio4,aes(x=Year,y=Biomass))+geom_ribbon(aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI),alpha=0.2)+geom_line(aes(x=Year,y=Biomass))+geom_line(aes(x=Year,y=Predicted,col=Model))+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Biomass (x 1,000 t)")+scale_x_continuous(breaks = seq(1982,2018, by = 2))+ylim(0,4500)+
 theme(legend.position="right")+scale_color_discrete(name="")+theme_bw()+theme(axis.text.x=element_text(angle=270,hjust=1))

```



## MCMC posterior distributions for Model 18.2.
```{r mcmcplots, message=FALSE, echo=FALSE}
hdr <- read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/data/hdr.dat",as.is=T,header=F)
mctmp2.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/evalout_YFIN.rep",col_names=FALSE)
mctmp1.df <-read_table2("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2019/evalout_YFIN.rep",col_names=FALSE)
names(mctmp1.df) <- hdr
names(mctmp2.df) <- hdr
mcdat=rbind(mctmp1.df,mctmp2.df)
mcdat$Model=c(rep("Model 18.1a",nrow(mctmp1.df)),rep("Model 18.2",nrow(mctmp1.df)))

p1=ggplot(data=mcdat, aes(x=Fmsyr,fill=Model)) + geom_density(aes(x=Fmsyr),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Fmsy") + xlim(c(0,.3))+theme_bw()+ylab("Density")

p2=ggplot(data=mcdat, aes(x=1000*Bmsy,fill=Model)) + geom_density(aes(x=Bmsy),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Bmsy (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(100,1300))

p3=ggplot(data=mcdat, aes(x=ln_mean_R,fill=Model)) + geom_density(aes(x=ln_mean_R),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("log(mean(Recruitment))x10^9") +theme_bw()+ylab("Density")

p4=ggplot(data=mcdat, aes(x=ABC_biom6,fill=Model)) + geom_density(aes(x=ABC_biom6),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Age 6 Biomass (x1,000 t)") +theme_bw()+ylab("Density")+xlim(c(1000,7000))

p5=ggplot(data=mcdat, aes(x=SSB_2019,fill=Model)) + geom_density(aes(x=SSB_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("FSB (x1,000 t)") +theme_bw()+ylab("Density")+geom_vline(xintercept=(Bmsy_this/1000))+xlim(c(300,1400))

p6=ggplot(data=mcdat, aes(x=TotBiom_2019,fill=Model)) + geom_density(aes(x=TotBiom_2019),alpha=.4)+scale_y_continuous(breaks=NULL) + xlab("Total Biomass (x10^9 t)") +theme_bw()+ylab("Density")

grid.arrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```



## Model estimates of total (age 2+) and female spawning biomass with 95% confidence intervals, 1954-2019.

```{r bioFSBCI, message=FALSE, echo=FALSE} 
TotBiom=data.frame(YFS2$TotBiom,rep("Biomass",nrow(YFS2$TotBiom)))
colnames(TotBiom)=c("Year","Biomass","sd","LCI","HCI","Type")
SSB=data.frame(YFS2$SSB,rep("FSB",nrow(YFS2$SSB)))
colnames(SSB)=c("Year","Biomass","sd","LCI","HCI","Type")
TotBiom2=rbind(TotBiom,SSB)
colnames(TotBiom2)=c("Year","Biomass","sd","LCI","HCI","Type")

theme_set(theme_gray(base_size = 18))
ggplot(data=TotBiom2,aes(x=Year,y=Biomass,ymin=LCI,ymax=HCI))+
geom_ribbon(aes(fill=Type),alpha=0.3)+geom_line(aes(color=Type))+
ylab("Biomass (x 1,000 t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2019, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))+geom_hline(yintercept=Bmsy_this/1000)+geom_point(aes(x=2020,y=FSB_this/1000),color="blue")+geom_point(aes(x=2021,y=FSB_next/1000),color="blue")+geom_hline(yintercept=Bmsy_next/1000)

#+geom_point(aes(x=2020,y=TotBio_this/1000),color="red")+geom_point(aes(x=2021,y=TotBio_next/1000),color="red")
```


## Projected female spawning biomass for 2019 to 2032 (blue line), and fishing at the 2014-2018 average.
```{r fishingavgF}
#Figure 32 get this from SSB in 5 yr average catch in alt3.
pcatch=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentiles.out",nrows=14,skip=144)
colnames(pcatch)=c("Year","C0","Cabc","Cofl","LowCI_Catch ","Median_Catch","Mean_Catch","UpperCI_Catch","Stdev_Catch")

pSSB=read.table("/Users/ingridspies/admbmodels/projection/bsai_yfin2019_out/percentiles.out",nrows=14,skip=161)
colnames(pSSB)=c("Year","SSB100","SSBabc","SSBofl","LowCI_SSB","Median_SSB","Mean_SSB","UpperCI_SSB","Stdev_SSB")


plot(pSSB$Year,pSSB$Mean_SSB,type="l",ylim=c(0,1500),lwd=3,col="blue", xlab="Year",ylab="Female Spawning Biomass",cex.axis=1.4,cex.lab=1.4)
lines(pSSB$Year,pSSB$LowCI_SSB,lty=2,lwd=2)
lines(pSSB$Year,pSSB$UpperCI_SSB,lty=2,lwd=2)
abline(h=Bmsy_this/1000,col="red",lwd=2)
text(2020,(Bmsy_this/1000)+60,expression(B[MSY]),cex=1.4)


```



## Year class strength of age 5 Yellowfin Sole estimated by the stock assessment model, horizontal line = mean.
```{r recfig,echo=FALSE,message=FALSE}

recf=data.frame(YFS2$Yr,YFS2$natage_f[,5])
colnames(recf)=c("Year","Recruitment")
ggplot(data=recf)+geom_bar(aes(x=Year,y=Recruitment),alpha=0.4,stat="identity")+geom_hline(yintercept=mean(YFS2$natage_f[,5]))+theme_bw()+scale_x_continuous(breaks = seq(1955,2019, by = 2))+theme(axis.text.x=element_text(angle=45,hjust=1))
```



## Retrospective plot of female spawning biomass. Data was sequentially removed through 2009.

```{r retro1, echo=FALSE, message=FALSE}

YFS2019=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.rep")
YFS2018retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.rep")
YFS2017retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.rep")
YFS2016retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.rep")
YFS2015retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.rep")
YFS2014retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.rep")
YFS2013retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.rep")
YFS2012retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.rep")
YFS2011retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.rep")
YFS2010retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.rep")
YFS2009retro=read.rep("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.rep")


a=-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2]
b=-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2]
c=-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2]
d=-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2]
e=-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2]
f=-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2]
g=-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2]
h=-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2]
i=-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2]
j=-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2]

Rho=(a[length(a)]+b[length(b)]+c[length(c)]+d[length(d)]+e[length(e)]+
      f[length(f)]+g[length(g)]+h[length(h)]+i[length(i)]+j[length(j)])/10;

#c(a[length(a)],b[length(b)],c[length(c)],d[length(d)],e[length(e)],f[length(f)],g[length(g)],h[length(h)],i[length(i)],j[length(j)])

#retrospective

std2019=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_0.std")
std2018=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_1.std")
std2017=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_2.std")
std2016=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_3.std")
std2015=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_4.std")
std2014=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_5.std")
std2013=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_6.std")
std2012=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_7.std")
std2011=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_8.std")
std2010=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_9.std")
std2009=read.table("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/runs/m2/retro/r_10.std")


ret18=data.frame(cbind(c(1954:2018),YFS2018retro$SSB[,2],YFS2018retro$SSB[,2]+1.96*as.numeric(as.vector(std2018[['V4']][594:658])),YFS2018retro$SSB[,2]-1.96*as.numeric(as.vector(std2018[['V4']][594:658]))))

ret17=data.frame(cbind(c(1954:2017),YFS2017retro$SSB[,2],YFS2017retro$SSB[,2]+1.96*as.numeric(as.vector(std2017[['V4']][587:650])),YFS2017retro$SSB[,2]-1.96*as.numeric(as.vector(std2017[['V4']][587:650]))))

ret16=data.frame(cbind(c(1954:2016),YFS2016retro$SSB[,2],YFS2016retro$SSB[,2]+1.96*as.numeric(as.vector(std2016[['V4']][580:642])),YFS2016retro$SSB[,2]-1.96*as.numeric(as.vector(std2016[['V4']][580:642]))))

ret15=data.frame(cbind(c(1954:2015),YFS2015retro$SSB[,2],YFS2015retro$SSB[,2]+1.96*as.numeric(as.vector(std2015[['V4']][573:634])),YFS2015retro$SSB[,2]-1.96*as.numeric(as.vector(std2015[['V4']][573:634]))))

ret14=data.frame(cbind(c(1954:2014),YFS2014retro$SSB[,2],YFS2014retro$SSB[,2]+1.96*as.numeric(as.vector(std2014[['V4']][566:626])),YFS2014retro$SSB[,2]-1.96*as.numeric(as.vector(std2014[['V4']][566:626]))))

ret13=data.frame(cbind(c(1954:2013),YFS2013retro$SSB[,2],YFS2013retro$SSB[,2]+1.96*as.numeric(as.vector(std2013[['V4']][559:618])),YFS2013retro$SSB[,2]-1.96*as.numeric(as.vector(std2013[['V4']][559:618]))))

ret12=data.frame(cbind(c(1954:2012),YFS2012retro$SSB[,2],YFS2012retro$SSB[,2]+1.96*as.numeric(as.vector(std2012[['V4']][552:610])),YFS2012retro$SSB[,2]-1.96*as.numeric(as.vector(std2012[['V4']][552:610]))))

ret11=data.frame(cbind(c(1954:2011),YFS2011retro$SSB[,2],YFS2011retro$SSB[,2]+1.96*as.numeric(as.vector(std2011[['V4']][545:602])),YFS2011retro$SSB[,2]-1.96*as.numeric(as.vector(std2011[['V4']][545:602]))))

ret10=data.frame(cbind(c(1954:2010),YFS2010retro$SSB[,2],YFS2010retro$SSB[,2]+1.96*as.numeric(as.vector(std2010[['V4']][538:594])),YFS2010retro$SSB[,2]-1.96*as.numeric(as.vector(std2010[['V4']][538:594]))))

ret09=data.frame(cbind(c(1954:2009),YFS2009retro$SSB[,2],YFS2009retro$SSB[,2]+1.96*as.numeric(as.vector(std2009[['V4']][531:586])),YFS2009retro$SSB[,2]-1.96*as.numeric(as.vector(std2009[['V4']][531:586]))))


retro=as.data.frame(rbind(ret09,ret10,ret11,ret12,ret13,ret14,ret15,ret16,ret17,ret18))
colnames(retro)=c("Year","Female_Spawning_Biomass","UI","LI")

year=rev(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))
retro=cbind(retro,year)


theme_set(theme_gray(base_size = 18))
p=ggplot(data=retro,aes(x=Year,y=Female_Spawning_Biomass,ymin=LI,ymax=UI))+geom_ribbon(aes(fill=year),alpha=0.3)+geom_line(aes(color=year))+ylab("Female Spawning Biomass (t)")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))


print(p)

```


## Relative differences in estimates of FSB between the 2019 preferred and retrospective runs.

```{r retro2, echo=FALSE,message=FALSE}
#plot differences
Years=c(c(1954:2018),c(1954:2017),c(1954:2016),c(1954:2015),c(1954:2014),c(1954:2013),c(1954:2012),c(1954:2011),c(1954:2010),c(1954:2009))


Difference=c(-1*(YFS2019$SSB[1:65,2]-YFS2018retro$SSB[,2])/YFS2019$SSB[1:65,2],
-1*(YFS2019$SSB[1:64,2]-YFS2017retro$SSB[,2])/YFS2019$SSB[1:64,2],
-1*(YFS2019$SSB[1:63,2]-YFS2016retro$SSB[,2])/YFS2019$SSB[1:63,2],
-1*(YFS2019$SSB[1:62,2]-YFS2015retro$SSB[,2])/YFS2019$SSB[1:62,2],
-1*(YFS2019$SSB[1:61,2]-YFS2014retro$SSB[,2])/YFS2019$SSB[1:61,2],
-1*(YFS2019$SSB[1:60,2]-YFS2013retro$SSB[,2])/YFS2019$SSB[1:60,2],
-1*(YFS2019$SSB[1:59,2]-YFS2012retro$SSB[,2])/YFS2019$SSB[1:59,2],
-1*(YFS2019$SSB[1:58,2]-YFS2011retro$SSB[,2])/YFS2019$SSB[1:58,2],
-1*(YFS2019$SSB[1:57,2]-YFS2010retro$SSB[,2])/YFS2019$SSB[1:57,2],
-1*(YFS2019$SSB[1:56,2]-YFS2009retro$SSB[,2])/YFS2019$SSB[1:56,2])



Year=(c(rep("2018",length(c(1954:2018))),rep("2017",length(c(1954:2017))),rep("2016",length(c(1954:2016))),rep("2015",length(c(1954:2015))),rep("2014",length(c(1954:2014))),rep("2013",length(c(1954:2013))),rep("2012",length(c(1954:2012))),rep("2011",length(c(1954:2011))),rep("2010",length(c(1954:2010))),rep("2009",length(c(1954:2009)))))

#dat=data.frame(cbind(Years,Difference,Year))
dat=data.frame(Years,Difference,Year)

ggplot(data=dat,aes(x=Years,y=Difference,type=Year))+geom_line(aes(x=Years,y=Difference, color=Year))+ylab("Difference")+xlab("Year")+theme_bw()+theme(legend.text=element_text(size=11),axis.text=element_text(size=9),axis.title.x = element_text(size=14),axis.title.y = element_text(size=14))+scale_x_continuous(breaks = seq(1954,2018, by = 2))+theme(axis.text.x=element_text(angle=90,hjust=-1))
```

## Retrospective results

* Retrospective pattern for Model 18.2 similar to previous years.

* Earlier retrospective years indicated a lower level of spawning biomass than the current year's data 

* Mohn's rho = -0.219.

## Fishing mortality rate and female spawning biomass from 1975 to 2019 compared to harvest control rule.  
```{r phaseplane}
#phase plane plot
par(mar=c(5,5,3,2))
par(mfrow=c(1,1))
F40=extra_sd2$HM_Fmsyr[1]
B40=extra_sd2$Bmsy[1]
FOFL=extra_sd2$AM_Fmsyr[1]
plot(0,0,xlim=c(0,max(YFS2$SSB[,2])*1.1),ylim=c(0,FOFL*1.6),col=1,xlab="Estimated female spawning biomass (x 1,000 t)",ylab="Estimated fishing mortality rate",cex.axis=1.2,cex.lab=1.1,pch=-1,cex=.00001)
segments(0,0,B40,F40,col="green",lwd=4)
segments(B40,F40,max(YFS2$SSB[,2])*1.1,F40,col="green",lwd=4)
abline(h=FOFL,lty=1)
abline(v=B40,lty=2)
legend("topright",c(expression("F" ["OFL"]),expression("B" ["MSY"]),expression("F" ["MSY"])),lwd=c(1,1,4),lty=c(1,2,1), col=c("black","black","green"),cex=1.1,bty="n")

#note: female and male fishing mortality rate is the same
points(YFS2$SSB[21:66,2],YFS2$F_f[21:66,19],type="l",col="red",lwd=4)

points(YFS2$SSB[66,2],YFS2$F_f[66,19],pch=15,col="red")
text(YFS2$SSB[66,2]-60,YFS2$F_f[66,19]+.003,"2019",cex=0.9)

#for(i in 1: 59){
#text(ATF2019$fspbio[i]  ,ATF2019$fishmort[i],labels=as.character(seq(1961,2019,1))[i],cex=0.9)}

points(extra_sd2$SSB[1],extra_sd2$Catch_Assump[1]/extra_sd2$GM_Biom[1],pch=15,col="blue")
text(extra_sd2$SSB[1],(extra_sd2$Catch_Assump[1]/extra_sd2$GM_Biom[1])+.005,"2020",cex=0.9)

points(extra_sd2$SSB[2],extra_sd2$Catch_Assump[2]/extra_sd2$GM_Biom[2],pch=15,col="black")
text(extra_sd2$SSB[2]-30,(extra_sd2$Catch_Assump[2]/extra_sd2$GM_Biom[2])+.005,"2021",cex=0.9)


```

## Risk Assessment

Assessment related considerations

* Long time series - surveys 1982-2019 (no skipped years). 
* Fish ages have been validated.  
* Good fit to compositional and abundance data.  
* Recruitment tracks strong year classes consistent with data.

## Risk Assessment

Assessment related considerations (Level 1: Normal)

* Retrospective pattern has been subject of some concern.
* Large variability in survey biomass assessments for this stock due to temperature-influenced availability to the survey.  
* Can contribute to undesirable patterns - earlier years not fitting the same highly variable information as the current year.
* Varying M and q to minimize retrospective bias may not be the best tool for model selection for BSAI Yellowfin Sole.
* Tension between model fit and good retrospective pattern.

## Risk Assessment 

Population dynamics considerations (Level 1: Normal)

* Population in slow decline since the strong 1981 and 1983 year-classes have passed through the population.

* The present biomass is well above $B_{MSY}$.  
* Projections indicate that the FSB will remain well-above the $B_{MSY}$ level through 2032.  
* Population dynamics are not a concern for this assessment.

## Risk Assessment

Environmental/ecosystem considerations (Level 1: Normal)

\small

*	YFS condition (length-weight residuals) was positive in all strata and continued an upward trend since 2017;
*	The mean size of the groundfish community increased in 2019 buoyed by species including YFS, which had above average mean length;
*	YFS abundance and biomass remained below the long-term mean over the southern shelf;
*	YFS abundance and biomass increased between 2017 and 2019 over the northern shelf;
*	Indirect measurements of prey availability suggest sufficient prey availability for YFS over the southern Bering Sea shelf;
*	Increase of predators over the eastern Bering Sea shelf indicates increased risk of predation, although size, spatial, and/or temporal mismatches may exist and provide refuge for YFS;
*	2019 gray whale Unusual Mortality Event reflects poor feeding conditions in the northern Bering Sea during 2018.

\normalsize

## Risk Assessment

Fishery performance considerations (Level 1: Normal)

* Recent surveys of the northern Bering sea have not indicated a large shift in the spatial distribution of the eastern Bering Sea stock of Yellowfin Sole.
* Landings of benthic foragers (including YFS) remained relatively stable through 2018.
*	Landings of benthic forager flatfish may be larger than salmon, but salmon ex-vessel value is higher because it commands a higher price.
*	Revenues from benthic forager flatfish (including YFS) decreased from 2012-2015 as a result of decreased prices; since 2015 price increases have increased value while landings have remained stable.

## Risk Assessment Table

\tiny
\begin{table}[ht]
\centering
\begin{tabular}{ p{2cm}p{2cm}p{2cm}p{1.8cm}p{2cm} }
\hline
 Assessment \newline consideration & Population \newline dynamics & Environmental \newline ecosystem & Fishery \newline performance & Overall \\
\hline
 Level 1: Only minor, low level of concern & Level 1: Stock trends are typical for the stock and expected given stock dynamics; recent recruitment is within the normal range. & Level 1: Stock trends are typical for the stock and expected given stock dynamics; recent recruitment is within the normal range. & Level 1: No apparent environmental/ecosystem concerns & Level 1: Normal. \\ 
\hline
\end{tabular}
\end{table}
\normalsize



## Summary Table

\tiny
\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{As estimated or $\mathit{specified}$ } & \multicolumn{2}{c}{As estimated or $\mathit{recommended}$ }  \\
       & \multicolumn{2}{c|}{$\mathit{last}$ year for:}  & \multicolumn{2}{c}{$\mathit{this}$ year for: }               \\
        Quantity & `r thisyr`      &`r thisyr+1`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
	$M$ (natural mortality rate)	&	0.12	&	0.12	&	0.12, 0.135	&	0.12, 0.135 \\
Tier	&	1a	&	1a	&	1a	&	1a \\
Projected total (age 6+) biomass	& 2,388,000 t & 2,331,500 t &	`r TotBio_thisF` t	   &	`r TotBio_nextF` t  \\
Projected female spawning biomass &	827,900 t	&	796,600 t	&		`r FSB_thisF` t	         &	`r FSB_nextF` t	 \\
$\:\:\:\:\:\:B_{100\%}$                                 &	1,236,000 t	&	1,236,000 t	&		`r B0_2` t	       &	`r B0_2` t    \\
$\:\:\:\:\:\:B_{MSY\%}$                             &	451,600 t 	&	 451,600 t	&		`r Bmsy_thisF` t	     &	`r Bmsy_nextF   ` t		  \\
$F_{OFL}$                             &	0.118	      &	0.118	      &		`r FOFL_this`	   &	`r FOFL_next`	\\
$maxF_{ABC}$                          & 0.107	      &	0.107	      &	  `r FABC_this`	     &	`r FABC_next`  	\\
$F_{ABC}$                             &	0.107       &	0.107       &		`r FABC_next`           &	`r FABC_next`        \\
$OFL$    	                            &	281,800 t	&	275,100 t	&	  `r OFL_thisF` t          &	`r OFL_nextF` t       \\
$maxABC$    	                        &	255,100 t	&	249,100 t	&		`r ABC_thisF ` t      &	`r ABC_nextF ` t   \\
$ABC$ 	                             &	255,100 t	&	249,100 t	&		`r ABC_thisF ` t         &	`r ABC_nextF` t       \\
\hline
Status	                              &	`r thisyr-2`	      &	 `r thisyr-1`	      &		`r thisyr-1`             &	`r thisyr`          \\
\hline
Overfishing	                          &	No	        &	n/a	      &	No	                       &	n/a                 \\
Overfished	                          &	n/a	        &	No	      &	n/a	                       &	No                  \\
Approaching overfished	              &	n/a	        &	No	      &	n/a	                       &	No                  \\
\hline
\end{tabular}
\begin{tablenotes}
\item Projections were based on estimated catches of 118,642 t in `r thisyr` and `r formatC(cn10,format="d",big.mark=",")` used in place of maximum ABC for `r thisyr+1`.
\end{tablenotes}
\end{table}

## Questions?

\begin{center}
\includegraphics[height=6in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/sole-yellowfin.pdf}
\end{center}

## Yellowfin Sole annual cumulative catch by month and year (non CDQ) 2003-2019.
```{r fig_1b, message=FALSE, echo=FALSE,fig.width = 6.25, fig.height = 4}
#Figure 1 lower panel
#blend_catchYFS=read.csv("/Users/ingridspies/YFS_Blend_CAS.csv",header=TRUE)
#yrs=c(2003:2018)
#cat_month=matrix(0,length(yrs),12)
#cat_month2=matrix(0,length(yrs),12)
#for (i in 1:length(yrs)){
#cat_month[i,]=table(blend_catchYFS2$Month[which(blend_catchYFS2$Year==yrs[i])])
#}
#colnames(cat_month)=c(1:12)
#rownames(cat_month)=yrs
#cat_month1=cat_month/rowSums(cat_month)
#for(i in 1:length(yrs)){
#cat_month2[i,]=cumsum(cat_month1[i,])
#}
#Cat=c(cat_month2)
#Year=rep(yrs,12)
#Month=rep(seq(1,12,1),each=length(yrs))
#catch_month=data.frame(Cat,Year,Month)
#write.csv(catch_month,here("/doc/Rmd/catch_month.csv"))

catch_month=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/catch_month.csv")
ggplot(data=catch_month, aes(x=Month,y=Cat,group=factor(Year)))+geom_line(aes(colour=Year),size=1.2)+scale_x_continuous(breaks = seq(1,12, by = 1))+theme(legend.position="right")+labs(y = "Relative cumulative catch")+scale_colour_gradient(low="lightblue",high="darkblue")+theme_few(base_size=14)

```

## Average Yellowfin Sole weight-at-age (g) from trawl survey observations.

```{r wtage, message=FALSE, echo=FALSE}  
wts2=data.frame(cbind(seq(1,20,1)),colMeans(YFS2$wt_srv_f),colMeans(YFS2$wt_srv_m))
colnames(wts2)=c("Age","Females","Males")
ggplot(data=wts2)+geom_line(aes(x=Age,y=Females,colour="Females"))+geom_line(aes(x=Age,y=Males,colour="Males"))+theme_bw()+theme(legend.title=element_text(size=13),legend.text=element_text(size=11),axis.text=element_text(size=11),axis.title.x = element_text(size=13),axis.title.y = element_text(size=14))+
 ylab("Weight (g)")+
 theme(legend.position="right")+scale_color_discrete(name="Sex")

```


## Catch of Yellowfin Sole in the BSAI, 1991-2019. Circles represent relative catch in ADFG Statistical Areas.
```{r cpuefig,message=FALSE,echo=FALSE}

#yfs=data.frame(read.csv("/Users/ingridspies/YFS_Blend_CAS.csv",header=TRUE,as.is=TRUE))

#library("ggmap")
#register_google(key="AIzaSyCQu3tASptLB1EFx3E8BXPc2cMDNFL5FCw")
#testmap <- get_googlemap(c(lon=-178,lat=57) ,color="bw", maptype='satellite' ,zoom=4.0) #, xlim=c(-190,-130), ylim=c(51,63)) # set up mapframe

#Areas=names(table(yfs$ADFG_STAT_AREA_CODE))
#Yrs=names(table(yfs$Year))

#catch=matrix(0,length(Areas),length(Yrs))
#for(i in 1:length(Areas)){
#  for(j in 1:length(Yrs)){
#    catch[i,j]=sum(yfs$WEIGHT_POSTED[which(yfs$ADFG_STAT_AREA_CODE==Areas[i]&yfs$Year==Yrs[j])],na.rm=TRUE)
#  }
#}
#write.csv(catch,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/catch.csv")

#yrvec=rep(Yrs,each=length(Areas))
#areavec=rep(Areas,length(Yrs))
#catchYFS=data.frame(cbind(yrvec,areavec,as.vector(t(catch))))
#colnames(catchYFS)=c("Year","ADFG_STAT_AREA_CODE","Catch")
#Longitude=getLongAdfg(catchYFS$ADFG_STAT_AREA_CODE)
#Latitude=getLatAdfg(catchYFS$ADFG_STAT_AREA_CODE)
#catchYFS1=data.frame(cbind(catchYFS,Longitude,Latitude))

#write.csv(catchYFS1,"/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/CatchYFS1.csv")
#catchYFS=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/CatchYFS1.csv",header=TRUE)

#yfs_2011_2019=data.frame(catchYFS[which(catchYFS$Year>2010&catchYFS$Catch>0),])

#ggmap(testmap) + geom_point(aes(x= Longitude, y=Latitude, size=Catch), alpha=0.5, data=yfs_2011_2019,,colour="red") + facet_wrap((~Year))+ xlab("Longitude") +ylab("Latitude")+theme_bw(base_size=14) +scale_x_continuous(limits = c(-190.5, -155.0), expand = c(0, 0)) + scale_y_continuous(limits = c(50.50, 67.0), expand = c(0, 0)) 

#yfs_2002_2010=data.frame(catchYFS[which(catchYFS$Year>2001&catchYFS$Year<2011&catchYFS$Catch>0),])

#ggmap(testmap) + geom_point(aes(x= Longitude, y=Latitude, size=Catch), alpha=0.5, data=yfs_2002_2010,colour="red") + facet_wrap((~Year))+ xlab("Longitude") +ylab("Latitude")+theme_bw(base_size=14) +scale_x_continuous(limits = c(-190.5, -155.0), expand = c(0, 0)) + scale_y_continuous(limits = c(50.50, 67.0), expand = c(0, 0)) 

#yfs_1992_2001=data.frame(catchYFS[which(catchYFS$Year>1991&catchYFS$Year<2001&catchYFS$Catch>0),])

#ggmap(testmap) + geom_point(aes(x= Longitude, y=Latitude, size=Catch), alpha=0.5, data=yfs_1992_2001,colour="red") +facet_wrap((~Year))+ xlab("Longitude") +ylab("Latitude")+theme_bw(base_size=14) +scale_x_continuous(limits = c(-190.5, -155.0), expand = c(0, 0)) + scale_y_continuous(limits = c(50.50, 67.0), expand = c(0, 0)) 

#all years
#catchYFS1=catchYFS[which(catchYFS$Catch>0),]
#ggmap(testmap) + geom_point(aes(x= Longitude, y=Latitude, size=Catch), alpha=0.5, data=catchYFS1,colour="red") + facet_wrap((~Year))+ xlab("Longitude") +ylab("Latitude")+theme_bw(base_size=11) +scale_x_continuous(limits = c(-190.5, -155.0), expand = c(0, 0)) + scale_y_continuous(limits = c(50.50, 67.0), expand = c(0, 0))+theme(axis.text.x=element_text(angle=45,hjust=1)) 

#ggsave("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/CPUE_YFS_allyrs1.png")
 
```
\begin{center}
\includegraphics[width=7in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/CPUE_YFS_allyrs.png}
\end{center}

## Model 18.1a fit to the time-series of survey age composition, by sex, 1979-2018.

```{r srv_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
#Survey
nages=20
dff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$oac_srv_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,1:nages]) )
pfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_srv_age_s,YFS1$eac_srv_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p +labs(x = "Age (yrs)", y = "Proportion")
```


## Model 18.1a fit to the time-series of fishery age composition, by sex, 1975-2018.

```{r fsh_agecomp1,message=FALSE,echo=FALSE,fig.height=7.5}
nages=20
dff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,1:nages]) )
dfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$oac_fsh_s[,(nages+1):(2*nages)]))
pff <- data.frame(Model="Model 18.1a", sex="Females",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,1:nages]) ) 
pfm <- data.frame(Model="Model 18.1a", sex="Males",cbind(YFS1$yrs_fsh_age_s,YFS1$eac_fsh_s[,(nages+1):(2*nages)]))
colnames(dff) <- colnames(dfm) <- colnames(pff) <- colnames(pfm) <- c("Model", "Sex", "Year",as.character(1:nages) )
df <- rbind(dff,dfm)
pf <- rbind(pff,pfm)
mdf <- mpf <- mrf <- NULL
mdf <- rbind(mdf,df)
mpf <- rbind(mpf,pf)

mdf <- reshape2::melt(mdf,id.var=1:3)
mpf <- reshape2::melt(mpf,id.var=1:3)
mdf <-cbind(mdf,pred=mpf$value)

ix <- pretty(1:nages)
tdf <- mdf %>% mutate(pred=if_else(Sex=="Males",-pred,pred),value=if_else(Sex=="Males",-value,value))
p <- ggplot(tdf,aes(variable,value,fill=Sex)) +
  geom_bar(stat="identity",alpha=0.5)
p <- p + geom_line(aes(as.numeric(variable),pred,col=Sex),alpha=0.85)
p <- p + scale_x_discrete(breaks=ix) 
p <- p + labs(x = "Age (yrs)", y = "Proportion")
p <- p + facet_wrap(~Year)+theme_bw()+theme(axis.text.y = element_text(size = 7))
p 

```


## Fishery locations by month, 2019.
```{r fishmo,message=FALSE,echo=FALSE}
#fishmo=read.csv("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/2019fisherylocations.csv",header=TRUE)



#colnames(fishmo)=c("Year","month","day","Weight","VT","vt2","vt3","Latitude","Longitude","Month")
#fishmo1=fishmo[which(fishmo$Weight>0&fishmo$month<10),]
#fishmo$Month = factor(fishmo$Month, levels=month.name)
#ggmap(testmap) + geom_point(aes(x= Longitude, y=Latitude, zeze=Weight), alpha=0.5, data=fishmo1,colour="red") + facet_wrap((~month))+ xlab("Longitude") +ylab("Latitude")+theme_bw(base_size=11) +scale_x_continuous(limits = c(-190.5, -155.0), expand = c(0, 0)) +scale_y_continuous(limits = c(50.50, 67.0), expand = c(0, 0))+theme(axis.text.x=element_text(angle=45,hjust=1)) 
#ggsave("/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/data/CPUE_2019bymo2.png")

```
\begin{center}
\includegraphics[width=7.5in,angle=0,origin=c]{/Users/ingridspies/admbmodels/flatfish/assessments/yfs/doc/2019/data/CPUE_2019bymo2.png}
\end{center}
